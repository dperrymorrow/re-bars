const e={warn:"background: #484915; color: #ffffbe; padding: .1em; font-weight: normal;",log:"background: #324645; color:#c9faff; padding: .1em; font-weight: normal;"},t=(e,{loc:t,data:n})=>{const o=e.split("\n").slice(t.start.line-1,t.end.line),r=Array(o[0].length-o[0].trim().length).join(" ");return o[0]=o[0].substr(t.start.column),o[o.length-1]=o[o.length-1].substr(0,t.end.column),["",`component: ${n.root.$name}, template line: ${t.start.line}`,"============================================"].concat(o.map(e=>e.replace(r,""))).join("\n")},n=(t,n,r={},...a)=>{let s=o[n](r);if(!["warn","log"].includes(t))throw a.forEach(e=>console.error(e)),new Error(s);s="%c "+s+" ",a?(console.groupCollapsed(s,e[t]),a.forEach(e=>console.log(e)),console.groupEnd()):console.log(s,e[t])},o={noEl:()=>"$el must be present in the document",noHbs:()=>"ReBars need Handlebars in order to run!",noName:()=>"Each ReBars component should have a name",dataFn:({name:e})=>`component:${e} must be a function`,tplStr:({name:e})=>`component:${e} needs a template string`,propStomp:({name:e,key:t})=>`component:${e} "data.${t}" was overrode by a prop`,propUndef:({name:e,key:t})=>`component:${e} was passed undefined for prop "${t}"`,oneRoot:({name:e})=>`component:${e} must have one root node, and cannot be a {{#watch}} block. \nThis error can also be caused by malformed html.`,noMethod:({name:e,methodName:t})=>`component:${e} does not have a method named "${t}"`,badPath:({path:e})=>`${e} was not found in object`,reRender:({name:e,path:t})=>`component:${e} re-rendering "${t}"`,patching:({name:e,path:t})=>`component:${e} patching ref Array "${t}"`,pathTrigger:({path:e,action:t,name:n})=>`component:${n} ${t} "${e}"`,triggered:({name:e,paths:t})=>`component:${e} data change "${t}"`,paramUndef:({data:e,template:n,loc:o})=>`component:${e.root.$name} passed undefined to a helper\n      ${t(n,{data:e,loc:o})}\n    `,badWatchParam:({data:e,template:n,loc:o,path:r})=>`component:${e.root.$name} could not find "${r}" to watch. If primitve wrap in quotes\n      ${t(n,{data:e,loc:o})}\n    `,noComp:({data:e,loc:n,template:o,cName:r})=>`component:${e.root.$name} child component "${r}" is not registered\n      ${t(o,{data:e,loc:n})}\n    `,restrictedKey:({name:e,key:t})=>`component:${e} cannot use restricted key "${t}" in your data as it's a helper`,focusFail:({ref:e,name:t})=>`component:${t} ref "${e}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each`,notKeyed:({name:e,path:t})=>`component:${e} patching "${t}" add a {{ ref }} to avoid re-rendering the entire target`};var r={messages:o,getStr:(e,t)=>o[e](t),warn:n.bind(null,"warn"),fail:n.bind(null,"throw"),log:n.bind(null,"log")};let a=1;var s={dom:{tagComponent(e,t,n){const o=this.getShadow(t),a=o.firstElementChild;(!a||!o.children||o.children.length>1||a.dataset.rbsWatch)&&r.fail("oneRoot",{name:n},o),a.dataset.rbsComp=e;const s=o.innerHTML;return o.remove(),s},restoreCursor(e,t){const n=this.findRef(e,t.ref);n&&(Array.isArray(n)?r.warn("focusFail",{ref:t.ref,name:name},n):(n.focus(),t.pos&&n.setSelectionRange(t.pos+1,t.pos+1)))},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.querySelector(`[data-rbs-ref="${t}"]`),findRefs(e){const t="object"==typeof e?e:this.findComponent(e);return Array.from(t.querySelectorAll("[data-rbs-ref]")).reduce((e,t)=>{const n=t.dataset.rbsRef,o=e[t.dataset.rbsRef];return e[n]=o?[o].concat(t):t,e},{})},findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,t,n)=>{const{tag:o,...r}={tag:"span",class:"rbs-watch",...n};return`<${o} ${Object.entries(r).map(([e,t])=>`${e}="${t}"`).join(" ")} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${o}>`},isKeyedNode:e=>e.children.length&&Array.from(e.children).every(e=>e.dataset.rbsRef),normalizeHtml:e=>e.replace(new RegExp(/="rbs(.*?)"/g),""),isEqHtml(e,t){const n="string"==typeof e?this.getShadow(e):this.getShadow(e.innerHTML),o="string"==typeof t?this.getShadow(t):this.getShadow(t.innerHTML);return n.innerHTML=this.normalizeHtml(n.innerHTML),o.innerHTML=this.normalizeHtml(o.innerHTML),n.isEqualNode(o)},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},deleteOrphans(e,t){const n=this.getStorage(e,t),o=this.getStorage(e);Object.keys(o.inst).forEach(e=>{if(!this.dom.findComponent(e)){const t=o.inst[e];t.scope.$hooks.detached&&t.scope.$hooks.detached(),delete o.inst[e]}}),Object.keys(n.renders).forEach(e=>{this.dom.findWatcher(e)||delete n.renders[e]})},debounce(e,t,n=!1){let o=null;return function(){const r=n&&!o,a=()=>e.apply(this,arguments);clearTimeout(o),o=setTimeout(a,t),r&&a()}},makeParams:e=>e.map(e=>{if(["[event]"].includes(e))return e.replace("[","").replace("]","");if(null!==e&&"object"==typeof e)throw new Error(`component:${name} must only pass primitives as argument to a handler. \n${JSON.stringify(e,null,2)}`);return"string"==typeof e?`'${e}'`:null===e?`${e}`:e}),getStorage(e,t){return t?this.findByPath(window.ReBars,`apps.${e}.inst.${t}`):this.findByPath(window.ReBars,`apps.${e}`)},findByPath:(e,t)=>{try{return t.includes(".")?t.split(".").reduce((e,t)=>e[t],e):e[t]}catch(n){r.fail("badPath",{path:t},e)}},shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${a++}`,setKey(e,t,n){const o=t.split(".");o.reduce((a,s,c)=>(s in a||r.fail("badPath",{path:t},e),c+1===o.length&&(a[s]=n),a[s]),e)}},c={create(e){const t=function e(n,o=[]){return new Proxy(n,{get:function(n,r){if("ReBarsPath"===r)return o.join(".");const a=Reflect.get(...arguments);return"function"==typeof a&&n.hasOwnProperty(r)?a.bind(t):null!==a&&"object"==typeof a&&"methods"!==r?e(a,o.concat(r)):a},set:function(e,t){const n=Reflect.set(...arguments);o.concat(t).join(".");return n},deleteProperty:function(e,t){const n=Reflect.deleteProperty(...arguments);o.concat(t).join(".");return n}})}(e);return t}},i={register({instance:e,helpers:t,components:n,template:o}){Object.entries(t).forEach(([t,n])=>e.registerHelper(t,n)),e.registerHelper("component",(function(...t){const{hash:a,data:s,loc:c}=t.pop(),i=t[0];return n[i]||r.fail("noComp",{data:s,loc:c,template:o,cName:i}),new e.SafeString(n[i].instance(a).render())})),e.registerHelper("isComponent",(function(e){return Object.keys(n).includes(e)})),e.registerHelper("ref",t=>new e.SafeString(`data-rbs-ref="${t}"`)),e.registerHelper("debug",(t,{data:n,loc:a})=>{void 0===t&&r.fail("paramUndef",{template:o,data:n,loc:a});return new e.SafeString(`<pre class="debug">${JSON.stringify(t,(e,t)=>"function"==typeof t?t+"":t,2)}</pre>`)})}},d={register(e){e.registerHelper("method",(function(){const[t,...n]=arguments,[o,r="click"]=t.split(":"),{data:a}=n.pop(),{$_componentId:s}=a.root;let c=[o,r,s];return n&&n.length&&(c=c.concat(n)),new e.SafeString(`data-rbs-method='${JSON.stringify(c)}'`)})),e.registerHelper("bound",(e,{hash:t={},data:n})=>"bound")}},l={register(e,t,n){t.registerHelper("watch",(function(...t){const{fn:o,hash:a,data:c,loc:i}=t.pop(),d=c.root.$_componentId,l=s.randomId(),p=t.map(e=>((e,t=!0)=>(void 0===e&&r.fail("paramUndef",{template:n,loc:i,data:c}),"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e))(e,!1)).join(".").split(",");return e.components.instances[d].renders[l]={path:p,render:()=>o(this)},s.dom.wrapWatcher(l,o(this),a)}))}};const p=["component","ref","debug","isComponent","method","bound","watch","isComponent"];var m={register:function e({id:t,Handlebars:n,trace:o,helpers:a,components:m},{name:h,template:f,data:u,helpers:g={},hooks:$={},methods:b={},watchers:y={},components:w=[]}){u=u||function(){return{}},h||r.fail("noName",null,arguments[1]),"function"!=typeof u&&r.fail("dataFn",{name:h}),"string"!=typeof f&&r.fail("tmplStr",{name:h});const S=arguments[0],H=n.create(),E=H.compile(f),v=w.reduce((t,n)=>{const o=e(S,n);return t[n.name]=o,t},{...m.registered});return Object.keys(u()).forEach(e=>{p.concat(Object.keys(g)).includes(e)&&r.fail("restrictedKey",{name:h,key:e})}),i.register({instance:H,helpers:{...g,...a},components:v,template:f}),d.register(H,b),l.register(S,H,f),{instance(e={}){const n=s.randomId(),o=u();Object.entries(e).forEach(([e,t])=>{void 0===t&&r.warn("propUndef",{name:h,key:e})});const a=c.create({...o,$props:e,$methods:b,$name:h,$_appId:t,$_componentId:n,$el:()=>s.dom.findComponet(n),$refs:()=>s.dom.findRefs(n)});$.created&&$.created.call(a);const i={id:n,scope:a,hooks:$,renders:{},init:function(){s.dom.findComponent(n),$.attached&&$.attached.call(a)},render:()=>s.dom.tagComponent(n,E(a),h)};return S.components.instances[n]=i,i}}}},h={app({$el:e,root:t,Handlebars:n=window.Handlebars,helpers:o={},components:a={},trace:c=!1}){n||r.fail("noHbs"),document.body.contains(e)||r.fail("noEl");const i={id:s.randomId(),Handlebars:n,trace:c,helpers:o,$el:e,components:{registered:{},instances:{}}};new MutationObserver(e=>{e.forEach(({addedNodes:e,removedNodes:t})=>{e.forEach(e=>{"querySelectorAll"in e&&(e.querySelectorAll("[data-rbs-comp]").forEach(e=>{i.components.instances[e.dataset.rbsComp].init()}),e.querySelectorAll("[data-rbs-method]").forEach(e=>{const[t,n,o,...r]=JSON.parse(e.dataset.rbsMethod),a=i.components.instances[o].scope;e.addEventListener(n,e=>{a.$methods[t].call(a,e,...r)})}))})})}).observe(e,{childList:!0,attributes:!0,subtree:!0});const d=m.register(i,t).instance();return e.innerHTML=d.render(),d.init(),i}};export default h;
//# sourceMappingURL=re-bars.esm.min.js.map
