let e=!1;var t={logLevel:()=>e?1:0,setTrace:t=>e=t,regex:{attrs:/rbs-(.*?)="(.*?)"/g,whitespace:/\s/g},attrs:{key:"rbs-key",watch:"rbs-watch",method:"rbs-method",ref:"rbs-ref"}};const{attrs:r}=t;var n={recordState(e){const t=document.activeElement,n=t.getAttribute(r.ref);return e.contains(t)&&n?{ref:n,style:t.getAttribute("style"),scrollTop:t.scrollTop,scrollLeft:t.scrollLeft,selectionStart:t.selectionStart}:null},restoreState(e,t){if(!t)return;const r=this.findRef(e,t.ref);if(r){if(r.focus(),t.selectionStart){const e="TEXTAREA"===r.tagName?t.selectionStart:t.selectionStart+1;r.setSelectionRange(e,e)}r.scrollTop=t.scrollTop,r.scrollLeft=t.scrollLeft,t.style&&r.setAttribute("style",t.style)}},findRefs(e){const{ref:t}=r;return Array.from(e.querySelectorAll(`[${t}]`)).reduce((e,r)=>{const n=r.getAttribute(t),o=e[n];return e[n]=o?[o].concat(r):r,e},{})},findAttr(e,t,r=null){const n=r||document;return n.getAttribute(e)===t?n:n.querySelector(`[${e}="${t}"]`)},findRef:(e,t)=>e.getAttribute(r.ref)===t?e:e.querySelector(`[${r.ref}="${t}"]`),findMethod:e=>document.querySelector(`[${r.method}="${e}"]`),findWatcher:e=>document.querySelector(`[${r.watch}="${e}"]`),isTextNode:e=>e.nodeType===Node.TEXT_NODE,propStr:e=>Object.entries(e).map(([e,t])=>"number"==typeof t?`${e}=${t}`:`${e}="${t}"`).join(" "),wrapWatcher(e,t,n){const{tag:o,...a}={tag:"span",...n};return`<${o} ${this.propStr(a)} ${t.length?"":"style='display:none;'"} ${r.watch}="${e}">${t}</${o}>`},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}};const{fetch:o}=window;let a=1;var s={dom:n,debounce(e,t=0,r=!1){let n=null;return function(){const o=r&&!n,a=()=>e.apply(this,arguments);clearTimeout(n),n=setTimeout(a,t),o&&a()}},loadTemplate:e=>o(e).then(e=>e.text()).catch(e=>{throw new Error(e)}),nextTick:()=>new Promise(e=>{setTimeout(e,0)}),setPath(e,t,r){const n=t.split("."),o=n.pop();return n.reduce((e,t)=>e[t],e)[o]=r,e},buildContext(e,{$app:t,data:r,methods:n}){const o={$app:t,$nextTick:this.nextTick,$refs:this.dom.findRefs.bind(null,t),rootData:r};return o.methods=this.bind(n,e,o),o},registerHelpers({instance:e,helpers:t,scope:r}){const n=this;Object.entries(t).forEach(([t,o])=>e.registerHelper(t,(function(...e){const t=n.buildContext(this,r);return o.call(this,t,...e)})))},bind:(e,t,...r)=>Object.keys(e).reduce((n,o)=>(n[o]=e[o].bind(t,...r),n),{}),shouldRender:(e,t)=>e.some(e=>t.some(t=>e.match(t))),randomId:()=>a++},c={create(e,t,r=!1){let n=[];const o=s.debounce(()=>{t(n),n=[]}),a=e=>{n.includes(e)||n.push(e),o(n)};const c=function t(n,o=[]){return new Proxy(n,{get:function(n,i){const d=Reflect.get(...arguments);return"function"==typeof d&&n.hasOwnProperty(i)?d.bind(c,s.buildContext(n,e)):d&&"object"==typeof d&&["Array","Object"].includes(d.constructor.name)?t(d,o.concat(i)):(r&&a(o.concat(i).join(".")),d)},set:function(e,t,r){const n=Reflect.set(...arguments),s=o.concat(t).join(".");return a(s),n},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),n=o.concat(t).join(".");return a(n),r}})}(e.data);return c}};const{attrs:i}=t;var d={register({instance:e,template:r,store:n,scope:o}){e.registerHelper("key",t=>new e.SafeString(`${i.key}="${t}"`)),e.registerHelper("ref",t=>new e.SafeString(`${i.ref}="${t}"`)),e.registerHelper("concat",(function(...e){return e.pop(),e.join("")})),e.registerHelper("onlyIf",(function(...t){t.pop();const[r,n]=t;return new e.SafeString(r?n:"")})),e.registerHelper("on",(function(...t){const{hash:r}=t.pop(),a=s.randomId(),c=this;return n.handlers[a]=[],s.nextTick().then((function(){const i=s.dom.findMethod(a);i&&Object.entries(r).forEach(([d,l])=>{l in o.methods||e.log(3,`ReBars: "${l}" is not a method.`,r,i);const h=e=>{const r=s.buildContext(c,o);r.event=e,r.methods[l](...t)};n.handlers[a].push({$el:i,handler:h,eventType:d}),i.addEventListener(d,h)})})),new e.SafeString(`${i.method}="${a}"`)})),e.registerHelper("bind",(function(...t){const{hash:r}=t.pop(),o=this,a=s.randomId();return n.handlers[a]=[],s.nextTick().then(()=>{const t=s.dom.findMethod(a);t&&Object.entries(r).forEach(([r,c])=>{function i(r){try{s.setPath(o,c,r.target.value||null)}catch(r){e.log(3,`ReBars: could not set path ${c}`,t)}}n.handlers[a].push({$el:t,handler:i,eventType:r}),t.addEventListener(r,i)})}),new e.SafeString(`${i.method}="${a}"`)})),e.registerHelper("watch",(function(...r){const{fn:a,hash:i}=r.pop(),d=s.randomId(),l={path:r.filter(e=>"string"==typeof e),render:()=>a(this)};if(!r.length){const e=c.create({...o,data:this},e=>{l.path=e},!0);a(e)}return s.nextTick().then(()=>{const o=s.dom.findWatcher(d);o&&(n.renders[d]={...l,$el:o},r.forEach(t=>{"string"!=typeof t&&e.log(3,"ReBars: can only watch Strings",r,o)}),e.log(t.logLevel(),"ReBars: watching",l.path,o))}),s.dom.wrapWatcher(d,a(this),i)}))}};const{attrs:l,regex:h}=t;function u(e,t){const r=e.replace(h.attrs,""),n=t.replace(h.attrs,"");return s.dom.getShadow(r).isEqualNode(s.dom.getShadow(n))}var f={canPatch:e=>e.children.length&&e.children.length>1&&Array.from(e.children).every(e=>e.getAttribute(l.key)),hasChanged:(e,t)=>!u(e.innerHTML,t),compare({$target:e,html:r,instance:n,store:o}){const a=s.dom.getShadow(r),c=Array.from(a.children),i=t.logLevel();Array.from(e.children).forEach(e=>{"undefined"===e.getAttribute(l.key)&&n.log(3,"ReBars: key was undefined",e);const t=s.dom.findAttr(l.key,e.getAttribute(l.key),a);t?u(t.innerHTML,e.innerHTML)||(n.log(i,"ReBars: updating",e,t),e.replaceWith(t.cloneNode(!0))):(n.log(i,"ReBars: removing",e),e.remove())}),c.forEach((t,r)=>{s.dom.findAttr(l.key,t.getAttribute(l.key),e)||(n.log(i,"ReBars: adding",t),e.append(t.cloneNode(!0)))}),c.forEach((t,r)=>{const n=e.children[r];n.getAttribute(l.key)!==t.getAttribute(l.key)&&n.replaceWith(t.cloneNode(!0))})}},p={paths({changed:e,store:r,instance:n}){Object.entries(r.renders).filter(([t,r])=>s.shouldRender(e,r.path)&&s.dom.findWatcher(t)).forEach(([e,o])=>{const a=s.dom.findWatcher(e);if(!a)return;const c=o.render(),i=s.dom.recordState(a);if(f.hasChanged(a,c)){if(f.canPatch(a))return n.log(t.logLevel(),"ReBars: patching",o.path,a),f.compare({$target:a,html:c,instance:n,store:r}),void s.dom.restoreState(a,i);a.style.display=""===c?"none":"",a.innerHTML=c,s.dom.restoreState(a,i),n.log(t.logLevel(),"ReBars: re-render",o.path,a)}})}},g={start(e,{renders:r,handlers:n}){const o=new MutationObserver(([e])=>{e.removedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const o=e.getAttribute(t.attrs.watch),a=e.getAttribute(t.attrs.method);o&&delete r[o],a&&(n[a].forEach(e=>{e.$el.removeEventListener(e.eventType,e.handler)}),delete n[a])}})});return o.observe(e,{attributes:!0,childList:!0,subtree:!0}),o}};const m={load:s.loadTemplate,app({helpers:e={},template:r,data:n={},methods:o={},partials:a={},watch:i={},hooks:l={},Handlebars:h=(window?window.Handlebars:null),trace:u=!1}){const f=h.create(),m={renders:{},handlers:{}};if(!h)throw new Error("ReBars: needs Handlebars in order to run");return t.setTrace(u),{store:m,instance:f,async render(h){const u=document.querySelector(h);await Promise.all(Object.values(a)),Object.entries(a).forEach(async([e,t])=>f.registerPartial(e,t instanceof Promise?await t:t));const y=f.compile(r instanceof Promise?await r:r);if(!u)return f.log(3,`ReBars: document.querySelector("${h}") could not be found on the document`);const b={$app:u,methods:o,data:n};s.registerHelpers({instance:f,helpers:e,scope:b}),d.register({instance:f,template:r,store:m,scope:b}),b.data=c.create(b,async e=>{f.log(t.logLevel(),"ReBars: change",e),p.paths({changed:e,store:m,instance:f}),await s.nextTick(),Object.entries(i).forEach(([t,r])=>{s.shouldRender(e,[t])&&r.call(b.data,s.buildContext(b.data,b))})}),g.start(u,m);const w=s.buildContext(b.data,b);l.beforeRender&&await l.beforeRender.call(b.data,w),u.innerHTML=y(b.data),l.afterRender&&await l.afterRender.call(b.data,w)}}}};window&&(window.ReBars=window.ReBars||m);export default m;
//# sourceMappingURL=re-bars.esm.min.js.map
