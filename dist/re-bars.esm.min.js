const e={warn:"background: #484915; color: #ffffbe; padding: .1em; font-weight: normal;",log:"background: #324645; color:#c9faff; padding: .1em; font-weight: normal;"},t=(e,{loc:t,data:n})=>{const r=e.split("\n").slice(t.start.line-1,t.end.line),o=Array(r[0].length-r[0].trim().length).join(" ");return r[0]=r[0].substr(t.start.column),r[r.length-1]=r[r.length-1].substr(0,t.end.column),["",`component: ${n.root.$name}, template line: ${t.start.line}`,"============================================"].concat(r.map(e=>e.replace(o,""))).join("\n")},n=(t,n,o={},...a)=>{let d=r[n](o);if(!["warn","log"].includes(t))throw a.forEach(e=>console.error(e)),new Error(d);d="%c "+d+" ",window.ReBars&&window.ReBars.trace&&(a?(console.groupCollapsed(d,e[t]),a.forEach(e=>console.log(e)),console.groupEnd()):console.log(d,e[t]))},r={noEl:()=>"$el must be present in the document",noHbs:()=>"ReBars need Handlebars in order to run!",noName:()=>"Each ReBars component should have a name",dataFn:({name:e})=>`${e}: must be a function`,tplStr:({name:e})=>`${e}: needs a template string`,propStomp:({name:e,key:t})=>`${e}: "data.${t}" was overrode by a prop`,propUndef:({name:e,key:t})=>`${e}: was passed undefined for prop "${t}"`,oneRoot:({name:e})=>`${e}: must have one root node, and cannot be a {{#watch}} block. \nThis error can also be caused by malformed html.`,badPath:({path:e})=>`${e} was not found in object`,reRender:({name:e,path:t})=>`${e}: re-rendering "${t}"`,patching:({name:e,path:t})=>`${e}: patching ref Array "${t}"`,pathTrigger:({path:e,action:t,name:n})=>`${n}: ${t} "${e}"`,triggered:({name:e,paths:t})=>`${e}: data change "${t}"`,noMethod:({name:e,methodName:n,template:r,loc:o,data:a})=>`${e}: does not have a method named "${n}" ${t(r,{data:a,loc:o})}`,paramUndef:({data:e,template:n,loc:r})=>`component:${e.root.$name} passed undefined to a helper\n      ${t(n,{data:e,loc:r})}\n    `,noComp:({data:e,loc:n,template:r,cName:o})=>`${e.root.$name}: child component "${o}" is not registered\n      ${t(r,{data:e,loc:n})}\n    `,restrictedKey:({name:e,key:t})=>`${e}: cannot use restricted key "${t}" in your data as it's a helper`,focusFail:({ref:e,name:t})=>`${t}: ref "${e}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each`,notKeyed:({name:e,path:t})=>`${e}: patching "${t}" add a {{ref 'someUniqueKey' }} to avoid re-rendering the entire Array`};var o={messages:r,getStr:(e,t)=>r[e](t),warn:n.bind(null,"warn"),fail:n.bind(null,"throw"),log:n.bind(null,"log")};let a=1;var d={dom:{tagComponent(e,t,n){const r=this.getShadow(t),a=r.firstElementChild;(!a||!r.children||r.children.length>1||a.dataset.rbsWatch)&&o.fail("oneRoot",{name:n},r),a.dataset.rbsComp=e;const d=r.innerHTML;return r.remove(),d},restoreCursor(e,t){const n=this.findRef(e,t.ref);n&&(Array.isArray(n)?o.warn("focusFail",{ref:t.ref,name:name},n):(n.focus(),t.pos&&n.setSelectionRange(t.pos+1,t.pos+1)))},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.getAttribute("ref")===t?e:e.querySelector(`[ref="${t}"]`),findRefs(e){const t=this.findComponent(e),n=Array.from(t.querySelectorAll("[ref]"));return t.getAttribute("ref")&&n.push(t),n.reduce((e,t)=>{const n=t.getAttribute("ref"),r=e[n];return e[n]=r?[r].concat(t):t,e},{})},findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),propStr:e=>Object.entries(e).map(([e,t])=>`${e}="${t}"`).join(" "),wrapWatcher(e,t,n){const{tag:r,...o}={tag:"span",...n};return`<${r} ${this.propStr(o)} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},stringify:(e,t=2)=>JSON.stringify(e,(e,t)=>"function"==typeof t?t+"":t,t),debounce(e,t=0,n=!1){let r=null;return function(){const o=n&&!r,a=()=>e.apply(this,arguments);clearTimeout(r),r=setTimeout(a,t),o&&a()}},shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${a++}`,setKey(e,t,n){const r=t.split(".");r.reduce((a,d,s)=>(d in a||o.fail("badPath",{path:t},e),s+1===r.length&&(a[d]=n),a[d]),e)}},s={create(e,t){let n=[];const r=d.debounce(()=>{t(n),n=[]}),o=e=>{n.push(e),r(n)};const a=function e(t,n=[]){return new Proxy(t,{get:function(t,r){if("ReBarsPath"===r)return n.join(".");const o=Reflect.get(...arguments);return"function"==typeof o&&t.hasOwnProperty(r)?o.bind(a):null!==o&&"object"==typeof o&&"methods"!==r?e(o,n.concat(r)):o},set:function(e,t){const r=Reflect.set(...arguments),a=n.concat(t).join(".");return o(a),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),a=n.concat(t).join(".");return o(a),r}})}(e);return a}},c={register({app:e,instance:t,components:n,helpers:r,template:a,methods:s,name:c}){Object.entries(r).forEach(([e,n])=>t.registerHelper(e,n)),t.registerHelper("isComponent",e=>Object.keys(n).includes(e)),t.registerHelper("component",(function(...e){const{hash:r,data:d,loc:s}=e.pop(),c=e[0];return n[c]||o.fail("noComp",{data:d,loc:s,template:a,cName:c}),new t.SafeString(n[c].instance(r).render())})),t.registerHelper("debug",(e,{hash:n,data:r,loc:s})=>(void 0===e&&o.fail("paramUndef",{template:a,data:r,loc:s}),new t.SafeString(`<pre class="debug" ${d.dom.propStr(n)}>${d.stringify(e)}</pre>`))),t.registerHelper("watch",(function(...t){const{fn:n,hash:r,data:s,loc:c}=t.pop(),i=s.root.$_componentId,l=d.randomId(),p=t.map(e=>((e,t=!0)=>(void 0===e&&o.fail("paramUndef",{template:a,loc:c,data:s}),"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e))(e,!1)).join(".").split(",");return e.components.instances[i].renders[l]={path:p,render:()=>n(this)},d.dom.wrapWatcher(l,n(this),r)})),t.registerHelper("method",(function(){const[e,...n]=arguments,[r,i="click"]=e.split(":"),{data:l,loc:p}=n.pop();r in s||o.fail("noMethod",{name:c,methodName:r,template:a,data:l,loc:p});const m={"data-rbs-method":[l.root.$_componentId,i,r]};return n&&n.length&&(m["data-rbs-method"]=m["data-rbs-method"].concat(n)),new t.SafeString(d.dom.propStr(m))})),t.registerHelper("bound",(e,{hash:n={},data:r,loc:a})=>{const{$_componentId:s}=r.root,c=[s,e];let i;try{i=e.includes(".")?e.split(".").reduce((e,t)=>e[t],r.root):r.root[e]}catch(t){o.fail("badPath",{path:e})}const l={value:i,ref:n.ref||e,"data-rbs-bound":c};return new t.SafeString(d.dom.propStr(l))})}};function i(e,t){const n=new RegExp(/data-rbs(.*?)="(.*?)"/g);return e.replace(n,"")===t.replace(n,"")}var l={canPatch:e=>e.children.length&&Array.from(e.children).every(e=>e.getAttribute("ref")),hasChanged:(e,t)=>!i(e.innerHTML,t),compare({app:e,$target:t,html:n}){const r=d.dom.getShadow(n),o=Array.from(r.children);Array.from(t.children).forEach(e=>{const t=d.dom.findRef(r,e.getAttribute("ref"));t?i(t.innerHTML,e.innerHTML)||e.replaceWith(t.cloneNode(!0)):e.remove()}),o.forEach((e,n)=>{d.dom.findRef(t,e.getAttribute("ref"))||function(e,t,n=0){n>=e.children.length?e.appendChild(t):e.insertBefore(t,e.children[n])}(t,e.cloneNode(!0),n)}),o.forEach((e,n)=>{const r=t.children[n];r.getAttribute("ref")!==e.getAttribute("ref")&&r.replaceWith(e.cloneNode(!0))})}},p={paths({app:e,paths:t,renders:n,name:r}){Object.entries(n).filter(([e,n])=>t.some(e=>d.shouldRender(e,n.path))&&d.dom.findWatcher(e)).forEach(([t,n])=>{const a=d.dom.findWatcher(t),s=n.render();if(!l.hasChanged(a,s))return;if(l.canPatch(a))return l.compare({app:e,$target:a,html:s}),void o.log("patching",{name:r,path:n.path},a);const c=n.path.find(e=>e.endsWith(".length"));c&&o.warn("notKeyed",{name:r,path:c},a);const i={ref:document.activeElement.getAttribute("ref"),pos:document.activeElement.selectionStart};a.style.display=""===s?"none":"",a.innerHTML=s,d.dom.restoreCursor(a,i),o.log("reRender",{name:r,path:n.path},a)}),e.deleteOrphans()}};const m=["component","ref","debug","isComponent","method","bound","watch","isComponent"];var h={register:function e({id:t,Handlebars:n,trace:r,helpers:a,components:i},{name:l,template:h,data:u=(()=>({})),helpers:f={},hooks:g={},methods:b={},watchers:$={},components:y=[]}){l||o.fail("noName",null,arguments[1]),"function"!=typeof u&&o.fail("dataFn",{name:l}),"string"!=typeof h&&o.fail("tmplStr",{name:l});const w=arguments[0],v=n.create(),E=v.compile(h),S=y.reduce((t,n)=>{const r=e(w,n);return t[n.name]=r,t},{...i.registered});return Object.keys(u()).forEach(e=>{m.concat(Object.keys(f)).includes(e)&&o.fail("restrictedKey",{name:l,key:e})}),c.register({app:w,methods:b,instance:v,name:l,helpers:{...f,...a},components:S,template:h}),{instance(e={}){const t=d.randomId(),n=u(),r={};Object.entries(e).forEach(([e,t])=>{void 0===t&&o.warn("propUndef",{name:l,key:e})});const a=s.create({...n,$props:e,$methods:b,$name:l,$_componentId:t,$el:()=>d.dom.findComponent(t),$refs:()=>d.dom.findRefs(t)},e=>{o.log("triggered",{name:l,paths:e},r),p.paths({app:w,paths:e,renders:r,name:l})});g.created&&g.created.call(a);const c={id:t,scope:a,hooks:g,renders:r,handlers:{bound(e){const[t,n]=e.target.dataset.rbsBound.split(",");d.setKey(a,n,e.target.value)},method(e){const[t,n,r,...o]=e.target.dataset.rbsMethod.split(",");a.$methods[r](e,...o)}},detached(){g.detached&&g.detached.call(a)},attached(){g.attached&&g.attached.call(a)},render:()=>d.dom.tagComponent(t,E(a),l)};return w.components.instances[t]=c,c}}}},u={app({$el:e,root:t,Handlebars:n=window.Handlebars,helpers:r={},components:a=[],trace:s=!1}){n||o.fail("noHbs"),document.body.contains(e)||o.fail("noEl");const c={id:d.randomId(),Handlebars:n,trace:s,listening:!0,helpers:r,$el:e,deleteOrphans:d.debounce(()=>{Object.keys(c.components.instances).forEach(e=>{d.dom.findComponent(e)||delete c.components.instances[e]})}),components:{registered:{},instances:{}}};function i(e,t){const n="add"===e?"attached":"detached",r=t.dataset.rbsComp;c.components.instances[r][n]()}function l(e,t){const n="add"===e?"addEventListener":"removeEventListener",[r,o]=t.dataset.rbsMethod.split(",");t[n](o,c.components.instances[r].handlers.method)}function p(e,t){const n="add"===e?"addEventListener":"removeEventListener",[r,o]=t.dataset.rbsBound.split(",");t[n]("input",c.components.instances[r].handlers.bound)}return c.components.registered=a.reduce((e,t)=>(e[t.name]=h.register(c,t),e),{}),new MutationObserver(e=>{e.forEach(({addedNodes:e,removedNodes:t})=>{e.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsComp&&i("add",e),e.dataset.rbsMethod&&l("add",e),e.dataset.rbsBound&&p("add",e),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"add")),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"add")),e.querySelectorAll("[data-rbs-bound]").forEach(p.bind(null,"add")))}),t.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsMethod&&l("remove",e),e.dataset.rbsBound&&p("remove",e),e.dataset.rbsComp&&i("remove",e),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"remove")),e.querySelectorAll("[data-rbs-bound]").forEach(p.bind(null,"remove")),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"remove")))})})}).observe(e,{childList:!0,attributes:!0,subtree:!0}),e.innerHTML=h.register(c,t).instance().render(),c}};export default u;
//# sourceMappingURL=re-bars.esm.min.js.map
