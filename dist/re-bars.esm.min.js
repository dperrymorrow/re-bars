const e={warn:"background: #484915; color: #ffffbe; padding: .1em; font-weight: normal;",log:"background: #324645; color:#c9faff; padding: .1em; font-weight: normal;"},t=(e,{loc:t,data:n})=>{const r=e.split("\n").slice(t.start.line-1,t.end.line),o=Array(r[0].length-r[0].trim().length).join(" ");return r[0]=r[0].substr(t.start.column),r[r.length-1]=r[r.length-1].substr(0,t.end.column),["",`component: ${n.root.$name}, template line: ${t.start.line}`,"============================================"].concat(r.map(e=>e.replace(o,""))).join("\n")},n=(t,n,o={},...a)=>{let s=r[n](o);if(!["warn","log"].includes(t))throw a.forEach(e=>console.error(e)),new Error(s);s="%c "+s+" ",window.ReBars.trace&&(a?(console.groupCollapsed(s,e[t]),a.forEach(e=>console.log(e)),console.groupEnd()):console.log(s,e[t]))},r={noEl:()=>"$el must be present in the document",noHbs:()=>"ReBars need Handlebars in order to run!",noName:()=>"Each ReBars component should have a name",dataFn:({name:e})=>`component:${e} must be a function`,tplStr:({name:e})=>`component:${e} needs a template string`,propStomp:({name:e,key:t})=>`component:${e} "data.${t}" was overrode by a prop`,propUndef:({name:e,key:t})=>`component:${e} was passed undefined for prop "${t}"`,oneRoot:({name:e})=>`component:${e} must have one root node, and cannot be a {{#watch}} block. \nThis error can also be caused by malformed html.`,noMethod:({name:e,methodName:t})=>`component:${e} does not have a method named "${t}"`,badPath:({path:e})=>`${e} was not found in object`,reRender:({name:e,path:t})=>`component:${e} re-rendering "${t}"`,patching:({name:e,path:t})=>`component:${e} patching ref Array "${t}"`,pathTrigger:({path:e,action:t,name:n})=>`component:${n} ${t} "${e}"`,triggered:({name:e,paths:t})=>`component:${e} data change "${t}"`,paramUndef:({data:e,template:n,loc:r})=>`component:${e.root.$name} passed undefined to a helper\n      ${t(n,{data:e,loc:r})}\n    `,badWatchParam:({data:e,template:n,loc:r,path:o})=>`component:${e.root.$name} could not find "${o}" to watch. If primitve wrap in quotes\n      ${t(n,{data:e,loc:r})}\n    `,noComp:({data:e,loc:n,template:r,cName:o})=>`component:${e.root.$name} child component "${o}" is not registered\n      ${t(r,{data:e,loc:n})}\n    `,restrictedKey:({name:e,key:t})=>`component:${e} cannot use restricted key "${t}" in your data as it's a helper`,focusFail:({ref:e,name:t})=>`component:${t} ref "${e}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each`,notKeyed:({name:e,path:t})=>`component:${e} patching "${t}" add a {{ ref }} to avoid re-rendering the entire target`};var o={messages:r,getStr:(e,t)=>r[e](t),warn:n.bind(null,"warn"),fail:n.bind(null,"throw"),log:n.bind(null,"log")};let a=1;var s={dom:{tagComponent(e,t,n){const r=this.getShadow(t),a=r.firstElementChild;(!a||!r.children||r.children.length>1||a.dataset.rbsWatch)&&o.fail("oneRoot",{name:n},r),a.dataset.rbsComp=e;const s=r.innerHTML;return r.remove(),s},restoreCursor(e,t){const n=this.findRef(e,t.ref);n&&(Array.isArray(n)?o.warn("focusFail",{ref:t.ref,name:name},n):(n.focus(),t.pos&&n.setSelectionRange(t.pos+1,t.pos+1)))},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.querySelector(`[data-rbs-ref="${t}"]`),findRefs(e){const t="object"==typeof e?e:this.findComponent(e);return Array.from(t.querySelectorAll("[data-rbs-ref]")).reduce((e,t)=>{const n=t.dataset.rbsRef,r=e[t.dataset.rbsRef];return e[n]=r?[r].concat(t):t,e},{})},findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,t,n)=>{const{tag:r,...o}={tag:"span",class:"rbs-watch",...n};return`<${r} ${Object.entries(o).map(([e,t])=>`${e}="${t}"`).join(" ")} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},isKeyedNode:e=>e.children.length&&Array.from(e.children).every(e=>e.dataset.rbsRef),normalizeHtml:e=>e.replace(new RegExp(/="rbs(.*?)"/g),""),isEqHtml(e,t){const n="string"==typeof e?this.getShadow(e):this.getShadow(e.innerHTML),r="string"==typeof t?this.getShadow(t):this.getShadow(t.innerHTML);return n.innerHTML=this.normalizeHtml(n.innerHTML),r.innerHTML=this.normalizeHtml(r.innerHTML),n.isEqualNode(r)},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},deleteOrphans(e,t){const n=this.getStorage(e,t),r=this.getStorage(e);Object.keys(r.inst).forEach(e=>{if(!this.dom.findComponent(e)){const t=r.inst[e];t.scope.$hooks.detached&&t.scope.$hooks.detached(),delete r.inst[e]}}),Object.keys(n.renders).forEach(e=>{this.dom.findWatcher(e)||delete n.renders[e]})},debounce(e,t,n=!1){let r=null;return function(){const o=n&&!r,a=()=>e.apply(this,arguments);clearTimeout(r),r=setTimeout(a,t),o&&a()}},makeParams:e=>e.map(e=>{if(["[event]"].includes(e))return e.replace("[","").replace("]","");if(null!==e&&"object"==typeof e)throw new Error(`component:${name} must only pass primitives as argument to a handler. \n${JSON.stringify(e,null,2)}`);return"string"==typeof e?`'${e}'`:null===e?`${e}`:e}),getStorage(e,t){return t?this.findByPath(window.ReBars,`apps.${e}.inst.${t}`):this.findByPath(window.ReBars,`apps.${e}`)},findByPath:(e,t)=>{try{return t.includes(".")?t.split(".").reduce((e,t)=>e[t],e):e[t]}catch(n){o.fail("badPath",{path:t},e)}},shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${a++}`,setKey(e,t,n){const r=t.split(".");r.reduce((a,s,c)=>(s in a||o.fail("badPath",{path:t},e),c+1===r.length&&(a[s]=n),a[s]),e)}},c={init(e,t){const{scope:n,renders:r}=s.getStorage(e,t),{$name:a}=n;const c=[],d={watchers:{},renders:{}},i=s.debounce(()=>{o.log("triggered",{name:a,paths:c.join(",")},d),c.length=0,Object.entries(d.watchers).forEach(([e,t])=>{delete d.watchers[e],t()}),Object.entries(d.renders).forEach(([e,t])=>{const n=s.dom.findWatcher(e);if(!n)return;const r=t.render();if(s.dom.isEqHtml(n.innerHTML,r))return;if(s.dom.isKeyedNode(n))return function(e,t){const n=s.dom.getShadow(t),r=Array.from(n.children);Array.from(e.children).forEach(e=>{const t=s.dom.findRef(n,e.dataset.rbsRef);t?s.dom.isEqHtml(t,e)||e.replaceWith(t.cloneNode(!0)):e.remove()}),r.forEach((t,n)=>{const r=t.dataset.rbsRef;if(!s.dom.findRef(e,r)){const r=e.children[n];r?e.insertBefore(t.cloneNode(!0),r):e.append(t.cloneNode(!0))}}),r.forEach((t,n)=>{const r=t.dataset.rbsRef,o=e.children[n];o&&o.dataset.rbsRef!==r&&e.children[n].replaceWith(t.cloneNode(!0))})}(n,r),o.log("patching",{name:a,path:t.path},n),void delete d.renders[e];const c=t.matching.find(e=>e.endsWith(".length"));c&&o.warn("notKeyed",{name:a,path:c},n);const i={ref:document.activeElement.dataset.rbsRef,pos:document.activeElement.selectionStart};n.style.display=""===r?"none":"",n.innerHTML=r,s.dom.restoreCursor(n,i),o.log("reRender",{name:a,path:t.path},n)})},0);return{que(o){s.deleteOrphans(e,t),Object.entries(n.$watchers).forEach(([e,t])=>{s.shouldRender(o,e)&&(d.watchers[e]=t)}),Object.entries(r).forEach(([e,t])=>{s.shouldRender(o,t.path)&&(e in d.renders||(d.renders[e]={...t,matching:[o]}),d.renders[e].matching.push(o))}),c.push(o),i()}}}},d={create(e){let t;const n=function e(r,o=[]){return new Proxy(r,{get:function(t,r){if("ReBarsPath"===r)return o.join(".");const a=Reflect.get(...arguments);return"function"==typeof a&&t.hasOwnProperty(r)?a.bind(n):null!==a&&"object"==typeof a&&"methods"!==r?e(a,o.concat(r)):a},set:function(e,n){const r=Reflect.set(...arguments),a=o.concat(n).join(".");return t&&t(a),r},deleteProperty:function(e,n){const r=Reflect.deleteProperty(...arguments),a=o.concat(n).join(".");return t&&t(a),r}})}(e);return{watch(){t=c.init(n.$_appId,n.$_componentId).que},data:n}}},i={register(e,t,n){Object.entries(t).forEach(([t,n])=>e.registerHelper(t,n)),e.registerHelper("component",(function(...t){const{hash:r,data:a,loc:c}=t.pop(),{cDefs:d}=s.getStorage(a.root.$_appId),i=t[0];return d[i]||o.fail("noComp",{data:a,loc:c,template:n,cName:i}),new e.SafeString(d[i].instance(r).render())})),e.registerHelper("isComponent",(function(e,{data:t}){const{cDefs:n}=s.getStorage(t.root.$_appId);return Object.keys(n).includes(e)})),e.registerHelper("ref",t=>new e.SafeString(`data-rbs-ref="${t}"`)),e.registerHelper("debug",(t,{data:r,loc:a})=>{void 0===t&&o.fail("paramUndef",{template:n,data:r,loc:a});return new e.SafeString(`<pre class="debug">${JSON.stringify(t,(e,t)=>"function"==typeof t?t+"":t,2)}</pre>`)})}},l={register(e){e.registerHelper("method",(function(){const[t,...n]=arguments,[r,o="click"]=t.split(":"),{data:a}=n.pop(),{$_appId:c,$_componentId:d}=a.root,i=s.makeParams([c,d,r,"[event]"].concat(n));return new e.SafeString(`on${o}="rbs.handlers.trigger(${i.join(",")})"`)})),e.registerHelper("bound",(t,{hash:n={},data:r})=>{const{$_appId:o,$_componentId:a}=r.root,c=s.findByPath(r.root,t),d=n.ref||t,i=s.makeParams([o,a,"[event]",t]);return new e.SafeString(`value="${c}" data-rbs-ref="${d}" oninput="rbs.handlers.bound(${i.join(",")})"`)})}},p={register(e,t){e.registerHelper("watch",(function(...e){const{fn:n,hash:r,data:a,loc:c}=e.pop(),d=e.map(e=>((e,n=!0)=>(void 0===e&&o.fail("paramUndef",{template:t,loc:c,data:a}),"object"==typeof e?`${e.ReBarsPath}${n?".*":""}`:e))(e,!1)).join(".").split(","),i=s.randomId();return s.getStorage(a.root.$_appId,a.root.$_componentId).renders[i]={path:d,render:()=>n(this)},s.dom.wrapWatcher(i,n(this),r)}))}};const m=["component","ref","debug","isComponent","method","bound","watch","isComponent"];var h={register:function e(t,n,{name:r,template:a,data:c,helpers:h={},hooks:f={},methods:u={},watchers:g={},components:$=[]}){const b=s.getStorage(t);c=c||function(){return{}},r||o.fail("noName",null,arguments[2]),"function"!=typeof c&&o.fail("dataFn",{name:r}),"string"!=typeof a&&o.fail("tmplStr",{name:r});const w=n.create(),y=w.compile(a);return $.forEach(r=>{r.name||o.fail("noName",null,r),b.cDefs[r.name]||(b.cDefs[r.name]=e(t,n,r))}),Object.keys(c()).forEach(e=>{m.concat(Object.keys(h)).includes(e)&&o.fail("restrictedKey",{name:r,key:e})}),i.register(w,{...h,...b.helpers},a),l.register(w,u),p.register(w,a),{instance(e={}){const n=s.randomId(),a=c();Object.entries(e).forEach(([e,t])=>{void 0===t&&o.warn("propUndef",{name:r,key:e})});const{data:i,watch:l}=d.create({...a,$props:e,$methods:u,$hooks:f,$name:r,$watchers:g,$_appId:t,$_componentId:n,$refs:()=>s.dom.findRefs(n)});return b.inst[n]={scope:i,renders:{}},f.created&&f.created.call(i),{scope:i,render(){const e=s.dom.tagComponent(n,y(i),r);return l(),f.attached&&setTimeout(()=>{f.attached.call(i)},0),e}}}}}},f={app({$el:e,root:t,Handlebars:n=window.Handlebars,helpers:r={},trace:a=!1}){window.rbs=window.ReBars=window.ReBars||{},window.ReBars.apps=window.ReBars.apps||{},window.ReBars.trace=a,window.ReBars.handlers=window.ReBars.handlers||{trigger(...e){const[t,n,r,...a]=e,c=s.getStorage(t,n).scope,d=c.$methods[r];d||o.fail("noMethod",{name:c.$name,methodName:r}),d(...a)},bound(e,t,n,r){const{scope:o}=s.getStorage(e,t);s.setKey(o,r,n.target.value)}},n||o.fail("noHbs"),document.body.contains(e)||o.fail("noEl");const c=s.randomId(),d=window.ReBars.apps[c]={helpers:r,cDefs:{},inst:{}};return e.innerHTML=h.register(c,n,t).instance().render(),{id:c,storage:d}}};export default f;
//# sourceMappingURL=re-bars.esm.min.js.map
