{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/watcher.js","../src/helpers/event-handlers.js","../src/helpers/re-renders.js","../src/helpers/index.js","../src/index.js"],"sourcesContent":["let counter = 1;\n\nexport default {\n  findComponent: id => document.getElementById(id),\n  wrapTemplate: (id, html) => `<span id=\"${id}\">${html}</span>`,\n\n  findRefs(id) {\n    return Array.from(this.findComponent(id).querySelectorAll(\"[data-rbs-ref]\")).reduce(\n      (obj, $el) => {\n        obj[$el.dataset.rbsRef] = $el;\n        return obj;\n      },\n      {}\n    );\n  },\n\n  shouldRender(path, watchPath) {\n    if (path === watchPath) return true;\n\n    const pathSegs = path.split(\".\");\n    const watchSegs = watchPath.split(\".\");\n\n    return watchSegs.every((seg, index) => {\n      if (seg === pathSegs[index] || seg === \"*\") return true;\n      return false;\n    });\n  },\n\n  randomId: () => `rbs${counter++}`,\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"./utils.js\";\n\nexport default function({ id, app, props, data, watchers, name }) {\n  const cRef = app.storage.comp[id];\n\n  function _handler(path) {\n    Object.keys(watchers).forEach(watchPath => {\n      if (Utils.shouldRender(path, watchPath)) {\n        console.log(`ReBars: watcher \"${name}.${path}\"`);\n        watchers[watchPath].call(null, { data: proxyData, props });\n      }\n    });\n\n    Object.keys(cRef.renders).forEach(eId => {\n      const handler = cRef.renders[eId];\n\n      if (Utils.shouldRender(path, handler.path)) {\n        const $target = Utils.findComponent(eId);\n        if ($target) {\n          $target.innerHTML = handler.render();\n          console.log(\"ReBars: re-render\", $target, `component: ${name}`, `path: ${path}`);\n        } else {\n          delete cRef.renders[eId];\n        }\n      }\n    });\n\n    Object.keys(app.storage.comp).forEach(cId => {\n      if (!Utils.findComponent(cId)) {\n        // will fire destory hook here...\n        delete app.storage.comp[cId];\n      }\n    });\n  }\n\n  function _buildProxy(raw, tree = []) {\n    return new Proxy(raw, {\n      get: function(target, prop) {\n        if (prop === \"ReBarsPath\") return tree.join(\".\");\n        const value = Reflect.get(...arguments);\n        if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n          return _buildProxy(value, tree.concat(prop));\n        else return value;\n      },\n\n      set: function(target, prop) {\n        const ret = Reflect.set(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n\n      deleteProperty: function(target, prop) {\n        const ret = Reflect.deleteProperty(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n    });\n  }\n\n  const proxyData = _buildProxy({ ...data, ...props });\n  return proxyData;\n}\n","import Utils from \"../utils.js\";\n\nexport default function(storage, { proxyData, instance, methods, id, props, app }) {\n  const handlerPath = `rbs.apps.${app.id}.comp.${id}.ev`;\n\n  function _handler() {\n    const [eventType, methodName, ...args] = arguments;\n    args.splice(-1, 1);\n\n    const params = [methodName].concat(args).map(param => {\n      if (param !== null && typeof parm === \"object\")\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n      if (typeof param === \"string\") return `'${param}'`;\n      return param;\n    });\n\n    return new instance.SafeString(\n      `on${eventType}=\"${handlerPath}.method(event, ${params.join(\",\")})\"`\n    );\n  }\n\n  storage.ev.bind = (event, path) => Utils.setKey(proxyData, path, event.currentTarget.value);\n  storage.ev.method = function() {\n    const [event, key, ...args] = arguments;\n\n    return methods[key].call(\n      methods,\n      { data: proxyData, props, methods, $refs: Utils.findRefs(id) },\n      event,\n      ...args\n    );\n  };\n\n  instance.registerHelper(\"method\", _handler);\n  instance.registerHelper(\n    \"bind\",\n    path => new instance.SafeString(`oninput=\"${handlerPath}.bind(event, '${path}')\"`)\n  );\n}\n","import Utils from \"../utils.js\";\n\nexport default function(storage, { instance, proxyData }) {\n  instance.registerHelper(\"watch\", function(path, { fn }) {\n    if (path === null)\n      throw new Error(\"Rebars: cannot pass null to watch helper, pass a string or Object\");\n\n    if (typeof path === \"object\") {\n      path = `${path.ReBarsPath}.*`;\n      console.log(path);\n    }\n    const eId = Utils.randomId();\n    storage.renders[eId] = {\n      render: () => fn(proxyData),\n      path,\n    };\n    return Utils.wrapTemplate(eId, fn(proxyData));\n  });\n\n  instance.registerHelper(\"watchEach\", function(arr, { fn }) {\n    if (!Array.isArray(arr)) throw new Error(\"watchEach must be passed an Array\");\n    const path = arr.ReBarsPath;\n\n    return arr.map((item, index) => {\n      const eId = Utils.randomId();\n      storage.renders[eId] = {\n        render: () => fn(item),\n        path: `${path}.${index}.*`,\n      };\n      return Utils.wrapTemplate(eId, fn(item));\n    });\n  });\n}\n","import EventHandlers from \"./event-handlers.js\";\nimport ReRenders from \"./re-renders.js\";\n\nexport default function({ instance, app, id, proxyData, components }) {\n  const storage = app.storage.comp[id];\n\n  ReRenders(storage, ...arguments);\n  EventHandlers(storage, ...arguments);\n\n  instance.registerHelper(\"component\", function(name, { hash: props }) {\n    return new instance.SafeString(\n      app.component({\n        ...components[name],\n        ...{ parentData: proxyData, props },\n      })\n    );\n  });\n\n  instance.registerHelper(\"isChecked\", val => (val ? \"checked\" : \"\"));\n  instance.registerHelper(\"ref\", key => new instance.SafeString(`data-rbs-ref=\"${key}\"`));\n  instance.registerHelper(\n    \"debug\",\n    obj => new instance.SafeString(`<pre class=\"debug\">${JSON.stringify(obj, null, 2)}</pre>`)\n  );\n}\n","import Watcher from \"./watcher.js\";\nimport Helpers from \"./helpers/index.js\";\nimport Utils from \"./utils.js\";\n\nexport default function({ $el, root, Handlebars = window.Handlebars }) {\n  if (!Handlebars) throw new Error(\"ReBars need Handlebars in order to run!\");\n\n  window.ReBars = window.ReBars || {};\n  window.ReBars.apps = window.ReBars.apps || {};\n  window.rbs = window.ReBars;\n\n  const appId = Utils.randomId();\n  const storage = (window.ReBars.apps[appId] = { comp: {} });\n  const app = { component, id: appId, storage };\n\n  $el.innerHTML = component(root);\n\n  function component({\n    template,\n    components = {},\n    methods = {},\n    props = {},\n    hooks = {},\n    watchers = {},\n    data = {},\n    name,\n  }) {\n    const id = Utils.randomId();\n    const instance = Handlebars.create();\n\n    if (!name) throw new Error(\"Each ReBars component should have a name\");\n\n    storage.comp[id] = {\n      renders: {},\n      ev: {},\n      hooks,\n      name,\n    };\n\n    if (hooks.created) hooks.created(...arguments);\n    // need to call created before building the proxy\n    const proxyData = Watcher({ id, app, props, data, watchers, name });\n    const templateFn = instance.compile(template);\n\n    Helpers({\n      id,\n      instance,\n      app,\n      methods,\n      components,\n      proxyData,\n      props,\n      watchers,\n    });\n\n    if (\"attached\" in hooks) {\n      const int = setInterval(() => {\n        if (Utils.findComponent(id)) {\n          clearInterval(int);\n          hooks.attached({\n            ...{ watchers, methods, data: proxyData, props },\n            ...{ $refs: Utils.findRefs(id) },\n          });\n        }\n      }, 10);\n    }\n\n    return Utils.wrapTemplate(id, templateFn(proxyData));\n  }\n\n  return {\n    component,\n    storage,\n  };\n}\n"],"names":["counter","findComponent","id","document","getElementById","wrapTemplate","html","[object Object]","Array","from","this","querySelectorAll","reduce","obj","$el","dataset","rbsRef","path","watchPath","pathSegs","split","every","seg","index","randomId","value","arr","pointer","key","Error","length","app","props","data","watchers","name","cRef","storage","comp","_handler","Object","keys","forEach","Utils","shouldRender","call","proxyData","renders","eId","handler","$target","innerHTML","render","cId","_buildProxy","raw","tree","Proxy","get","target","prop","join","Reflect","arguments","concat","set","ret","deleteProperty","instance","methods","handlerPath","ev","bind","event","setKey","currentTarget","method","args","$refs","findRefs","registerHelper","eventType","methodName","splice","params","map","param","parm","JSON","stringify","SafeString","fn","ReBarsPath","isArray","item","components","ReRenders","EventHandlers","hash","component","parentData","val","root","Handlebars","window","ReBars","apps","rbs","appId","template","hooks","create","created","Watcher","templateFn","compile","Helpers","int","setInterval","clearInterval","attached"],"mappings":"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"}