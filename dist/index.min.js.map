{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/helpers/event-handlers.js","../src/helpers/re-renders.js","../src/index.js","../src/watcher.js","../src/helpers/index.js"],"sourcesContent":["let counter = 1;\n\nexport default {\n  findComponent: id => document.getElementById(id),\n  wrapTemplate: (id, html) => `<span id=\"${id}\">${html}</span>`,\n\n  findRefs(id) {\n    return Array.from(this.findComponent(id).querySelectorAll(\"[data-rbs-ref]\")).reduce(\n      (obj, $el) => {\n        obj[$el.dataset.rbsRef] = $el;\n        return obj;\n      },\n      {}\n    );\n  },\n\n  shouldRender(path, watch) {\n    const watchPaths = Array.isArray(watch) ? watch : [watch];\n    return watchPaths.some(watchPath => {\n      if (path === watchPath || watchPath === \".*\") return true;\n\n      const pathSegs = path.split(\".\");\n      const watchSegs = watchPath.split(\".\");\n\n      return watchSegs.every((seg, index) => {\n        if (seg === pathSegs[index] || seg === \"*\") return true;\n        return false;\n      });\n    });\n  },\n\n  randomId: () => `rbs${counter++}`,\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"../utils.js\";\n\nexport default function(storage, { data, instance, methods, id, props, app, name }) {\n  const handlerPath = `rbs.apps.${app.id}.comp.${id}.ev`;\n\n  function _handler() {\n    const [str, ...args] = arguments;\n    const [methodName, eventType = \"click\"] = str.split(\":\");\n    args.splice(-1, 1);\n\n    const params = [methodName].concat(args).map(param => {\n      if (param !== null && typeof parm === \"object\")\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n      if (typeof param === \"string\") return `'${param}'`;\n      return param;\n    });\n\n    return new instance.SafeString(\n      `on${eventType}=\"${handlerPath}.method(event,${params.join(\",\")})\"`\n    );\n  }\n\n  storage.ev.bind = (event, path) => Utils.setKey(data, path, event.currentTarget.value);\n  storage.ev.method = function() {\n    const [event, key, ...args] = arguments;\n\n    if (!(key in methods))\n      throw new Error(`${key} was not found in methods for component '${name}'`);\n\n    return methods[key].call(\n      methods,\n      { data, props, methods, $refs: Utils.findRefs(id) },\n      event,\n      ...args\n    );\n  };\n\n  instance.registerHelper(\"method\", _handler);\n  instance.registerHelper(\n    \"bind\",\n    path => new instance.SafeString(`oninput=\"${handlerPath}.bind(event, '${path}')\"`)\n  );\n}\n","import Utils from \"../utils.js\";\n\nexport default function(storage, { instance, name }) {\n  const _getPath = (target, wildcard = true) => {\n    if (target === undefined)\n      throw new Error(`have passed undefined to watch helper in component '${name}'`);\n    return typeof target === \"object\" ? `${target.ReBarsPath}${wildcard ? \".*\" : \"\"}` : target;\n  };\n\n  const _watch = (path, render) => {\n    const eId = Utils.randomId();\n    storage.renders[eId] = { path, render };\n    return eId;\n  };\n\n  instance.registerHelper(\"debug\", function(obj) {\n    const render = () => `<pre class=\"debug\">${JSON.stringify(obj, null, 2)}</pre>`;\n    const eId = _watch(_getPath(obj), render);\n    return new instance.SafeString(Utils.wrapTemplate(eId, render()));\n  });\n\n  instance.registerHelper(\"watch\", function(...args) {\n    const { fn } = args.pop();\n    const path = args\n      .map(arg => _getPath(arg, false))\n      .join(\".\")\n      .split(\",\");\n\n    const eId = _watch(path, () => fn(this));\n    return Utils.wrapTemplate(eId, fn(this));\n  });\n}\n","import Watcher from \"./watcher.js\";\nimport Helpers from \"./helpers/index.js\";\nimport Utils from \"./utils.js\";\n\nexport default function({ $el, root, Handlebars = window.Handlebars }) {\n  if (!Handlebars) throw new Error(\"ReBars need Handlebars in order to run!\");\n\n  window.ReBars = window.ReBars || {};\n  window.ReBars.apps = window.ReBars.apps || {};\n  window.rbs = window.ReBars;\n\n  const appId = Utils.randomId();\n  const storage = (window.ReBars.apps[appId] = { comp: {} });\n  const app = { component, id: appId, storage };\n\n  $el.innerHTML = component(root);\n\n  function component({\n    template,\n    methods = {},\n    props = {},\n    hooks = {},\n    name,\n    components = {},\n    data: rawData,\n    watchers = {},\n    helpers = {},\n  }) {\n    const id = Utils.randomId();\n    const instance = Handlebars.create();\n\n    if (!name) throw new Error(\"Each ReBars component should have a name\");\n\n    storage.comp[id] = {\n      renders: {},\n      ev: {},\n      hooks,\n      name,\n    };\n\n    if (hooks.created) hooks.created({ data: rawData, methods });\n    // need to call created before building the proxy\n    const proxyData = Watcher({ id, app, props, methods, rawData, watchers, name });\n    const templateFn = instance.compile(template);\n\n    Helpers({\n      props,\n      methods,\n      id,\n      components,\n      instance,\n      helpers,\n      data: proxyData,\n      name,\n      app,\n    });\n\n    if (\"attached\" in hooks) {\n      const int = setInterval(() => {\n        if (Utils.findComponent(id)) {\n          clearInterval(int);\n          hooks.attached({ methods, data: proxyData, props, $refs: Utils.findRefs(id) });\n        }\n      }, 10);\n    }\n\n    return Utils.wrapTemplate(id, templateFn(proxyData));\n  }\n\n  return {\n    component,\n    storage,\n  };\n}\n","import Utils from \"./utils.js\";\n\nexport default function({ id, app, props = {}, methods, rawData = {}, watchers = {}, name }) {\n  const cRef = app.storage.comp[id];\n\n  function _handler(path) {\n    Object.entries(watchers).forEach(([watch, fn]) => {\n      if (Utils.shouldRender(path, watch)) fn({ data: proxyData, props, methods });\n    });\n\n    Object.entries(cRef.renders).forEach(([eId, handler]) => {\n      if (Utils.shouldRender(path, handler.path)) {\n        const $target = Utils.findComponent(eId);\n        if ($target) {\n          const $temp = document.createElement(\"div\");\n          $temp.innerHTML = handler.render();\n\n          if ($target.innerHTML !== $temp.innerHTML) {\n            $target.innerHTML = $temp.innerHTML;\n            console.log(\"ReBars: re-render\", $target, `${name}: ${path}`);\n          }\n        } else {\n          delete cRef.renders[eId];\n        }\n      }\n    });\n\n    Object.keys(app.storage.comp).forEach(cId => {\n      if (!Utils.findComponent(cId)) {\n        // will fire destory hook here...\n        delete app.storage.comp[cId];\n      }\n    });\n  }\n\n  function _buildProxy(raw, tree = []) {\n    return new Proxy(raw, {\n      get: function(target, prop) {\n        if (prop === \"ReBarsPath\") return tree.join(\".\");\n        const value = Reflect.get(...arguments);\n        if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n          return _buildProxy(value, tree.concat(prop));\n        else return value;\n      },\n\n      set: function(target, prop) {\n        const ret = Reflect.set(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n\n      deleteProperty: function(target, prop) {\n        const ret = Reflect.deleteProperty(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n    });\n  }\n\n  const proxyData = _buildProxy({ ...rawData, ...props });\n  return proxyData;\n}\n","import EventHandlers from \"./event-handlers.js\";\nimport ReRenders from \"./re-renders.js\";\n\nexport default function({ instance, app, id, components, helpers, name }) {\n  const storage = app.storage.comp[id];\n\n  ReRenders(storage, ...arguments);\n  EventHandlers(storage, ...arguments);\n\n  instance.registerHelper(\"component\", function(cName, { hash: props }) {\n    Object.entries(props).forEach(([key, val]) => {\n      if (typeof val === \"function\")\n        throw new Error(\n          `cannot pass a function as a prop. in '${name}' child '${cName}' prop '${key}'`\n        );\n    });\n\n    return new instance.SafeString(\n      app.component({\n        ...components[cName],\n        ...{ props },\n      })\n    );\n  });\n\n  Object.entries(helpers).forEach(([name, fn]) => instance.registerHelper(name, fn));\n  instance.registerHelper(\"ref\", key => new instance.SafeString(`data-rbs-ref=\"${key}\"`));\n}\n"],"names":["counter","findComponent","id","document","getElementById","wrapTemplate","html","[object Object]","Array","from","this","querySelectorAll","reduce","obj","$el","dataset","rbsRef","shouldRender","path","watch","isArray","some","watchPath","pathSegs","split","every","seg","index","randomId","value","arr","pointer","key","Error","length","storage","data","instance","methods","props","app","name","handlerPath","ev","bind","event","Utils","setKey","currentTarget","method","args","arguments","call","$refs","findRefs","registerHelper","str","methodName","eventType","splice","params","concat","map","param","parm","JSON","stringify","SafeString","join","_getPath","target","wildcard","undefined","ReBarsPath","_watch","render","eId","renders","fn","pop","arg","root","Handlebars","window","ReBars","apps","rbs","appId","comp","component","template","hooks","components","rawData","watchers","helpers","create","created","proxyData","cRef","_handler","Object","entries","forEach","handler","$target","$temp","createElement","innerHTML","keys","cId","_buildProxy","raw","tree","Proxy","get","prop","Reflect","set","ret","deleteProperty","Watcher","templateFn","compile","ReRenders","EventHandlers","cName","hash","val","Helpers","int","setInterval","clearInterval","attached"],"mappings":"6LAAA,IAAIA,EAAU,QAEC,CACbC,cAAeC,GAAMC,SAASC,eAAeF,GAC7CG,aAAc,CAACH,EAAII,IAAS,aAAaJ,MAAOI,WAEhDC,SAASL,GACP,OAAOM,MAAMC,KAAKC,KAAKT,cAAcC,GAAIS,iBAAiB,mBAAmBC,OAC3E,CAACC,EAAKC,KACJD,EAAIC,EAAIC,QAAQC,QAAUF,EACnBD,GAET,KAIJI,aAAY,CAACC,EAAMC,KACEX,MAAMY,QAAQD,GAASA,EAAQ,CAACA,IACjCE,KAAKC,IACrB,GAAIJ,IAASI,GAA2B,OAAdA,EAAoB,OAAO,EAErD,MAAMC,EAAWL,EAAKM,MAAM,KAG5B,OAFkBF,EAAUE,MAAM,KAEjBC,MAAM,CAACC,EAAKC,IACvBD,IAAQH,EAASI,IAAkB,MAARD,KAMrCE,SAAU,IAAM,MAAM5B,MAEtBO,OAAOM,EAAKK,EAAMW,GAChB,MAAMC,EAAMZ,EAAKM,MAAM,KACvBM,EAAIlB,OAAO,CAACmB,EAASC,EAAKL,KACxB,KAAMK,KAAOD,GAAU,MAAM,IAAIE,MAAM,GAAGf,4BAAgCL,GAE1E,OADIc,EAAQ,IAAMG,EAAII,SAAQH,EAAQC,GAAOH,GACtCE,EAAQC,IACdnB,KCrCQ,WAASsB,GAASC,KAAEA,EAAIC,SAAEA,EAAQC,QAAEA,EAAOpC,GAAEA,EAAEqC,MAAEA,EAAKC,IAAEA,EAAGC,KAAEA,IAC1E,MAAMC,EAAc,YAAYF,EAAItC,WAAWA,OAqB/CiC,EAAQQ,GAAGC,KAAO,CAACC,EAAO3B,IAAS4B,EAAMC,OAAOX,EAAMlB,EAAM2B,EAAMG,cAAcnB,OAChFM,EAAQQ,GAAGM,OAAS,WAClB,MAAOJ,EAAOb,KAAQkB,GAAQC,UAE9B,KAAMnB,KAAOM,GACX,MAAM,IAAIL,MAAM,GAAGD,6CAA+CS,MAEpE,OAAOH,EAAQN,GAAKoB,KAClBd,EACA,CAAEF,KAAAA,EAAMG,MAAAA,EAAOD,QAAAA,EAASe,MAAOP,EAAMQ,SAASpD,IAC9C2C,KACGK,IAIPb,EAASkB,eAAe,UAlCxB,WACE,MAAOC,KAAQN,GAAQC,WAChBM,EAAYC,EAAY,SAAWF,EAAIhC,MAAM,KACpD0B,EAAKS,QAAQ,EAAG,GAEhB,MAAMC,EAAS,CAACH,GAAYI,OAAOX,GAAMY,IAAIC,IAC3C,GAAc,OAAVA,GAAkC,iBAATC,KAC3B,MAAM,IAAI/B,MACR,uDAAuDgC,KAAKC,UAAUhB,EAAM,KAAM,MAEtF,MAAqB,iBAAVa,EAA2B,IAAIA,KACnCA,IAGT,OAAO,IAAI1B,EAAS8B,WAClB,KAAKT,MAAchB,kBAA4BkB,EAAOQ,KAAK,aAoB/D/B,EAASkB,eACP,OACArC,GAAQ,IAAImB,EAAS8B,WAAW,YAAYzB,kBAA4BxB,SCxC7D,WAASiB,GAASE,SAAEA,EAAQI,KAAEA,IAC3C,MAAM4B,EAAW,CAACC,EAAQC,GAAW,KACnC,QAAeC,IAAXF,EACF,MAAM,IAAIrC,MAAM,uDAAuDQ,MACzE,MAAyB,iBAAX6B,EAAsB,GAAGA,EAAOG,aAAaF,EAAW,KAAO,KAAOD,GAGhFI,EAAS,CAACxD,EAAMyD,KACpB,MAAMC,EAAM9B,EAAMlB,WAElB,OADAO,EAAQ0C,QAAQD,GAAO,CAAE1D,KAAAA,EAAMyD,OAAAA,GACxBC,GAGTvC,EAASkB,eAAe,SAAS,SAAS1C,GACxC,MAAM8D,EAAS,IAAM,sBAAsBV,KAAKC,UAAUrD,EAAK,KAAM,WAC/D+D,EAAMF,EAAOL,EAASxD,GAAM8D,GAClC,OAAO,IAAItC,EAAS8B,WAAWrB,EAAMzC,aAAauE,EAAKD,SAGzDtC,EAASkB,eAAe,SAAS,YAAYL,GAC3C,MAAM4B,GAAEA,GAAO5B,EAAK6B,MACd7D,EAAOgC,EACVY,IAAIkB,GAAOX,EAASW,GAAK,IACzBZ,KAAK,KACL5C,MAAM,KAEHoD,EAAMF,EAAOxD,EAAM,IAAM4D,EAAGpE,OAClC,OAAOoC,EAAMzC,aAAauE,EAAKE,EAAGpE,iBCzBvB,UAASI,IAAEA,EAAGmE,KAAEA,EAAIC,WAAEA,EAAaC,OAAOD,aACvD,IAAKA,EAAY,MAAM,IAAIjD,MAAM,2CAEjCkD,OAAOC,OAASD,OAAOC,QAAU,GACjCD,OAAOC,OAAOC,KAAOF,OAAOC,OAAOC,MAAQ,GAC3CF,OAAOG,IAAMH,OAAOC,OAEpB,MAAMG,EAAQzC,EAAMlB,WACdO,EAAWgD,OAAOC,OAAOC,KAAKE,GAAS,CAAEC,KAAM,IAC/ChD,EAAM,CAAEiD,UAAAA,EAAWvF,GAAIqF,EAAOpD,QAAAA,GAIpC,SAASsD,GAAUC,SACjBA,EAAQpD,QACRA,EAAU,GAAEC,MACZA,EAAQ,GAAEoD,MACVA,EAAQ,GAAElD,KACVA,EAAImD,WACJA,EAAa,GACbxD,KAAMyD,EAAOC,SACbA,EAAW,GAAEC,QACbA,EAAU,KAEV,MAAM7F,EAAK4C,EAAMlB,WACXS,EAAW6C,EAAWc,SAE5B,IAAKvD,EAAM,MAAM,IAAIR,MAAM,4CAE3BE,EAAQqD,KAAKtF,GAAM,CACjB2E,QAAS,GACTlC,GAAI,GACJgD,MAAAA,EACAlD,KAAAA,GAGEkD,EAAMM,SAASN,EAAMM,QAAQ,CAAE7D,KAAMyD,EAASvD,QAAAA,IAElD,MAAM4D,ECxCK,UAAShG,GAAEA,EAAEsC,IAAEA,EAAGD,MAAEA,EAAQ,GAAED,QAAEA,EAAOuD,QAAEA,EAAU,GAAEC,SAAEA,EAAW,GAAErD,KAAEA,IACnF,MAAM0D,EAAO3D,EAAIL,QAAQqD,KAAKtF,GAE9B,SAASkG,EAASlF,GAChBmF,OAAOC,QAAQR,GAAUS,QAAQ,EAAEpF,EAAO2D,MACpChC,EAAM7B,aAAaC,EAAMC,IAAQ2D,EAAG,CAAE1C,KAAM8D,EAAW3D,MAAAA,EAAOD,QAAAA,MAGpE+D,OAAOC,QAAQH,EAAKtB,SAAS0B,QAAQ,EAAE3B,EAAK4B,MAC1C,GAAI1D,EAAM7B,aAAaC,EAAMsF,EAAQtF,MAAO,CAC1C,MAAMuF,EAAU3D,EAAM7C,cAAc2E,GACpC,GAAI6B,EAAS,CACX,MAAMC,EAAQvG,SAASwG,cAAc,OACrCD,EAAME,UAAYJ,EAAQ7B,SAEtB8B,EAAQG,YAAcF,EAAME,YAC9BH,EAAQG,UAAYF,EAAME,uBAIrBT,EAAKtB,QAAQD,MAK1ByB,OAAOQ,KAAKrE,EAAIL,QAAQqD,MAAMe,QAAQO,IAC/BhE,EAAM7C,cAAc6G,WAEhBtE,EAAIL,QAAQqD,KAAKsB,KA6B9B,MAAMZ,EAxBN,SAASa,EAAYC,EAAKC,EAAO,IAC/B,OAAO,IAAIC,MAAMF,EAAK,CACpBG,IAAK,SAAS7C,EAAQ8C,GACpB,GAAa,eAATA,EAAuB,OAAOH,EAAK7C,KAAK,KAC5C,MAAMvC,EAAQwF,QAAQF,OAAOhE,WAC7B,OAAc,OAAVtB,GAAmC,iBAAVA,GAA+B,YAATuF,EAC1CL,EAAYlF,EAAOoF,EAAKpD,OAAOuD,IAC5BvF,GAGdyF,IAAK,SAAShD,EAAQ8C,GACpB,MAAMG,EAAMF,QAAQC,OAAOnE,WAE3B,OADAiD,EAASa,EAAKpD,OAAOuD,GAAMhD,KAAK,MACzBmD,GAGTC,eAAgB,SAASlD,EAAQ8C,GAC/B,MAAMG,EAAMF,QAAQG,kBAAkBrE,WAEtC,OADAiD,EAASa,EAAKpD,OAAOuD,GAAMhD,KAAK,MACzBmD,KAKKR,CAAY,IAAKlB,KAAYtD,IAC/C,OAAO2D,EDlBauB,CAAQ,CAAEvH,GAAAA,EAAIsC,IAAAA,EAAKD,MAAAA,EAAOD,QAAAA,EAASuD,QAAAA,EAASC,SAAAA,EAAUrD,KAAAA,IAClEiF,EAAarF,EAASsF,QAAQjC,GAcpC,GEtDW,UAASrD,SAAEA,EAAQG,IAAEA,EAAGtC,GAAEA,EAAE0F,WAAEA,EAAUG,QAAEA,EAAOtD,KAAEA,IAChE,MAAMN,EAAUK,EAAIL,QAAQqD,KAAKtF,GAEjC0H,EAAUzF,KAAYgB,WACtB0E,EAAc1F,KAAYgB,WAE1Bd,EAASkB,eAAe,aAAa,SAASuE,GAASC,KAAMxF,IAQ3D,OAPA8D,OAAOC,QAAQ/D,GAAOgE,QAAQ,EAAEvE,EAAKgG,MACnC,GAAmB,mBAARA,EACT,MAAM,IAAI/F,MACR,yCAAyCQ,aAAgBqF,YAAgB9F,QAIxE,IAAIK,EAAS8B,WAClB3B,EAAIiD,UAAU,IACTG,EAAWkC,GACTvF,MAAAA,QAKX8D,OAAOC,QAAQP,GAASQ,QAAQ,EAAE9D,EAAMqC,KAAQzC,EAASkB,eAAed,EAAMqC,IAC9EzC,EAASkB,eAAe,MAAOvB,GAAO,IAAIK,EAAS8B,WAAW,iBAAiBnC,OFmB7EiG,CAAQ,CACN1F,MAAAA,EACAD,QAAAA,EACApC,GAAAA,EACA0F,WAAAA,EACAvD,SAAAA,EACA0D,QAAAA,EACA3D,KAAM8D,EACNzD,KAAAA,EACAD,IAAAA,IAGE,aAAcmD,EAAO,CACvB,MAAMuC,EAAMC,YAAY,KAClBrF,EAAM7C,cAAcC,KACtBkI,cAAcF,GACdvC,EAAM0C,SAAS,CAAE/F,QAAAA,EAASF,KAAM8D,EAAW3D,MAAAA,EAAOc,MAAOP,EAAMQ,SAASpD,OAEzE,IAGL,OAAO4C,EAAMzC,aAAaH,EAAIwH,EAAWxB,IAG3C,OAtDApF,EAAI8F,UAAYnB,EAAUR,GAsDnB,CACLQ,UAAAA,EACAtD,QAAAA"}