{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/helpers.js","../src/index.js","../src/watcher.js"],"sourcesContent":["export default {\n  findComponent: id => document.getElementById(id),\n  wrapTemplate: (id, html) => `<span id=\"${id}\">${html}</span>`,\n\n  findRefs(id) {\n    return Array.from(this.findComponent(id).querySelectorAll(\"[data-vbars-ref]\")).reduce(\n      (obj, $el) => {\n        obj[$el.dataset.vbarsRef] = $el;\n        return obj;\n      },\n      {}\n    );\n  },\n\n  name: \"Vbars\",\n\n  shouldRender(path, watchPath) {\n    if (path === watchPath) return true;\n    return this.getWildCard(path) === watchPath;\n  },\n\n  getWildCard(path) {\n    const segs = path.split(\".\").slice(0, -1);\n    segs.push(\"*\");\n    return segs.join(\".\");\n  },\n\n  randomId: () =>\n    \"_\" +\n    Math.random()\n      .toString(36)\n      .substr(2, 9),\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"./utils.js\";\nimport Vbars from \"./index.js\";\n\nexport default {\n  register({ id, instance, methods, components, proxyData, parentData, props }) {\n    const globalRef = {\n      handlers: {\n        bind: (event, path) => Utils.setKey(proxyData, path, event.currentTarget.value),\n      },\n      renders: {},\n    };\n\n    window[Utils.name] = window[Utils.name] || { components: {} };\n    window[Utils.name].components[id] = globalRef;\n\n    function _handler() {\n      const [eventType, ...args] = arguments;\n      const opts = args.splice(-1, 1);\n\n      if (args.some(arg => arg !== null && typeof arg === \"object\"))\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n\n      const handler = { methodName: opts[0].name, eventType, args };\n\n      return new instance.SafeString(\n        `on${eventType}=\"${Utils.name}.components.${id}.handlers.${handler.methodName}(${args.join(\n          \",\"\n        )})\"`\n      );\n    }\n\n    instance.registerHelper(\"debug\", obj => {\n      return new instance.SafeString(`<pre class=\"debug\">${JSON.stringify(obj, null, 2)}</pre>`);\n    });\n\n    instance.registerHelper(\"watch\", function(path, { fn }) {\n      const eId = Utils.randomId();\n      globalRef.renders[eId] = { render: fn.bind(null, proxyData), path };\n      return Utils.wrapTemplate(eId, fn(proxyData));\n    });\n\n    instance.registerHelper(\"watchEach\", function(arr, arrName, { fn }) {\n      return arr.map((item, index) => {\n        const eId = Utils.randomId();\n        globalRef.renders[eId] = {\n          render: fn.bind(null, item),\n          path: `${arrName}.${index}.*`,\n        };\n        return Utils.wrapTemplate(eId, fn(item));\n      });\n    });\n\n    Object.keys(components).forEach(name => {\n      instance.registerHelper(name, function(options) {\n        return new instance.SafeString(\n          Vbars.component({\n            ...components[name],\n            ...{ parentData: proxyData, props: options.hash },\n          })\n        );\n      });\n    });\n\n    instance.registerHelper(\"isChecked\", val => (val ? \"checked\" : \"\"));\n    instance.registerHelper(\"ref\", key => new instance.SafeString(`data-vbars-ref=\"${key}\"`));\n    instance.registerHelper(\n      \"bind\",\n      path =>\n        new instance.SafeString(\n          `oninput=\"${Utils.name}.components.${id}.handlers.bind(event, '${path}')\"`\n        )\n    );\n\n    // should throw an error if there is collision of method and comoponent name\n    Object.keys(methods).forEach(key => {\n      globalRef.handlers[key] = function() {\n        return methods[key].call(\n          methods,\n          { data: proxyData, parentData, props, $refs: Utils.findRefs(id), event },\n          ...arguments\n        );\n      };\n      instance.registerHelper(key, _handler);\n    });\n  },\n};\n","import Watcher from \"./watcher.js\";\nimport Helpers from \"./helpers.js\";\nimport Utils from \"./utils.js\";\n\nexport default {\n  component({\n    template,\n    data = {},\n    components = {},\n    methods = {},\n    parentData = {},\n    props = {},\n    hooks = {},\n    Handlebars = window.Handlebars,\n  }) {\n    if (!Handlebars) throw new Error(\"Vbars need Handlebars in order to run!\");\n\n    const id = Utils.randomId();\n    const instance = Handlebars.create();\n\n    // need to call created before building the proxy\n    if (hooks.created) hooks.created(...arguments);\n\n    const proxyData = Watcher(data, ({ path }) => {\n      const globalRef = window[Utils.name].components[id];\n\n      console.log(\"Vbars update:\", path);\n\n      Object.keys(globalRef.renders).forEach(eId => {\n        const handler = globalRef.renders[eId];\n\n        if (Utils.shouldRender(path, handler.path)) {\n          const $target = Utils.findComponent(eId);\n          if ($target) {\n            $target.innerHTML = handler.render();\n            console.log($target);\n          } else {\n            delete globalRef[eId];\n          }\n        }\n      });\n\n      setTimeout(() => {\n        Object.keys(window[Utils.name].components).forEach(cId => {\n          if (!Utils.findComponent(cId)) {\n            console.log(\"Vbars\", `removing handlers, and renders for ${cId}`);\n            delete window[Utils.name].components[cId];\n          }\n        });\n      }, 100);\n    });\n\n    const templateFn = instance.compile(template);\n\n    Helpers.register({ id, instance, methods, components, proxyData, parentData, props });\n\n    if (\"attached\" in hooks) {\n      const int = setInterval(() => {\n        if (Utils.findComponent(id)) {\n          clearInterval(int);\n          hooks.attached({\n            ...{ methods, data: proxyData, parentData, props },\n            ...{ $refs: Utils.findRefs(id) },\n          });\n        }\n      }, 100);\n    }\n\n    return Utils.wrapTemplate(id, templateFn(data));\n  },\n};\n","function buildProxy(raw, callback, tree = []) {\n  return new Proxy(raw, {\n    get: function(target, prop) {\n      const value = Reflect.get(...arguments);\n      if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n        return buildProxy(value, callback, tree.concat(prop));\n      else return value;\n    },\n\n    set: function(target, prop) {\n      const ret = Reflect.set(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n\n    deleteProperty: function(target, prop) {\n      const ret = Reflect.deleteProperty(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n  });\n}\n\nexport default buildProxy;\n"],"names":["findComponent","id","document","getElementById","wrapTemplate","html","[object Object]","Array","from","this","querySelectorAll","reduce","obj","$el","dataset","vbarsRef","name","path","watchPath","getWildCard","segs","split","slice","push","join","randomId","Math","random","toString","substr","value","arr","pointer","key","index","Error","length","instance","methods","components","proxyData","parentData","props","globalRef","handlers","bind","event","Utils","setKey","currentTarget","renders","_handler","eventType","args","arguments","opts","splice","some","arg","JSON","stringify","handler","methodName","SafeString","window","registerHelper","fn","eId","render","arrName","map","item","Object","keys","forEach","options","Vbars","component","hash","val","call","data","$refs","findRefs","template","hooks","Handlebars","create","created","buildProxy","raw","callback","tree","Proxy","get","target","prop","Reflect","concat","set","ret","deleteProperty","Watcher","shouldRender","$target","innerHTML","setTimeout","cId","templateFn","compile","Helpers","register","int","setInterval","clearInterval","attached"],"mappings":"kMAAe,CACbA,cAAeC,GAAMC,SAASC,eAAeF,GAC7CG,aAAc,CAACH,EAAII,IAAS,aAAaJ,MAAOI,WAEhDC,SAASL,GACP,OAAOM,MAAMC,KAAKC,KAAKT,cAAcC,GAAIS,iBAAiB,qBAAqBC,OAC7E,CAACC,EAAKC,KACJD,EAAIC,EAAIC,QAAQC,UAAYF,EACrBD,GAET,KAIJI,KAAM,QAENV,aAAaW,EAAMC,GACjB,OAAID,IAASC,GACNT,KAAKU,YAAYF,KAAUC,GAGpCZ,YAAYW,GACV,MAAMG,EAAOH,EAAKI,MAAM,KAAKC,MAAM,GAAI,GAEvC,OADAF,EAAKG,KAAK,KACHH,EAAKI,KAAK,MAGnBC,SAAU,IACR,IACAC,KAAKC,SACFC,SAAS,IACTC,OAAO,EAAG,GAEfvB,OAAOM,EAAKK,EAAMa,GAChB,MAAMC,EAAMd,EAAKI,MAAM,KACvBU,EAAIpB,OAAO,CAACqB,EAASC,EAAKC,KACxB,KAAMD,KAAOD,GAAU,MAAM,IAAIG,MAAM,GAAGlB,4BAAgCL,GAE1E,OADIsB,EAAQ,IAAMH,EAAIK,SAAQJ,EAAQC,GAAOH,GACtCE,EAAQC,IACdrB,OCpCQ,CACbN,UAASL,GAAEA,EAAEoC,SAAEA,EAAQC,QAAEA,EAAOC,WAAEA,EAAUC,UAAEA,EAASC,WAAEA,EAAUC,MAAEA,IACnE,MAAMC,EAAY,CAChBC,SAAU,CACRC,KAAM,CAACC,EAAO7B,IAAS8B,EAAMC,OAAOR,EAAWvB,EAAM6B,EAAMG,cAAcnB,QAE3EoB,QAAS,IAMX,SAASC,IACP,MAAOC,KAAcC,GAAQC,UACvBC,EAAOF,EAAKG,QAAQ,EAAG,GAE7B,GAAIH,EAAKI,KAAKC,GAAe,OAARA,GAA+B,iBAARA,GAC1C,MAAM,IAAIvB,MACR,uDAAuDwB,KAAKC,UAAUP,EAAM,KAAM,MAGtF,MAAMQ,EAAU,CAAEC,WAAYP,EAAK,GAAGvC,KAAMoC,UAAAA,EAAWC,KAAAA,GAEvD,OAAO,IAAIhB,EAAS0B,WAClB,KAAKX,MAAcL,EAAM/B,mBAAmBf,cAAe4D,EAAQC,cAAcT,EAAK7B,KACpF,UAhBNwC,OAAOjB,EAAM/B,MAAQgD,OAAOjB,EAAM/B,OAAS,CAAEuB,WAAY,IACzDyB,OAAOjB,EAAM/B,MAAMuB,WAAWtC,GAAM0C,EAoBpCN,EAAS4B,eAAe,QAASrD,GACxB,IAAIyB,EAAS0B,WAAW,sBAAsBJ,KAAKC,UAAUhD,EAAK,KAAM,aAGjFyB,EAAS4B,eAAe,SAAS,SAAShD,GAAMiD,GAAEA,IAChD,MAAMC,EAAMpB,EAAMtB,WAElB,OADAkB,EAAUO,QAAQiB,GAAO,CAAEC,OAAQF,EAAGrB,KAAK,KAAML,GAAYvB,KAAAA,GACtD8B,EAAM3C,aAAa+D,EAAKD,EAAG1B,OAGpCH,EAAS4B,eAAe,aAAa,SAASlC,EAAKsC,GAASH,GAAEA,IAC5D,OAAOnC,EAAIuC,IAAI,CAACC,EAAMrC,KACpB,MAAMiC,EAAMpB,EAAMtB,WAKlB,OAJAkB,EAAUO,QAAQiB,GAAO,CACvBC,OAAQF,EAAGrB,KAAK,KAAM0B,GACtBtD,KAAM,GAAGoD,KAAWnC,OAEfa,EAAM3C,aAAa+D,EAAKD,EAAGK,SAItCC,OAAOC,KAAKlC,GAAYmC,QAAQ1D,IAC9BqB,EAAS4B,eAAejD,GAAM,SAAS2D,GACrC,OAAO,IAAItC,EAAS0B,WAClBa,EAAMC,UAAU,IACXtC,EAAWvB,GACTyB,WAAYD,EAAWE,MAAOiC,EAAQG,aAMnDzC,EAAS4B,eAAe,YAAac,GAAQA,EAAM,UAAY,IAC/D1C,EAAS4B,eAAe,MAAOhC,GAAO,IAAII,EAAS0B,WAAW,mBAAmB9B,OACjFI,EAAS4B,eACP,OACAhD,GACE,IAAIoB,EAAS0B,WACX,YAAYhB,EAAM/B,mBAAmBf,2BAA4BgB,SAKvEuD,OAAOC,KAAKnC,GAASoC,QAAQzC,IAC3BU,EAAUC,SAASX,GAAO,WACxB,OAAOK,EAAQL,GAAK+C,KAClB1C,EACA,CAAE2C,KAAMzC,EAAWC,WAAAA,EAAYC,MAAAA,EAAOwC,MAAOnC,EAAMoC,SAASlF,GAAK6C,MAAAA,UAC9DQ,YAGPjB,EAAS4B,eAAehC,EAAKkB,SChFpB,CACb7C,WAAU8E,SACRA,EAAQH,KACRA,EAAO,GAAE1C,WACTA,EAAa,GAAED,QACfA,EAAU,GAAEG,WACZA,EAAa,GAAEC,MACfA,EAAQ,GAAE2C,MACVA,EAAQ,GAAEC,WACVA,EAAatB,OAAOsB,aAEpB,IAAKA,EAAY,MAAM,IAAInD,MAAM,0CAEjC,MAAMlC,EAAK8C,EAAMtB,WACXY,EAAWiD,EAAWC,SAGxBF,EAAMG,SAASH,EAAMG,WAAWlC,WAEpC,MAAMd,ECvBV,SAASiD,EAAWC,EAAKC,EAAUC,EAAO,IACxC,OAAO,IAAIC,MAAMH,EAAK,CACpBI,IAAK,SAASC,EAAQC,GACpB,MAAMlE,EAAQmE,QAAQH,OAAOxC,WAC7B,OAAc,OAAVxB,GAAmC,iBAAVA,GAA+B,YAATkE,EAC1CP,EAAW3D,EAAO6D,EAAUC,EAAKM,OAAOF,IACrClE,GAGdqE,IAAK,SAASJ,EAAQC,GACpB,MAAMI,EAAMH,QAAQE,OAAO7C,WAE3B,OADAqC,EAAS,CAAE1E,KAAM2E,EAAKM,OAAOF,GAAMxE,KAAK,OACjC4E,GAGTC,eAAgB,SAASN,EAAQC,GAC/B,MAAMI,EAAMH,QAAQI,kBAAkB/C,WAEtC,OADAqC,EAAS,CAAE1E,KAAM2E,EAAKM,OAAOF,GAAMxE,KAAK,OACjC4E,KDKSE,CAAQrB,EAAM,EAAGhE,KAAAA,MACjC,MAAM0B,EAAYqB,OAAOjB,EAAM/B,MAAMuB,WAAWtC,GAIhDuE,OAAOC,KAAK9B,EAAUO,SAASwB,QAAQP,IACrC,MAAMN,EAAUlB,EAAUO,QAAQiB,GAElC,GAAIpB,EAAMwD,aAAatF,EAAM4C,EAAQ5C,MAAO,CAC1C,MAAMuF,EAAUzD,EAAM/C,cAAcmE,GAChCqC,EACFA,EAAQC,UAAY5C,EAAQO,gBAGrBzB,EAAUwB,MAKvBuC,WAAW,KACTlC,OAAOC,KAAKT,OAAOjB,EAAM/B,MAAMuB,YAAYmC,QAAQiC,IAC5C5D,EAAM/C,cAAc2G,WAEhB3C,OAAOjB,EAAM/B,MAAMuB,WAAWoE,MAGxC,OAGCC,EAAavE,EAASwE,QAAQzB,GAIpC,GAFA0B,EAAQC,SAAS,CAAE9G,GAAAA,EAAIoC,SAAAA,EAAUC,QAAAA,EAASC,WAAAA,EAAYC,UAAAA,EAAWC,WAAAA,EAAYC,MAAAA,IAEzE,aAAc2C,EAAO,CACvB,MAAM2B,EAAMC,YAAY,KAClBlE,EAAM/C,cAAcC,KACtBiH,cAAcF,GACd3B,EAAM8B,SAAS,CACR7E,QAAAA,EAAS2C,KAAMzC,EAAWC,WAAAA,EAAYC,MAAAA,EACtCwC,MAAOnC,EAAMoC,SAASlF,OAG9B,KAGL,OAAO8C,EAAM3C,aAAaH,EAAI2G,EAAW3B"}