{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/event-handlers.js","../src/vbars-helpers.js","../src/index.js","../src/watcher.js","../src/v-dom.js"],"sourcesContent":["export default {\n  isKeyedNode($node) {\n    return $node.children.length\n      ? Array.from($node.children).every($child => $child.dataset.vbarsKey)\n      : false;\n  },\n\n  keyedChildren($node) {\n    return Array.from($node.children).filter($e => $e.dataset.vbarsKey);\n  },\n\n  swapNodes($source, $target) {\n    const $clone = $source.cloneNode(true);\n    $target.parentNode.replaceChild($clone, $target);\n    return $clone;\n  },\n\n  addChild($container, $child) {\n    const $clone = $child.cloneNode(true);\n    $container.appendChild($clone);\n    return $clone;\n  },\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"./utils.js\";\n\nexport default function({ $root, methods, proxyData }) {\n  return {\n    add($container) {\n      console.groupCollapsed(\"adding event handlers\");\n      console.log(\"container\", $container);\n\n      $container.querySelectorAll(\"[data-vbars-handler]\").forEach($el => {\n        const { eventType, methodName, args } = JSON.parse($el.dataset.vbarsHandler);\n        let [listener, ...augs] = eventType.split(\".\");\n\n        console.log({ listener, augs, methodName, $el });\n\n        // gonna have to store this to remove them when patching\n        $el.addEventListener(listener, event => {\n          if (augs.includes(\"prevent\")) {\n            event.stopPropagation();\n            event.preventDefault();\n          }\n\n          const $refs = Array.from($root.querySelectorAll(\"[data-vbars-ref]\")).reduce(\n            (obj, $el) => {\n              obj[$el.dataset.vbarsRef] = $el;\n              return obj;\n            },\n            {}\n          );\n\n          methods[methodName]({ event, data: proxyData, $root, $refs }, ...args);\n        });\n      });\n\n      $container.querySelectorAll(\"[data-vbars-bind]\").forEach($el => {\n        $el.addEventListener(\"input\", $event => {\n          Utils.setKey(proxyData, $el.dataset.vbarsBind, $event.currentTarget.value);\n        });\n      });\n\n      console.groupEnd();\n    },\n  };\n}\n","export default {\n  register({ instance, methods }) {\n    function _handler() {\n      const [eventType, ...args] = arguments;\n      const opts = args.splice(-1, 1);\n\n      if (args.some(arg => arg !== null && typeof arg === \"object\"))\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n\n      const handler = JSON.stringify({ methodName: opts[0].name, eventType, args });\n      return _addData({ handler });\n    }\n\n    const _addData = pairs => {\n      return new instance.SafeString(\n        Object.keys(pairs)\n          .map(key => `data-vbars-${key}='${pairs[key]}'`)\n          .join(\" \")\n      );\n    };\n\n    instance.registerHelper(\"watch\", (path, options) => {\n      const id = `${options.loc.start.column}${options.loc.start.line}${options.loc.end.column}${options.loc.end.line}`;\n      return _addData({ id, watch: path });\n    });\n\n    instance.registerHelper(\"keyed\", val => _addData({ key: val }));\n    instance.registerHelper(\"isChecked\", val => (val ? \"checked\" : \"\"));\n    instance.registerHelper(\"bind\", path => _addData({ bind: path }));\n    instance.registerHelper(\"ref\", key => _addData({ ref: key }));\n\n    Object.keys(methods).forEach(key => instance.registerHelper(key, _handler));\n  },\n};\n","import Watcher from \"./watcher.js\";\nimport VDom from \"./v-dom.js\";\nimport Helpers from \"./vbars-helpers.js\";\n\nexport default {\n  create({ template, data: rawData, methods = {} }) {\n    let $root, vDom;\n\n    const instance = window.Handlebars.create();\n    const proxyData = Watcher(rawData, ({ path }) => vDom.patch($root, path));\n    Helpers.register({ instance, methods });\n    const templateFn = instance.compile(template);\n\n    return {\n      instance,\n      data: proxyData,\n      render($target) {\n        $root = $target;\n        vDom = VDom({ $root, templateFn, proxyData, methods });\n        vDom.replace();\n      },\n    };\n  },\n};\n","function buildProxy(raw, callback, tree = []) {\n  return new Proxy(raw, {\n    get: function(target, prop) {\n      const value = Reflect.get(...arguments);\n      if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n        return buildProxy(value, callback, tree.concat(prop));\n      else return value;\n    },\n\n    set: function(target, prop) {\n      const ret = Reflect.set(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n\n    deleteProperty: function(target, prop) {\n      const ret = Reflect.deleteProperty(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n  });\n}\n\nexport default buildProxy;\n","import EventHandlers from \"./event-handlers.js\";\nimport Utils from \"./utils.js\";\n\nexport default function({ $root, templateFn, proxyData }) {\n  const $el = document.createElement(\"div\");\n  const Events = EventHandlers(...arguments);\n  const render = () => ($el.innerHTML = templateFn(proxyData));\n\n  function replace() {\n    render();\n    $root.innerHTML = $el.innerHTML;\n    Events.add($root);\n  }\n\n  function _compareKeys($vNode, $realNode) {\n    console.groupCollapsed(\"comparing keyed children\");\n    console.log(\"real parent\", $realNode);\n    console.log(\"virtual parent\", $vNode);\n\n    Utils.keyedChildren($realNode).forEach($e => {\n      const $v = $vNode.querySelector(`[data-vbars-key=\"${$e.dataset.vbarsKey}\"]`);\n      if (!$v) {\n        console.log(\"removing keyed node\", $e);\n        $e.remove();\n      } else if (!$v.isEqualNode($e)) {\n        console.log(\"swapping real\", $e);\n        console.log(\"with virual\", $v);\n        Events.add(Utils.swapNodes($v, $e));\n      }\n    });\n    // this is items that were added via push\n    Utils.keyedChildren($vNode).forEach($v => {\n      const $e = $realNode.querySelector(`[data-vbars-key=\"${$v.dataset.vbarsKey}\"]`);\n      if (!$e) {\n        console.log(\"could not find real node, adding\", $v);\n        Events.add(Utils.addChild($realNode, $v));\n      }\n    });\n\n    console.groupEnd();\n  }\n\n  function patch($target, path) {\n    console.groupCollapsed(`vDOM patching ${path}`);\n    render();\n\n    Array.from($el.querySelectorAll(\"[data-vbars-watch]\"))\n      .filter($e => path.startsWith($e.dataset.vbarsWatch))\n      .forEach($vNode => {\n        const $real = $target.querySelector(`[data-vbars-id=\"${$vNode.dataset.vbarsId}\"]`);\n        if (Utils.isKeyedNode($vNode)) {\n          _compareKeys($vNode, $real);\n        } else {\n          console.log(\"replacing\", $real);\n          console.log(\"with\", $vNode);\n          Events.add(Utils.swapNodes($vNode, $real));\n        }\n      });\n\n    console.groupEnd();\n  }\n\n  return {\n    $el,\n    render,\n    replace,\n    patch,\n  };\n}\n"],"names":["isKeyedNode","$node","children","length","Array","from","every","$child","dataset","vbarsKey","keyedChildren","filter","$e","[object Object]","$source","$target","$clone","cloneNode","parentNode","replaceChild","$container","appendChild","obj","path","value","arr","split","reduce","pointer","key","index","Error","$root","methods","proxyData","querySelectorAll","forEach","$el","eventType","methodName","args","JSON","parse","vbarsHandler","listener","augs","addEventListener","event","includes","stopPropagation","preventDefault","$refs","vbarsRef","data","$event","Utils","setKey","vbarsBind","currentTarget","instance","_handler","arguments","opts","splice","some","arg","stringify","handler","name","_addData","pairs","SafeString","Object","keys","map","join","registerHelper","options","id","loc","start","column","line","end","watch","val","bind","ref","template","rawData","vDom","window","Handlebars","create","buildProxy","raw","callback","tree","Proxy","get","target","prop","Reflect","concat","set","ret","deleteProperty","Watcher","patch","Helpers","register","templateFn","compile","document","createElement","Events","EventHandlers","render","innerHTML","replace","add","_compareKeys","$vNode","$realNode","$v","querySelector","isEqualNode","swapNodes","remove","addChild","startsWith","vbarsWatch","$real","vbarsId","VDom"],"mappings":"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"}