{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/event-handlers.js","../src/vbars-helpers.js","../src/index.js","../src/watcher.js","../src/v-dom.js"],"sourcesContent":["export default {\n  isKeyedNode($node) {\n    return $node.children.length\n      ? Array.from($node.children).every($child => $child.dataset.vbarsKey)\n      : false;\n  },\n\n  keyedChildren($node) {\n    return Array.from($node.children).filter($e => $e.dataset.vbarsKey);\n  },\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"./utils.js\";\n\nfunction _parseHandler($el) {\n  const { eventType, methodName, args } = JSON.parse($el.dataset.vbarsHandler);\n  let [listener, ...augs] = eventType.split(\".\");\n  return { listener, augs, methodName, args };\n}\n\nexport default function({ $root, methods, proxyData }) {\n  function _findHandlers($container, type) {\n    const $handlers = $container.querySelectorAll(`[data-vbars-${type.toLowerCase()}]`);\n    return $container.dataset[type] ? $handlers.concat($container) : $handlers;\n  }\n\n  const _bind = $event =>\n    Utils.setKey(proxyData, event.target.dataset.vbarsBind, $event.currentTarget.value);\n\n  function _handler(event) {\n    const $el = event.target;\n    const { augs, methodName, args } = _parseHandler($el);\n\n    if (augs.includes(\"prevent\")) event.preventDefault();\n    if (augs.includes(\"stop\")) event.stopPropagation();\n\n    const $refs = Array.from($root.querySelectorAll(\"[data-vbars-ref]\")).reduce((obj, $el) => {\n      obj[$el.dataset.vbarsRef] = $el;\n      return obj;\n    }, {});\n\n    methods[methodName]({ event, data: proxyData, $root, $refs }, ...args);\n  }\n\n  return {\n    remove($container) {\n      console.groupCollapsed(\"removing event handlers\");\n      console.log(\"container\", $container);\n\n      _findHandlers($container, \"Handler\").forEach($el => {\n        const { listener, methodName } = _parseHandler($el);\n        console.log({ listener, methodName, $el });\n        $el.removeEventListener(listener, _handler);\n      });\n\n      _findHandlers($container, \"Bind\").forEach($el => {\n        console.log({ type: \"input\", $el });\n        $el.removeEventListener(\"input\", _bind);\n      });\n      console.groupEnd();\n    },\n\n    add($container) {\n      console.groupCollapsed(\"adding event handlers\");\n      console.log(\"container\", $container);\n\n      _findHandlers($container, \"Handler\").forEach($el => {\n        const { listener, augs, methodName, args } = _parseHandler($el);\n        console.log({ listener, augs, methodName, args, $el });\n        $el.addEventListener(listener, _handler);\n      });\n\n      _findHandlers($container, \"Bind\").forEach($el => {\n        $el.addEventListener(\"input\", _bind);\n        console.log({ type: \"input\", $el });\n      });\n\n      console.groupEnd();\n    },\n  };\n}\n","export default {\n  register({ instance, methods }) {\n    function _handler() {\n      const [eventType, ...args] = arguments;\n      const opts = args.splice(-1, 1);\n\n      if (args.some(arg => arg !== null && typeof arg === \"object\"))\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n\n      const handler = JSON.stringify({ methodName: opts[0].name, eventType, args });\n      return _addData({ handler });\n    }\n\n    const _addData = pairs => {\n      return new instance.SafeString(\n        Object.keys(pairs)\n          .map(key => `data-vbars-${key}='${pairs[key]}'`)\n          .join(\" \")\n      );\n    };\n\n    instance.registerHelper(\"watch\", (path, options) => {\n      const id = `${options.loc.start.column}${options.loc.start.line}${options.loc.end.column}${options.loc.end.line}`;\n      return _addData({ id, watch: path });\n    });\n\n    instance.registerHelper(\"keyed\", val => _addData({ key: val }));\n    instance.registerHelper(\"isChecked\", val => (val ? \"checked\" : \"\"));\n    instance.registerHelper(\"bind\", path => _addData({ bind: path }));\n    instance.registerHelper(\"ref\", key => _addData({ ref: key }));\n\n    Object.keys(methods).forEach(key => instance.registerHelper(key, _handler));\n  },\n};\n","import VDom from \"./v-dom.js\";\nimport Watcher from \"./watcher.js\";\nimport Helpers from \"./vbars-helpers.js\";\n\nexport default {\n  create({ template, data: rawData, methods = {}, Handlebars = window.Handlebars }) {\n    let $root, vDom;\n\n    if (!Handlebars) throw new Error(\"Vbars need Handlebars in order to run!\");\n\n    const instance = Handlebars.create();\n    const proxyData = Watcher(rawData, ({ path }) => vDom.patch($root, path));\n    Helpers.register({ instance, methods });\n    const templateFn = instance.compile(template);\n\n    return {\n      VbarsComponent: true,\n      instance,\n      data: proxyData,\n      render($target) {\n        $root = $target;\n        vDom = VDom({ $root, templateFn, proxyData, methods });\n        vDom.replace();\n      },\n    };\n  },\n};\n","function buildProxy(raw, callback, tree = []) {\n  return new Proxy(raw, {\n    get: function(target, prop) {\n      const value = Reflect.get(...arguments);\n      if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n        return buildProxy(value, callback, tree.concat(prop));\n      else return value;\n    },\n\n    set: function(target, prop) {\n      const ret = Reflect.set(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n\n    deleteProperty: function(target, prop) {\n      const ret = Reflect.deleteProperty(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n  });\n}\n\nexport default buildProxy;\n","import EventHandlers from \"./event-handlers.js\";\nimport Utils from \"./utils.js\";\n\nexport default function({ $root, templateFn, proxyData }) {\n  const $el = document.createElement(\"div\");\n  const Events = EventHandlers(...arguments);\n  const render = () => ($el.innerHTML = templateFn(proxyData));\n\n  function replace() {\n    render();\n    $root.innerHTML = $el.innerHTML;\n    Events.add($root);\n  }\n\n  function _swapNodes($source, $target) {\n    const $clone = $source.cloneNode(true);\n    Events.remove($target);\n    $target.parentNode.replaceChild($clone, $target);\n    Events.add($clone);\n  }\n\n  function _addChild($container, $child) {\n    const $clone = $child.cloneNode(true);\n    $container.appendChild($clone);\n    Events.add($clone);\n  }\n\n  function _compareKeys($vNode, $realNode) {\n    console.groupCollapsed(\"comparing keyed children\");\n    console.log(\"real parent\", $realNode);\n    console.log(\"virtual parent\", $vNode);\n\n    Utils.keyedChildren($realNode).forEach($e => {\n      const $v = $vNode.querySelector(`[data-vbars-key=\"${$e.dataset.vbarsKey}\"]`);\n      if (!$v) {\n        console.log(\"removing keyed node\", $e);\n        Events.remove($e);\n        $e.remove();\n      } else if (!$v.isEqualNode($e)) {\n        console.log(\"swapping real\", $e);\n        console.log(\"with virual\", $v);\n        _swapNodes($v, $e);\n      }\n    });\n    // this is items that were added via push\n    Utils.keyedChildren($vNode).forEach($v => {\n      const $e = $realNode.querySelector(`[data-vbars-key=\"${$v.dataset.vbarsKey}\"]`);\n      if (!$e) {\n        console.log(\"could not find real node, adding\", $v);\n        _addChild($realNode, $v);\n      }\n    });\n\n    console.groupEnd();\n  }\n\n  function patch($target, path) {\n    console.groupCollapsed(`vDOM patching ${path}`);\n    render();\n\n    Array.from($el.querySelectorAll(\"[data-vbars-watch]\"))\n      .filter($e => path.startsWith($e.dataset.vbarsWatch))\n      .forEach($vNode => {\n        const $real = $target.querySelector(`[data-vbars-id=\"${$vNode.dataset.vbarsId}\"]`);\n        if (Utils.isKeyedNode($vNode)) {\n          _compareKeys($vNode, $real);\n        } else {\n          console.log(\"replacing\", $real);\n          console.log(\"with\", $vNode);\n          _swapNodes($vNode, $real);\n        }\n      });\n\n    console.groupEnd();\n  }\n\n  return {\n    $el,\n    render,\n    replace,\n    patch,\n  };\n}\n"],"names":["isKeyedNode","$node","children","length","Array","from","every","$child","dataset","vbarsKey","keyedChildren","filter","$e","[object Object]","obj","path","value","arr","split","reduce","pointer","key","index","Error","_parseHandler","$el","eventType","methodName","args","JSON","parse","vbarsHandler","listener","augs","$root","methods","proxyData","_findHandlers","$container","type","$handlers","querySelectorAll","toLowerCase","concat","_bind","$event","Utils","setKey","event","target","vbarsBind","currentTarget","_handler","includes","preventDefault","stopPropagation","$refs","vbarsRef","data","forEach","removeEventListener","addEventListener","instance","arguments","opts","splice","some","arg","stringify","handler","name","_addData","pairs","SafeString","Object","keys","map","join","registerHelper","options","id","loc","start","column","line","end","watch","val","bind","ref","template","rawData","Handlebars","window","vDom","create","buildProxy","raw","callback","tree","Proxy","get","prop","Reflect","set","ret","deleteProperty","Watcher","patch","Helpers","register","templateFn","compile","VbarsComponent","$target","document","createElement","Events","EventHandlers","render","innerHTML","replace","add","_swapNodes","$source","$clone","cloneNode","remove","parentNode","replaceChild","_addChild","appendChild","_compareKeys","$vNode","$realNode","$v","querySelector","isEqualNode","startsWith","vbarsWatch","$real","vbarsId","VDom"],"mappings":"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"}