{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/watcher.js","../src/helpers.js","../src/index.js"],"sourcesContent":["export default {\n  findComponent: id => document.getElementById(id),\n  wrapTemplate: (id, html) => `<span id=\"${id}\">${html}</span>`,\n\n  findRefs(id) {\n    return Array.from(this.findComponent(id).querySelectorAll(\"[data-vbars-ref]\")).reduce(\n      (obj, $el) => {\n        obj[$el.dataset.vbarsRef] = $el;\n        return obj;\n      },\n      {}\n    );\n  },\n\n  name: \"ReBars\",\n\n  shouldRender(path, watchPath) {\n    if (path === watchPath) return true;\n    return this.getWildCard(path) === watchPath;\n  },\n\n  getWildCard(path) {\n    const segs = path.split(\".\").slice(0, -1);\n    segs.push(\"*\");\n    return segs.join(\".\");\n  },\n\n  randomId: () =>\n    \"_\" +\n    Math.random()\n      .toString(36)\n      .substr(2, 9),\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"./utils.js\";\n\nexport default function({ id, storage, rawData }) {\n  function _handler(path) {\n    const cRef = storage.components[id];\n\n    console.log(\"Rebars update:\", path);\n\n    Object.keys(cRef.renders).forEach(eId => {\n      const handler = cRef.renders[eId];\n\n      if (Utils.shouldRender(path, handler.path)) {\n        const $target = Utils.findComponent(eId);\n        if ($target) {\n          $target.innerHTML = handler.render();\n          console.log($target);\n        } else {\n          delete storage.components[eId];\n        }\n      }\n    });\n\n    Object.keys(storage.components).forEach(cId => {\n      if (!Utils.findComponent(cId)) {\n        console.log(\"ReBars:\", `removing handlers, and renders for ${cId}`);\n        delete storage.components[cId];\n      }\n    });\n  }\n\n  function _buildProxy(raw, tree = []) {\n    return new Proxy(raw, {\n      get: function(target, prop) {\n        const value = Reflect.get(...arguments);\n        if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n          return _buildProxy(value, tree.concat(prop));\n        else return value;\n      },\n\n      set: function(target, prop) {\n        const ret = Reflect.set(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n\n      deleteProperty: function(target, prop) {\n        const ret = Reflect.deleteProperty(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n    });\n  }\n\n  return _buildProxy(rawData);\n}\n","import Utils from \"./utils.js\";\n\nexport default {\n  register({ id, instance, app, methods, components, proxyData, parentData, props }) {\n    const storage = app.storage.components[id];\n\n    storage.handlers.bind = (event, path) =>\n      Utils.setKey(proxyData, path, event.currentTarget.value);\n\n    const handlerPath = `${app.name}.storage.components.${id}.handlers`;\n\n    function _handler() {\n      const [eventType, ...args] = arguments;\n      const opts = args.splice(-1, 1);\n\n      if (args.some(arg => arg !== null && typeof arg === \"object\"))\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n\n      const handler = { methodName: opts[0].name, eventType, args };\n\n      return new instance.SafeString(\n        `on${eventType}=\"${handlerPath}.${handler.methodName}(${args.join(\",\")})\"`\n      );\n    }\n\n    instance.registerHelper(\"debug\", obj => {\n      return new instance.SafeString(`<pre class=\"debug\">${JSON.stringify(obj, null, 2)}</pre>`);\n    });\n\n    instance.registerHelper(\"watch\", function(path, { fn }) {\n      const eId = Utils.randomId();\n      storage.renders[eId] = { render: fn.bind(null, proxyData), path };\n      return Utils.wrapTemplate(eId, fn(proxyData));\n    });\n\n    instance.registerHelper(\"watchEach\", function(arr, arrName, { fn }) {\n      return arr.map((item, index) => {\n        const eId = Utils.randomId();\n        storage.renders[eId] = {\n          render: fn.bind(null, item),\n          path: `${arrName}.${index}.*`,\n        };\n        return Utils.wrapTemplate(eId, fn(item));\n      });\n    });\n\n    Object.keys(components).forEach(name => {\n      instance.registerHelper(name, function(options) {\n        return new instance.SafeString(\n          app.component({\n            ...components[name],\n            ...{ parentData: proxyData, props: options.hash },\n          })\n        );\n      });\n    });\n\n    instance.registerHelper(\"isChecked\", val => (val ? \"checked\" : \"\"));\n    instance.registerHelper(\"ref\", key => new instance.SafeString(`data-vbars-ref=\"${key}\"`));\n    instance.registerHelper(\n      \"bind\",\n      path => new instance.SafeString(`oninput=\"${handlerPath}.bind(event, '${path}')\"`)\n    );\n\n    // should throw an error if there is collision of method and comoponent name\n    Object.keys(methods).forEach(key => {\n      storage.handlers[key] = function() {\n        return methods[key].call(\n          methods,\n          { data: proxyData, parentData, props, $refs: Utils.findRefs(id), event },\n          ...arguments\n        );\n      };\n      instance.registerHelper(key, _handler);\n    });\n  },\n};\n","import Watcher from \"./watcher.js\";\nimport Helpers from \"./helpers.js\";\nimport Utils from \"./utils.js\";\n\nexport default function({ $el, name, root, Handlebars = window.Handlebars }) {\n  if (!Handlebars) throw new Error(\"ReBars need Handlebars in order to run!\");\n\n  const storage = { components: {} };\n  $el.innerHTML = component(root);\n\n  function component({\n    template,\n    data = {},\n    components = {},\n    methods = {},\n    parentData = {},\n    props = {},\n    hooks = {},\n  }) {\n    const id = Utils.randomId();\n    const instance = Handlebars.create();\n\n    // need to call created before building the proxy\n    if (hooks.created) hooks.created(...arguments);\n\n    storage.components[id] = {\n      handlers: {},\n      renders: {},\n    };\n\n    const proxyData = Watcher({ rawData: data, storage, id });\n    const templateFn = instance.compile(template);\n\n    Helpers.register({\n      id,\n      app: { storage, component, name },\n      instance,\n      methods,\n      components,\n      proxyData,\n      parentData,\n      props,\n    });\n\n    if (\"attached\" in hooks) {\n      const int = setInterval(() => {\n        if (Utils.findComponent(id)) {\n          clearInterval(int);\n          hooks.attached({\n            ...{ methods, data: proxyData, parentData, props },\n            ...{ $refs: Utils.findRefs(id) },\n          });\n        }\n      }, 10);\n    }\n\n    return Utils.wrapTemplate(id, templateFn(data));\n  }\n\n  return {\n    component,\n    storage,\n  };\n}\n"],"names":["findComponent","id","document","getElementById","wrapTemplate","html","[object Object]","Array","from","this","querySelectorAll","reduce","obj","$el","dataset","vbarsRef","name","path","watchPath","getWildCard","segs","split","slice","push","join","randomId","Math","random","toString","substr","value","arr","pointer","key","index","Error","length","storage","rawData","_handler","cRef","components","Object","keys","renders","forEach","eId","handler","Utils","shouldRender","$target","innerHTML","render","cId","_buildProxy","raw","tree","Proxy","get","target","prop","Reflect","arguments","concat","set","ret","deleteProperty","instance","app","methods","proxyData","parentData","props","handlers","bind","event","setKey","currentTarget","handlerPath","eventType","args","opts","splice","some","arg","JSON","stringify","methodName","SafeString","registerHelper","fn","arrName","map","item","options","component","hash","val","call","data","$refs","findRefs","root","Handlebars","window","template","hooks","create","created","Watcher","templateFn","compile","Helpers","register","int","setInterval","clearInterval","attached"],"mappings":"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"}