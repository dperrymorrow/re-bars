{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/event-handlers.js","../src/vbars-helpers.js","../src/index.js","../src/watcher.js","../src/v-dom.js"],"sourcesContent":["export default {\n  isKeyedNode($node) {\n    return $node.children.length\n      ? Array.from($node.children).every($child => $child.dataset.vbarsKey)\n      : false;\n  },\n\n  keyedChildren($node) {\n    return Array.from($node.children).filter($e => $e.dataset.vbarsKey);\n  },\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"./utils.js\";\n\nfunction _parseHandler($el) {\n  const { eventType, methodName, args } = JSON.parse($el.dataset.vbarsHandler);\n  let [listener, ...augs] = eventType.split(\".\");\n  return { listener, augs, methodName, args };\n}\n\nexport default function({ $root, methods, proxyData }) {\n  function _findHandlers($container) {\n    const $handlers = $container.querySelectorAll(\"[data-vbars-handler]\");\n    return $container.dataset.vbarsHandler ? $handlers.concat($container) : $handlers;\n  }\n\n  function _handler(event) {\n    const $el = event.target;\n    const { augs, methodName, args } = _parseHandler($el);\n\n    if (augs.includes(\"prevent\")) event.preventDefault();\n    if (augs.includes(\"stop\")) event.stopPropagation();\n\n    const $refs = Array.from($root.querySelectorAll(\"[data-vbars-ref]\")).reduce((obj, $el) => {\n      obj[$el.dataset.vbarsRef] = $el;\n      return obj;\n    }, {});\n\n    methods[methodName]({ event, data: proxyData, $root, $refs }, ...args);\n  }\n\n  return {\n    remove($container) {\n      console.groupCollapsed(\"removing event handlers\");\n      console.log(\"container\", $container);\n\n      _findHandlers($container).forEach($el => {\n        const { listener, methodName } = _parseHandler($el);\n        console.log({ listener, methodName, $el });\n        $el.removeEventListener(listener, _handler);\n      });\n      console.groupEnd();\n    },\n\n    add($container) {\n      console.groupCollapsed(\"adding event handlers\");\n      console.log(\"container\", $container);\n\n      _findHandlers($container).forEach($el => {\n        const { listener, augs, methodName, args } = _parseHandler($el);\n        console.log({ listener, augs, methodName, args, $el });\n        $el.addEventListener(listener, _handler);\n      });\n\n      $container.querySelectorAll(\"[data-vbars-bind]\").forEach($el => {\n        $el.addEventListener(\"input\", $event => {\n          Utils.setKey(proxyData, $el.dataset.vbarsBind, $event.currentTarget.value);\n        });\n      });\n\n      console.groupEnd();\n    },\n  };\n}\n","export default {\n  register({ instance, methods }) {\n    function _handler() {\n      const [eventType, ...args] = arguments;\n      const opts = args.splice(-1, 1);\n\n      if (args.some(arg => arg !== null && typeof arg === \"object\"))\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n\n      const handler = JSON.stringify({ methodName: opts[0].name, eventType, args });\n      return _addData({ handler });\n    }\n\n    const _addData = pairs => {\n      return new instance.SafeString(\n        Object.keys(pairs)\n          .map(key => `data-vbars-${key}='${pairs[key]}'`)\n          .join(\" \")\n      );\n    };\n\n    instance.registerHelper(\"watch\", (path, options) => {\n      const id = `${options.loc.start.column}${options.loc.start.line}${options.loc.end.column}${options.loc.end.line}`;\n      return _addData({ id, watch: path });\n    });\n\n    instance.registerHelper(\"keyed\", val => _addData({ key: val }));\n    instance.registerHelper(\"isChecked\", val => (val ? \"checked\" : \"\"));\n    instance.registerHelper(\"bind\", path => _addData({ bind: path }));\n    instance.registerHelper(\"ref\", key => _addData({ ref: key }));\n\n    Object.keys(methods).forEach(key => instance.registerHelper(key, _handler));\n  },\n};\n","import Watcher from \"./watcher.js\";\nimport VDom from \"./v-dom.js\";\nimport Helpers from \"./vbars-helpers.js\";\n\nexport default {\n  create({ template, data: rawData, methods = {} }) {\n    let $root, vDom;\n\n    const instance = window.Handlebars.create();\n    const proxyData = Watcher(rawData, ({ path }) => vDom.patch($root, path));\n    Helpers.register({ instance, methods });\n    const templateFn = instance.compile(template);\n\n    return {\n      instance,\n      data: proxyData,\n      render($target) {\n        $root = $target;\n        vDom = VDom({ $root, templateFn, proxyData, methods });\n        vDom.replace();\n      },\n    };\n  },\n};\n","function buildProxy(raw, callback, tree = []) {\n  return new Proxy(raw, {\n    get: function(target, prop) {\n      const value = Reflect.get(...arguments);\n      if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n        return buildProxy(value, callback, tree.concat(prop));\n      else return value;\n    },\n\n    set: function(target, prop) {\n      const ret = Reflect.set(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n\n    deleteProperty: function(target, prop) {\n      const ret = Reflect.deleteProperty(...arguments);\n      callback({ path: tree.concat(prop).join(\".\") });\n      return ret;\n    },\n  });\n}\n\nexport default buildProxy;\n","import EventHandlers from \"./event-handlers.js\";\nimport Utils from \"./utils.js\";\n\nexport default function({ $root, templateFn, proxyData }) {\n  const $el = document.createElement(\"div\");\n  const Events = EventHandlers(...arguments);\n  const render = () => ($el.innerHTML = templateFn(proxyData));\n\n  function replace() {\n    render();\n    $root.innerHTML = $el.innerHTML;\n    Events.add($root);\n  }\n\n  function _swapNodes($source, $target) {\n    const $clone = $source.cloneNode(true);\n    Events.remove($target);\n    $target.parentNode.replaceChild($clone, $target);\n    Events.add($clone);\n  }\n\n  function _addChild($container, $child) {\n    const $clone = $child.cloneNode(true);\n    $container.appendChild($clone);\n    Events.add($clone);\n  }\n\n  function _compareKeys($vNode, $realNode) {\n    console.groupCollapsed(\"comparing keyed children\");\n    console.log(\"real parent\", $realNode);\n    console.log(\"virtual parent\", $vNode);\n\n    Utils.keyedChildren($realNode).forEach($e => {\n      const $v = $vNode.querySelector(`[data-vbars-key=\"${$e.dataset.vbarsKey}\"]`);\n      if (!$v) {\n        console.log(\"removing keyed node\", $e);\n        Events.remove($e);\n        $e.remove();\n      } else if (!$v.isEqualNode($e)) {\n        console.log(\"swapping real\", $e);\n        console.log(\"with virual\", $v);\n        _swapNodes($v, $e);\n      }\n    });\n    // this is items that were added via push\n    Utils.keyedChildren($vNode).forEach($v => {\n      const $e = $realNode.querySelector(`[data-vbars-key=\"${$v.dataset.vbarsKey}\"]`);\n      if (!$e) {\n        console.log(\"could not find real node, adding\", $v);\n        _addChild($realNode, $v);\n      }\n    });\n\n    console.groupEnd();\n  }\n\n  function patch($target, path) {\n    console.groupCollapsed(`vDOM patching ${path}`);\n    render();\n\n    Array.from($el.querySelectorAll(\"[data-vbars-watch]\"))\n      .filter($e => path.startsWith($e.dataset.vbarsWatch))\n      .forEach($vNode => {\n        const $real = $target.querySelector(`[data-vbars-id=\"${$vNode.dataset.vbarsId}\"]`);\n        if (Utils.isKeyedNode($vNode)) {\n          _compareKeys($vNode, $real);\n        } else {\n          console.log(\"replacing\", $real);\n          console.log(\"with\", $vNode);\n          _swapNodes($vNode, $real);\n        }\n      });\n\n    console.groupEnd();\n  }\n\n  return {\n    $el,\n    render,\n    replace,\n    patch,\n  };\n}\n"],"names":["isKeyedNode","$node","children","length","Array","from","every","$child","dataset","vbarsKey","keyedChildren","filter","$e","[object Object]","obj","path","value","arr","split","reduce","pointer","key","index","Error","_parseHandler","$el","eventType","methodName","args","JSON","parse","vbarsHandler","listener","augs","$root","methods","proxyData","_findHandlers","$container","$handlers","querySelectorAll","concat","_handler","event","target","includes","preventDefault","stopPropagation","$refs","vbarsRef","data","forEach","removeEventListener","addEventListener","$event","Utils","setKey","vbarsBind","currentTarget","instance","arguments","opts","splice","some","arg","stringify","handler","name","_addData","pairs","SafeString","Object","keys","map","join","registerHelper","options","id","loc","start","column","line","end","watch","val","bind","ref","template","rawData","vDom","window","Handlebars","create","buildProxy","raw","callback","tree","Proxy","get","prop","Reflect","set","ret","deleteProperty","Watcher","patch","Helpers","register","templateFn","compile","$target","document","createElement","Events","EventHandlers","render","innerHTML","replace","add","_swapNodes","$source","$clone","cloneNode","remove","parentNode","replaceChild","_addChild","appendChild","_compareKeys","$vNode","$realNode","$v","querySelector","isEqualNode","startsWith","vbarsWatch","$real","vbarsId","VDom"],"mappings":"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"}