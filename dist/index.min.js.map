{"version":3,"file":"index.min.js","sources":["../src/utils.js","../src/watcher.js","../src/helpers/event-handlers.js","../src/helpers/re-renders.js","../src/helpers/index.js","../src/index.js"],"sourcesContent":["export default {\n  findComponent: id => document.getElementById(id),\n  wrapTemplate: (id, html) => `<span id=\"${id}\">${html}</span>`,\n\n  findRefs(id) {\n    return Array.from(this.findComponent(id).querySelectorAll(\"[data-rbs-ref]\")).reduce(\n      (obj, $el) => {\n        obj[$el.dataset.rbsRef] = $el;\n        return obj;\n      },\n      {}\n    );\n  },\n\n  shouldRender(path, watchPath) {\n    if (path === watchPath) return true;\n\n    const pathSegs = path.split(\".\");\n    const watchSegs = watchPath.split(\".\");\n\n    return watchSegs.every((seg, index) => {\n      if (seg === pathSegs[index] || seg === \"*\") return true;\n      return false;\n    });\n  },\n\n  randomId: () =>\n    \"_rbs_\" +\n    Math.random()\n      .toString(36)\n      .substr(2, 9),\n\n  setKey(obj, path, value) {\n    const arr = path.split(\".\");\n    arr.reduce((pointer, key, index) => {\n      if (!(key in pointer)) throw new Error(`${path} was not found in object`, obj);\n      if (index + 1 === arr.length) pointer[key] = value;\n      return pointer[key];\n    }, obj);\n  },\n};\n","import Utils from \"./utils.js\";\n\nexport default function({ id, app, parentData, props, data, watchers, name }) {\n  function _handler(path) {\n    const cRef = app.storage.components[id];\n    let matched = false;\n\n    Object.keys(watchers).forEach(watchPath => {\n      if (Utils.shouldRender(path, watchPath)) {\n        console.log(`ReBars: watcher \"${name}\"`, path);\n        console.log(watchPath);\n        matched = true;\n        watchers[watchPath].call(null, { data: proxyData, parentData, props });\n      }\n    });\n\n    Object.keys(cRef.renders).forEach(eId => {\n      const handler = cRef.renders[eId];\n\n      if (Utils.shouldRender(path, handler.path)) {\n        const $target = Utils.findComponent(eId);\n        if ($target) {\n          $target.innerHTML = handler.render();\n          console.log(`ReBars: re-render \"${name}\"`, path, $target);\n          matched = true;\n        } else {\n          delete app.storage.components[eId];\n        }\n      }\n    });\n\n    Object.keys(app.storage.components).forEach(cId => {\n      if (!Utils.findComponent(cId)) {\n        console.log(\"ReBars:\", `removing handlers, and renders for ${cId}`);\n        delete app.storage.components[cId];\n      }\n    });\n\n    if (matched) console.log(\"Memory Usage\", performance.memory.usedJSHeapSize.toLocaleString());\n  }\n\n  function _buildProxy(raw, tree = []) {\n    return new Proxy(raw, {\n      get: function(target, prop) {\n        if (prop === \"ReBarsPath\") return tree.join(\".\");\n        const value = Reflect.get(...arguments);\n        if (value !== null && typeof value === \"object\" && prop !== \"methods\")\n          return _buildProxy(value, tree.concat(prop));\n        else return value;\n      },\n\n      set: function(target, prop) {\n        const ret = Reflect.set(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n\n      deleteProperty: function(target, prop) {\n        const ret = Reflect.deleteProperty(...arguments);\n        _handler(tree.concat(prop).join(\".\"));\n        return ret;\n      },\n    });\n  }\n\n  const proxyData = _buildProxy(data);\n  return proxyData;\n}\n","import Utils from \"../utils.js\";\n\nexport default function(\n  storage,\n  { proxyData, instance, methods, id, watchers, parentData, props, app }\n) {\n  const handlerPath = `ReBars.apps.${app.id}.components.${id}.handlers`;\n\n  function _handler() {\n    const [eventType, methodName, ...args] = arguments;\n    args.splice(-1, 1);\n\n    const params = [methodName].concat(args).map(param => {\n      if (param !== null && typeof parm === \"object\")\n        throw new Error(\n          `must only pass primitives as argument to a handler. ${JSON.stringify(args, null, 2)}`\n        );\n      if (typeof param === \"string\") return `'${param}'`;\n      return param;\n    });\n\n    return new instance.SafeString(`on${eventType}=\"${handlerPath}.action(${params.join(\",\")})\"`);\n  }\n\n  storage.handlers.bind = (event, path) => Utils.setKey(proxyData, path, event.currentTarget.value);\n\n  storage.handlers.action = function() {\n    const [key, ...args] = arguments;\n\n    return methods[key].call(\n      null,\n      {\n        methods,\n        watchers,\n        data: proxyData,\n        parentData,\n        props,\n        $refs: Utils.findRefs(id),\n        event,\n      },\n      ...args\n    );\n  };\n\n  instance.registerHelper(\"method\", _handler);\n  instance.registerHelper(\n    \"bind\",\n    path => new instance.SafeString(`oninput=\"${handlerPath}.bind(event, '${path}')\"`)\n  );\n}\n","import Utils from \"../utils.js\";\n\nexport default function(storage, { instance, proxyData }) {\n  instance.registerHelper(\"watch\", function(path, { fn }) {\n    const eId = Utils.randomId();\n    storage.renders[eId] = { render: fn.bind(null, proxyData), path };\n    return Utils.wrapTemplate(eId, fn(proxyData));\n  });\n\n  instance.registerHelper(\"watchEach\", function(arr, { fn }) {\n    if (!Array.isArray(arr)) throw new Error(\"watchEach must be passed an Array\");\n    const path = arr.ReBarsPath;\n\n    return arr.map((item, index) => {\n      const eId = Utils.randomId();\n      storage.renders[eId] = {\n        render: fn.bind(null, item),\n        path: `${path}.${index}.*`,\n      };\n      return Utils.wrapTemplate(eId, fn(item));\n    });\n  });\n}\n","import EventHandlers from \"./event-handlers.js\";\nimport ReRenders from \"./re-renders.js\";\n\nexport default function({ instance, app, id, proxyData, components }) {\n  const storage = app.storage.components[id];\n\n  ReRenders(storage, ...arguments);\n  EventHandlers(storage, ...arguments);\n\n  instance.registerHelper(\"component\", function(name, { hash: props }) {\n    return new instance.SafeString(\n      app.component({\n        ...components[name],\n        ...{ parentData: proxyData, props },\n      })\n    );\n  });\n\n  instance.registerHelper(\"isChecked\", val => (val ? \"checked\" : \"\"));\n  instance.registerHelper(\"ref\", key => new instance.SafeString(`data-rbs-ref=\"${key}\"`));\n  instance.registerHelper(\n    \"debug\",\n    obj => new instance.SafeString(`<pre class=\"debug\">${JSON.stringify(obj, null, 2)}</pre>`)\n  );\n}\n","import Watcher from \"./watcher.js\";\nimport Helpers from \"./helpers/index.js\";\nimport Utils from \"./utils.js\";\n\nexport default function({ $el, root, Handlebars = window.Handlebars }) {\n  if (!Handlebars) throw new Error(\"ReBars need Handlebars in order to run!\");\n\n  window.ReBars = window.ReBars || {};\n  window.ReBars.apps = window.ReBars.apps || {};\n  const appId = Utils.randomId();\n  const storage = (window.ReBars.apps[appId] = { components: {} });\n  const app = { storage, component, id: appId };\n\n  $el.innerHTML = component(root);\n\n  function component({\n    template,\n    components = {},\n    methods = {},\n    parentData = {},\n    props = {},\n    hooks = {},\n    watchers = {},\n    data = {},\n    name,\n  }) {\n    const id = Utils.randomId();\n    const instance = Handlebars.create();\n\n    if (!name) throw new Error(\"Each ReBars component should have a name\");\n\n    storage.components[id] = {\n      handlers: {},\n      renders: {},\n      hooks,\n    };\n\n    // need to call created before building the proxy\n    if (hooks.created) hooks.created(...arguments);\n    const proxyData = Watcher({ id, app, parentData, props, data, watchers, name });\n    const templateFn = instance.compile(template);\n\n    Helpers({\n      id,\n      instance,\n      app,\n      methods,\n      components,\n      proxyData,\n      parentData,\n      props,\n      watchers,\n    });\n\n    if (\"attached\" in hooks) {\n      const int = setInterval(() => {\n        if (Utils.findComponent(id)) {\n          clearInterval(int);\n          hooks.attached({\n            ...{ watchers, methods, data: proxyData, parentData, props },\n            ...{ $refs: Utils.findRefs(id) },\n          });\n        }\n      }, 10);\n    }\n\n    return Utils.wrapTemplate(id, templateFn(proxyData));\n  }\n\n  return {\n    component,\n    storage,\n  };\n}\n"],"names":["findComponent","id","document","getElementById","wrapTemplate","html","[object Object]","Array","from","this","querySelectorAll","reduce","obj","$el","dataset","rbsRef","path","watchPath","pathSegs","split","every","seg","index","randomId","Math","random","toString","substr","value","arr","pointer","key","Error","length","app","parentData","props","data","watchers","name","_handler","cRef","storage","components","Object","keys","forEach","Utils","shouldRender","call","proxyData","renders","eId","handler","$target","innerHTML","render","cId","_buildProxy","raw","tree","Proxy","get","target","prop","join","Reflect","arguments","concat","set","ret","deleteProperty","instance","methods","handlerPath","handlers","bind","event","setKey","currentTarget","action","args","$refs","findRefs","registerHelper","eventType","methodName","splice","params","map","param","parm","JSON","stringify","SafeString","fn","isArray","ReBarsPath","item","ReRenders","EventHandlers","hash","component","val","root","Handlebars","window","ReBars","apps","appId","template","hooks","create","created","Watcher","templateFn","compile","Helpers","int","setInterval","clearInterval","attached"],"mappings":"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"}