!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";let e=1;var t={findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,t,n)=>{const{tag:r,...o}={tag:"span",class:"rbs-watch",...n};return`<${r} ${Object.entries(o).map(([e,t])=>`${e}="${t}"`).join(" ")} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},isKeyedNode:e=>Array.from(e.children).every(e=>e.dataset.rbsRef),normalizeHtml:e=>e.replace(new RegExp(/="rbs(.*?)"/g),""),isEqHtml(e,t){const n="string"==typeof e?this.getShadow(e):this.getShadow(e.innerHTML),r="string"==typeof t?this.getShadow(t):this.getShadow(t.innerHTML);return n.innerHTML=this.normalizeHtml(n.innerHTML),r.innerHTML=this.normalizeHtml(r.innerHTML),n.isEqualNode(r)},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t},tagComponent(e,t,n){const r=this.getShadow(t),o=r.firstElementChild;if(!o||!r.children||r.children.length>1||o.dataset.rbsWatch)throw new Error(`component:${n} must have one root node, and cannot be a {{#watch}}`);o.dataset.rbsComp=e;const a=r.innerHTML;return r.remove(),a},getStorage(e,t){return t?this.findByPath(window.ReBars,`apps.${e}.inst.${t}`):this.findByPath(window.ReBars,`apps.${e}`)},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.querySelector(`[data-rbs-ref="${t}"]`),findRefs(e){const t="object"==typeof e?e:this.findComponent(e);return Array.from(t.querySelectorAll("[data-rbs-ref]")).reduce((e,t)=>{const n=t.dataset.rbsRef,r=e[t.dataset.rbsRef];return e[n]=r?[r].concat(t):t,e},{})},findByPath:(e,t)=>t.split(".").reduce((e,t)=>e[t],e),getPath:(e,t)=>`rbs.apps.${e}.inst.${t}`,shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${e++}`,setKey(e,t,n){const r=t.split(".");r.reduce((o,a,s)=>{if(!(a in o))throw new Error(`${t} was not found in object`,e);return s+1===r.length&&(o[a]=n),o[a]},e)}};var n={init({watchers:e,appId:n,compId:r,name:o}){const a=t.getStorage(n,r),s=t.getStorage(n);return{patch(n){Object.keys(s.inst).forEach(e=>{t.findComponent(e)||delete s.inst[e]}),Object.keys(a.renders).forEach(e=>{t.findWatcher(e)||delete a.renders[e]}),function(n){Object.entries(e).forEach(([e,r])=>{t.shouldRender(n,e)&&r()})}(n),Object.entries(a.renders).forEach(([e,r])=>{if(!t.shouldRender(n,r.path))return;const o=t.findWatcher(e);if(!o)return;const a=r.render();if(t.isKeyedNode(o))return void function(e,n){const r=t.getShadow(n),o=Array.from(r.children);Array.from(e.children).forEach(e=>{const n=t.findRef(r,e.dataset.rbsRef);n?t.isEqHtml(n,e)||e.replaceWith(n.cloneNode(!0)):e.remove()}),o.forEach((n,r)=>{const o=n.dataset.rbsRef;if(!t.findRef(e,o)){const t=e.children[r];t?e.insertBefore(n.cloneNode(!0),t):e.append(n.cloneNode(!0))}}),o.forEach((t,n)=>{const r=t.dataset.rbsRef;e.children[n].dataset.rbsRef!==r&&e.children[n].replaceWith(t.cloneNode(!0))})}(o,a);if(n.endsWith(".length"),t.isEqHtml(o.innerHTML,a))return;const s={ref:document.activeElement.dataset.rbsRef,pos:document.activeElement.selectionStart};o.style.display=""===a?"none":"",o.innerHTML=a,function(e,n){const r=t.findRef(e,n.ref);r&&(Array.isArray(r)||(r.focus(),n.pos&&r.setSelectionRange(n.pos+1,n.pos+1)))}(o,s)})}}}},r={create({appId:e,compId:t,$props:r,data:o,methods:a,name:s}){let i=!1;const{patch:c}=n.init(...arguments);const d=function e(t,n=[]){return new Proxy(t,{get:function(t,r){if("ReBarsPath"===r)return n.join(".");const o=Reflect.get(...arguments);return"function"==typeof o&&t.hasOwnProperty(r)?o.bind(d):null!==o&&"object"==typeof o&&"methods"!==r?e(o,n.concat(r)):o},set:function(e,t){const r=Reflect.set(...arguments),o=n.concat(t).join(".");if(!i)throw new Error(`component:${s} set '${o}' before being added to the DOM. Usually caused by side effects from a hook or a data function, `);return c(o),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),o=n.concat(t).join(".");if(!i)throw new Error(`component:${s} deleted '${o}' before being added to the DOM. Usually caused by side effects from a hook or a data function`);return c(o),r}})}({...o,...r,methods:a,$_componentId:t,$_appId:e});return{watch:()=>i=!0,data:d}}};const o=(e,t=!0)=>{if(void 0===e)throw new Error(`have passed undefined to watch helper in component '${name}'`);return"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e},a=(e,n,{root:r})=>{const o=t.randomId();return t.getStorage(r.$_appId,r.$_componentId).renders[o]={path:e,render:n},o},s=e=>e.map(e=>{if(["[event]"].includes(e))return e.replace("[","").replace("]","");if(null!==e&&"object"==typeof e)throw new Error(`component:${name} must only pass primitives as argument to a handler. \n${JSON.stringify(e,null,2)}`);return"string"==typeof e?`'${e}'`:null===e?`${e}`:e});var i={register(e,{instance:n,helpers:r,name:i}){n.registerHelper("component",(function(r,{hash:o}){const a=t.getStorage(e).cDefs;if(!a[r])throw new Error(`component:${i} child component ${r} is not registered`);return new n.SafeString(a[r].render(o))})),Object.entries(r).forEach(([e,t])=>n.registerHelper(e,t)),n.registerHelper("ref",e=>new n.SafeString(`data-rbs-ref="${e}"`)),n.registerHelper("debug",(function(e,{data:r}){const s=()=>`<pre class="debug">${JSON.stringify(e,(e,t)=>"function"==typeof t?t+"":t,2)}</pre>`,i=a(o(e),s,r);return new n.SafeString(t.wrapWatcher(i,s()))})),n.registerHelper("watch",(function(...e){const{fn:n,hash:r,data:s}=e.pop(),i=e.map(e=>o(e,!1)).join(".").split(","),c=a(i,()=>n(this),s);return t.wrapWatcher(c,n(this),r)})),n.registerHelper("method",(function(){const[e,...t]=arguments,[r,o="click"]=e.split(":"),{data:a}=t.pop(),{$_appId:i,$_componentId:c}=a.root,d=s([i,c,r,"[event]"].concat(t));return new n.SafeString(`on${o}="rbs.handlers.trigger(${d.join(",")})"`)})),n.registerHelper("bound",(e,{hash:r={},data:o})=>{const{$_appId:a,$_componentId:i}=o.root,c=t.findByPath(o.root,e),d=r.ref||e,f=s([a,i,"[event]",e]);return new n.SafeString(`value="${c}" data-rbs-ref="${d}" oninput="rbs.handlers.bound(${f.join(",")})"`)})}};var c={create:function e(n,o,{name:a,template:s,data:c,helpers:d={},hooks:f={},methods:p={},watchers:h={},components:l=[]}){const u=t.getStorage(n);if(c=c||function(){return{}},!a)throw new Error("Each ReBars component should have a name");if("function"!=typeof c)throw new Error(`component:${a} data must be a function`);if("string"!=typeof s)throw new Error(`component:${a} needs a template string`);const m=o.create(),w=m.compile(s);return l.forEach(t=>{if(!t.name)throw new Error(`component:${a} child component needs a name`,t);u.cDefs[t.name]||(u.cDefs[t.name]=e(n,o,t))}),i.register(n,{instance:m,methods:p,helpers:d,name:a,components:l}),{render(e={}){const o=t.randomId(),s={$props:e,methods:p,name:a,watchers:h,data:c(),$refs:()=>t.findRefs(o)};s.methods=Object.entries(p).reduce((e,[t,n])=>(e[t]=n.bind(s),e),{}),Object.entries(e).forEach(([t,n])=>{"function"==typeof n&&(s.methods[t]=n,delete e[t])}),s.watchers=Object.entries(h).reduce((e,[t,n])=>(e[t]=n.bind(s),e),{}),u.inst[o]={scope:s,renders:{}},f.created&&f.created.call(s);const i=r.create({...s,appId:n,compId:o});s.data=i.data;const d=t.tagComponent(o,w(s.data),a);return i.watch(),d}}}};return function({$el:e,root:n,Handlebars:r=window.Handlebars}){if(!r)throw new Error("ReBars need Handlebars in order to run!");window.rbs=window.ReBars=window.ReBars||{},window.ReBars.apps=window.ReBars.apps||{},window.ReBars.handlers=window.ReBars.handlers||{trigger(...e){const[n,r,o,...a]=e,s=t.getStorage(n,r).scope,i=s.methods[o];if(!i)throw new Error(`component:${s.name} ${o} is not a defined method`);i(...a)},bound(e,n,r,o){const a=t.getStorage(e,n).scope;t.setKey(a.data,o,r.target.value)}};const o=t.randomId(),a=window.ReBars.apps[o]={cDefs:{},inst:{}};if(!document.body.contains(e))throw new Error("$el must be present in the document");return e.innerHTML=c.create(o,r,n).render(),{id:o,storage:a}}}));
//# sourceMappingURL=index.min.js.map
