!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";var e={noName:()=>"Each ReBars component should have a name",dataFn:({name:e}={})=>`component:${e} must be a function`,tplStr:({name:e}={})=>`component:${e} needs a template string`,propStomp:({name:e,key:t}={})=>`component:${e} data.${t} was overrode by props`,propUndef:({name:e,key:t}={})=>`component:${e} was passed undefined for prop "${t}"`,oneRoot:({name:e}={})=>`component:${e} must have one root node, and cannot be a {{#watch}} block`,noEl:()=>"$el must be present in the document",noHbs:()=>"ReBars need Handlebars in order to run!",noMethod:({name:e,methodName:t}={})=>`component:${e} does not have a method named "${t}"`,badPath:({path:e}={})=>`${e} was not found in object`,warn(e,t){},fail(e,t){throw new Error(this[e](t))}};let t=1;var n={findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,t,n)=>{const{tag:r,...o}={tag:"span",class:"rbs-watch",...n};return`<${r} ${Object.entries(o).map(([e,t])=>`${e}="${t}"`).join(" ")} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},isKeyedNode:e=>Array.from(e.children).every(e=>e.dataset.rbsRef),normalizeHtml:e=>e.replace(new RegExp(/="rbs(.*?)"/g),""),isEqHtml(e,t){const n="string"==typeof e?this.getShadow(e):this.getShadow(e.innerHTML),r="string"==typeof t?this.getShadow(t):this.getShadow(t.innerHTML);return n.innerHTML=this.normalizeHtml(n.innerHTML),r.innerHTML=this.normalizeHtml(r.innerHTML),n.isEqualNode(r)},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t},pick:(e,t)=>t.reduce((t,n)=>(t[n]=e[n],t),{}),tagComponent(t,n,r){const o=this.getShadow(n),a=o.firstElementChild;(!a||!o.children||o.children.length>1||a.dataset.rbsWatch)&&e.fail("oneRoot",{name:r}),a.dataset.rbsComp=t;const s=o.innerHTML;return o.remove(),s},getStorage(e,t){return t?this.findByPath(window.ReBars,`apps.${e}.inst.${t}`):this.findByPath(window.ReBars,`apps.${e}`)},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.querySelector(`[data-rbs-ref="${t}"]`),findRefs(e){const t="object"==typeof e?e:this.findComponent(e);return Array.from(t.querySelectorAll("[data-rbs-ref]")).reduce((e,t)=>{const n=t.dataset.rbsRef,r=e[t.dataset.rbsRef];return e[n]=r?[r].concat(t):t,e},{})},findByPath:(e,t)=>t.split(".").reduce((e,t)=>e[t],e),getPath:(e,t)=>`rbs.apps.${e}.inst.${t}`,shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${t++}`,setKey(t,n,r){const o=n.split(".");o.reduce((a,s,d)=>(s in a||e.fail("badPath",{path:n},t),d+1===o.length&&(a[s]=r),a[s]),t)}};var r={init({watchers:e,appId:t,compId:r,name:o}){const a=n.getStorage(t,r),s=n.getStorage(t);return{patch(t){Object.keys(s.inst).forEach(e=>{n.findComponent(e)||delete s.inst[e]}),Object.keys(a.renders).forEach(e=>{n.findWatcher(e)||delete a.renders[e]}),function(t){Object.entries(e).forEach(([e,r])=>{n.shouldRender(t,e)&&r()})}(t),Object.entries(a.renders).forEach(([e,r])=>{if(!n.shouldRender(t,r.path))return;const o=n.findWatcher(e);if(!o)return;const a=r.render();if(n.isKeyedNode(o))return void function(e,t){const r=n.getShadow(t),o=Array.from(r.children);Array.from(e.children).forEach(e=>{const t=n.findRef(r,e.dataset.rbsRef);t?n.isEqHtml(t,e)||e.replaceWith(t.cloneNode(!0)):e.remove()}),o.forEach((t,r)=>{const o=t.dataset.rbsRef;if(!n.findRef(e,o)){const n=e.children[r];n?e.insertBefore(t.cloneNode(!0),n):e.append(t.cloneNode(!0))}}),o.forEach((t,n)=>{const r=t.dataset.rbsRef;e.children[n].dataset.rbsRef!==r&&e.children[n].replaceWith(t.cloneNode(!0))})}(o,a);if(t.endsWith(".length"),n.isEqHtml(o.innerHTML,a))return;const s={ref:document.activeElement.dataset.rbsRef,pos:document.activeElement.selectionStart};o.style.display=""===a?"none":"",o.innerHTML=a,function(e,t){const r=n.findRef(e,t.ref);r&&(Array.isArray(r)||(r.focus(),t.pos&&r.setSelectionRange(t.pos+1,t.pos+1)))}(o,s)})}}}},o={create({appId:e,compId:t,$props:n,data:o,methods:a,name:s}){let d=!1;const{patch:i}=r.init(...arguments);const c=function e(t,n=[]){return new Proxy(t,{get:function(t,r){if("ReBarsPath"===r)return n.join(".");const o=Reflect.get(...arguments);return"function"==typeof o&&t.hasOwnProperty(r)?o.bind(c):null!==o&&"object"==typeof o&&"methods"!==r?e(o,n.concat(r)):o},set:function(e,t){const r=Reflect.set(...arguments),o=n.concat(t).join(".");if(!d)throw new Error(`component:${s} set '${o}' before being added to the DOM. Usually caused by side effects from a hook or a data function, `);return i(o),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),o=n.concat(t).join(".");if(!d)throw new Error(`component:${s} deleted '${o}' before being added to the DOM. Usually caused by side effects from a hook or a data function`);return i(o),r}})}({...o,...n,methods:a,$_componentId:t,$_appId:e});return{watch:()=>d=!0,data:c}}};const a=(e,t=!0)=>{if(void 0===e)throw new Error(`have passed undefined to watch helper in component '${name}'`);return"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e},s=(e,t,{root:r})=>{const o=n.randomId();return n.getStorage(r.$_appId,r.$_componentId).renders[o]={path:e,render:t},o},d=e=>e.map(e=>{if(["[event]"].includes(e))return e.replace("[","").replace("]","");if(null!==e&&"object"==typeof e)throw new Error(`component:${name} must only pass primitives as argument to a handler. \n${JSON.stringify(e,null,2)}`);return"string"==typeof e?`'${e}'`:null===e?`${e}`:e});var i={register(e,{instance:t,helpers:r,name:o}){t.registerHelper("component",(function(r,{hash:a}){const s=n.getStorage(e).cDefs;if(!s[r])throw new Error(`component:${o} child component ${r} is not registered`);return new t.SafeString(s[r].instance(a).render())})),Object.entries(r).forEach(([e,n])=>t.registerHelper(e,n)),t.registerHelper("ref",e=>new t.SafeString(`data-rbs-ref="${e}"`)),t.registerHelper("debug",(function(e,{data:r}){const o=()=>`<pre class="debug">${JSON.stringify(e,(e,t)=>"function"==typeof t?t+"":t,2)}</pre>`,d=s(a(e),o,r);return new t.SafeString(n.wrapWatcher(d,o()))})),t.registerHelper("watch",(function(...e){const{fn:t,hash:r,data:o}=e.pop(),d=e.map(e=>a(e,!1)).join(".").split(","),i=s(d,()=>t(this),o);return n.wrapWatcher(i,t(this),r)})),t.registerHelper("method",(function(){const[e,...n]=arguments,[r,o="click"]=e.split(":"),{data:a}=n.pop(),{$_appId:s,$_componentId:i}=a.root,c=d([s,i,r,"[event]"].concat(n));return new t.SafeString(`on${o}="rbs.handlers.trigger(${c.join(",")})"`)})),t.registerHelper("bound",(e,{hash:r={},data:o})=>{const{$_appId:a,$_componentId:s}=o.root,i=n.findByPath(o.root,e),c=r.ref||e,p=d([a,s,"[event]",e]);return new t.SafeString(`value="${i}" data-rbs-ref="${c}" oninput="rbs.handlers.bound(${p.join(",")})"`)})}};var c={register:function t(r,a,{name:s,template:d,data:c,helpers:p={},hooks:f={},methods:h={},watchers:l={},components:m=[]}){const u=n.getStorage(r);c=c||function(){return{}},s||e.fail("noName",{def:arguments[2]}),"function"!=typeof c&&e.fail("dataFn",{name:s}),"string"!=typeof d&&e.fail("tmplStr",{name:s});const g=a.create(),w=g.compile(d);return m.forEach(n=>{n.name||e.fail("noName",{def:n}),u.cDefs[n.name]||(u.cDefs[n.name]=t(r,a,n))}),i.register(r,{instance:g,methods:h,helpers:p,name:s,components:m}),{instance(t={}){const a=n.randomId(),d={$props:t,methods:h,hooks:f,name:s,watchers:l,data:c(),$refs:()=>n.findRefs(a)};d.methods=Object.entries(h).reduce((e,[t,n])=>(e[t]=n.bind(d),e),{}),Object.entries(t).forEach(([n,r])=>{void 0===r&&e.warn("propUndef",{name:s,key:n}),"function"==typeof r&&(d.methods[n]=r,delete t[n]),n in d.data&&e.warn("propStomp",{name:s,key:n})}),d.watchers=Object.entries(l).reduce((e,[t,n])=>(e[t]=n.bind(d),e),{}),u.inst[a]={scope:d,renders:{}},f.created&&f.created.call(d);const i=o.create({...d,appId:r,compId:a});return d.data=i.data,{...d,proxyInst:i,render(){const e=n.tagComponent(a,w(d.data),s);return i.watch(),e}}}}}};return function({$el:t,root:r,Handlebars:o=window.Handlebars}){o||e.fail("noHbs"),window.rbs=window.ReBars=window.ReBars||{},window.ReBars.apps=window.ReBars.apps||{},window.ReBars.handlers=window.ReBars.handlers||{trigger(...t){const[r,o,a,...s]=t,d=n.getStorage(r,o).scope,i=d.methods[a];i||e.fail("noMethod",{name:d.name,methodName:a}),i(...s)},bound(e,t,r,o){const a=n.getStorage(e,t).scope;n.setKey(a.data,o,r.target.value)}};const a=n.randomId(),s=window.ReBars.apps[a]={cDefs:{},inst:{}};return document.body.contains(t)||e.fail("noEl"),t.innerHTML=c.register(a,o,r).instance().render(),{id:a,storage:s}}}));
//# sourceMappingURL=index.min.js.map
