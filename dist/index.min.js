!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).ReBars=n()}(this,(function(){"use strict";const e=(e,t,r={},...o)=>{let a=n[t](r);if(!["warn","log"].includes(e))throw o&&window.rbs.trace&&o.forEach(e=>{}),new Error(a);a="%c "+a+" ",window.ReBars.trace&&o&&o.forEach(e=>{})},n={noEl:()=>"$el must be present in the document",noHbs:()=>"ReBars need Handlebars in order to run!",noName:()=>"Each ReBars component should have a name",dataFn:({name:e})=>`component:${e} must be a function`,tplStr:({name:e})=>`component:${e} needs a template string`,propStomp:({name:e,key:n})=>`component:${e} "data.${n}" was overrode by a prop`,propUndef:({name:e,key:n})=>`component:${e} was passed undefined for prop "${n}"`,oneRoot:({name:e})=>`component:${e} must have one root node, and cannot be a {{#watch}} block`,noMethod:({name:e,methodName:n})=>`component:${e} does not have a method named "${n}"`,badPath:({path:e})=>`${e} was not found in object`,reRender:({name:e,path:n})=>`component:${e} re-rendering "${n}"`,patching:({name:e,path:n})=>`component:${e} patching ref Array "${n}"`,pathTrigger:({path:e,action:n,name:t})=>`component:${t} ${n} "${e}"`,triggered:({name:e,paths:n})=>`component:${e} data change "${n}"`,preRenderChange:({name:e,path:n})=>`component:${e} set '${n}' before being added to the DOM. Usually caused by side effects from a hook or a data function`,focusFail:({ref:e,name:n})=>`component:${n} ref "${e}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each`,notKeyed:({name:e,path:n})=>`component:${e} patching "${n}" add a {{ ref }} to avoid re-rendering the entire target`};var t={messages:n,warn:e.bind(null,"warn"),fail:e.bind(null,"throw"),log:e.bind(null,"log")};let r=1;var o={dom:{tagComponent(e,n,r){const o=this.getShadow(n),a=o.firstElementChild;(!a||!o.children||o.children.length>1||a.dataset.rbsWatch)&&t.fail("oneRoot",{name:r},o),a.dataset.rbsComp=e;const s=o.innerHTML;return o.remove(),s},restoreCursor(e,n){const r=this.findRef(e,n.ref);r&&(Array.isArray(r)?t.warn("focusFail",{ref:n.ref,name:name},r):(r.focus(),n.pos&&r.setSelectionRange(n.pos+1,n.pos+1)))},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,n)=>e.querySelector(`[data-rbs-ref="${n}"]`),findRefs(e){const n="object"==typeof e?e:this.findComponent(e);return Array.from(n.querySelectorAll("[data-rbs-ref]")).reduce((e,n)=>{const t=n.dataset.rbsRef,r=e[n.dataset.rbsRef];return e[t]=r?[r].concat(n):n,e},{})},findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,n,t)=>{const{tag:r,...o}={tag:"span",class:"rbs-watch",...t};return`<${r} ${Object.entries(o).map(([e,n])=>`${e}="${n}"`).join(" ")} ${n.length?"":"style='display:none;'"} data-rbs-watch="${e}">${n}</${r}>`},isKeyedNode:e=>Array.from(e.children).every(e=>e.dataset.rbsRef),normalizeHtml:e=>e.replace(new RegExp(/="rbs(.*?)"/g),""),isEqHtml(e,n){const t="string"==typeof e?this.getShadow(e):this.getShadow(e.innerHTML),r="string"==typeof n?this.getShadow(n):this.getShadow(n.innerHTML);return t.innerHTML=this.normalizeHtml(t.innerHTML),r.innerHTML=this.normalizeHtml(r.innerHTML),t.isEqualNode(r)},getShadow(e){const n=document.createElement("div");return n.innerHTML=e,n}},deleteOrphans(e,n){const t=this.getStorage(e,n),r=this.getStorage(e);Object.keys(r.inst).forEach(e=>{this.dom.findComponent(e)||delete r.inst[e]}),Object.keys(t.renders).forEach(e=>{this.dom.findWatcher(e)||delete t.renders[e]})},bindAll:(e,n)=>Object.entries(n).reduce((n,[t,r])=>(n[t]=r.bind(e),n),{}),debounce(e,n,t=!1){let r=null;return function(){const o=t&&!r,a=()=>e.apply(this,arguments);clearTimeout(r),r=setTimeout(a,n),o&&a()}},getStorage(e,n){return n?this.findByPath(window.ReBars,`apps.${e}.inst.${n}`):this.findByPath(window.ReBars,`apps.${e}`)},findByPath:(e,n)=>n.split(".").reduce((e,n)=>e[n],e),shouldRender:(e,n)=>(Array.isArray(n)?n:[n]).some(n=>{if(e===n||".*"===n)return!0;const t=e.split(".");return n.split(".").every((e,n)=>e===t[n]||"*"===e)}),randomId:()=>`rbs${r++}`,setKey(e,n,r){const o=n.split(".");o.reduce((a,s,d)=>(s in a||t.fail("badPath",{path:n},e),d+1===o.length&&(a[s]=r),a[s]),e)}},a={init({watchers:e,appId:n,compId:r,name:a}){const s=o.getStorage(n,r);const d=[],i={watchers:{},renders:{}},c=o.debounce(()=>{t.log("triggered",{name:a,paths:d.join(",")},i),d.length=0,Object.entries(i.watchers).forEach(([e,n])=>{delete i.watchers[e],n()}),Object.entries(i.renders).forEach(([e,n])=>{const r=o.dom.findWatcher(e);if(!r)return;const s=n.render();if(o.dom.isEqHtml(r.innerHTML,s))return;if(o.dom.isKeyedNode(r))return function(e,n){const t=o.dom.getShadow(n),r=Array.from(t.children);Array.from(e.children).forEach(e=>{const n=o.dom.findRef(t,e.dataset.rbsRef);n?o.dom.isEqHtml(n,e)||e.replaceWith(n.cloneNode(!0)):e.remove()}),r.forEach((n,t)=>{const r=n.dataset.rbsRef;if(!o.dom.findRef(e,r)){const r=e.children[t];r?e.insertBefore(n.cloneNode(!0),r):e.append(n.cloneNode(!0))}}),r.forEach((n,t)=>{const r=n.dataset.rbsRef,o=e.children[t];o&&o.dataset.rbsRef!==r&&e.children[t].replaceWith(n.cloneNode(!0))})}(r,s),t.log("patching",{name:a,path:n.path},r),void delete i.renders[e];const d=n.matching.find(e=>e.endsWith(".length"));d&&t.warn("notKeyed",{name:a,path:d},r);const c={ref:document.activeElement.dataset.rbsRef,pos:document.activeElement.selectionStart};r.style.display=""===s?"none":"",r.innerHTML=s,o.dom.restoreCursor(r,c),t.log("reRender",{name:a,path:n.path},r)})},0);return{que(t){o.deleteOrphans(n,r),Object.entries(e).forEach(([e,n])=>{o.shouldRender(t,e)&&(i.watchers[e]=n)}),Object.entries(s.renders).forEach(([e,n])=>{o.shouldRender(t,n.path)&&(e in i.renders||(i.renders[e]={...n,matching:[t]}),i.renders[e].matching.push(t))}),d.push(t),c()}}}},s={create({appId:e,compId:n,$props:r,data:o,methods:s,name:d}){let i=!1;const{que:c}=a.init(...arguments);const p=function e(n,r=[]){return new Proxy(n,{get:function(n,t){if("ReBarsPath"===t)return r.join(".");const o=Reflect.get(...arguments);return"function"==typeof o&&n.hasOwnProperty(t)?o.bind(p):null!==o&&"object"==typeof o&&"methods"!==t?e(o,r.concat(t)):o},set:function(e,n){const o=Reflect.set(...arguments),a=r.concat(n).join(".");return i||t.fail("preRenderChange",{name:d,path:a}),c(a),o},deleteProperty:function(e,n){const o=Reflect.deleteProperty(...arguments),a=r.concat(n).join(".");return i||t.fail("preRenderChange",{name:d,path:a}),c(a),o}})}({...o,...r,methods:s,$_componentId:n,$_appId:e});return{watch:()=>i=!0,data:p}}};const d=(e,n=!0)=>{if(void 0===e)throw new Error(`have passed undefined to watch helper in component '${name}'`);return"object"==typeof e?`${e.ReBarsPath}${n?".*":""}`:e},i=(e,n,{root:t})=>{const r=o.randomId();return o.getStorage(t.$_appId,t.$_componentId).renders[r]={path:e,render:n},r},c=e=>e.map(e=>{if(["[event]"].includes(e))return e.replace("[","").replace("]","");if(null!==e&&"object"==typeof e)throw new Error(`component:${name} must only pass primitives as argument to a handler. \n${JSON.stringify(e,null,2)}`);return"string"==typeof e?`'${e}'`:null===e?`${e}`:e});var p={register(e,{instance:n,helpers:t,name:r}){n.registerHelper("component",(function(t,{hash:a}){const s=o.getStorage(e).cDefs;if(!s[t])throw new Error(`component:${r} child component ${t} is not registered`);return new n.SafeString(s[t].instance(a).render())})),Object.entries(t).forEach(([e,t])=>n.registerHelper(e,t)),n.registerHelper("ref",e=>new n.SafeString(`data-rbs-ref="${e}"`)),n.registerHelper("debug",(function(e,{data:t}){const r=()=>`<pre class="debug">${JSON.stringify(e,(e,n)=>"function"==typeof n?n+"":n,2)}</pre>`,a=i(d(e),r,t);return new n.SafeString(o.dom.wrapWatcher(a,r()))})),n.registerHelper("watch",(function(...e){const{fn:n,hash:t,data:r}=e.pop(),a=e.map(e=>d(e,!1)).join(".").split(","),s=i(a,()=>n(this),r);return o.dom.wrapWatcher(s,n(this),t)})),n.registerHelper("method",(function(){const[e,...t]=arguments,[r,o="click"]=e.split(":"),{data:a}=t.pop(),{$_appId:s,$_componentId:d}=a.root,i=c([s,d,r,"[event]"].concat(t));return new n.SafeString(`on${o}="rbs.handlers.trigger(${i.join(",")})"`)})),n.registerHelper("bound",(e,{hash:t={},data:r})=>{const{$_appId:a,$_componentId:s}=r.root,d=o.findByPath(r.root,e),i=t.ref||e,p=c([a,s,"[event]",e]);return new n.SafeString(`value="${d}" data-rbs-ref="${i}" oninput="rbs.handlers.bound(${p.join(",")})"`)})}};var h={register:function e(n,r,{name:a,template:d,data:i,helpers:c={},hooks:h={},methods:l={},watchers:m={},components:f=[]}){const u=o.getStorage(n);i=i||function(){return{}},a||t.fail("noName",null,arguments[2]),"function"!=typeof i&&t.fail("dataFn",{name:a}),"string"!=typeof d&&t.fail("tmplStr",{name:a});const g=r.create(),w=g.compile(d);return f.forEach(o=>{o.name||t.fail("noName",null,o),u.cDefs[o.name]||(u.cDefs[o.name]=e(n,r,o))}),p.register(n,{instance:g,methods:l,helpers:c,name:a,components:f}),{instance(e={}){const r=o.randomId(),d={$props:e,methods:l,hooks:h,name:a,watchers:m,data:i(),$refs:()=>o.dom.findRefs(r)};d.methods=o.bindAll(d,l),d.watchers=o.bindAll(d,m),Object.entries(e).forEach(([n,r])=>{void 0===r&&t.warn("propUndef",{name:a,key:n}),n in d.data&&t.warn("propStomp",{name:a,key:n}),"function"==typeof r&&(d.methods[n]=r,delete e[n])}),u.inst[r]={scope:d,renders:{}},h.created&&h.created.call(d);const c=s.create({...d,appId:n,compId:r});return d.data=c.data,{...d,proxyInst:c,render(){const e=o.dom.tagComponent(r,w(d.data),a);return c.watch(),e}}}}}};return{app({$el:e,root:n,Handlebars:r=window.Handlebars,trace:a=!1}){r||t.fail("noHbs"),window.rbs=window.ReBars=window.ReBars||{},window.ReBars.apps=window.ReBars.apps||{},window.ReBars.trace=a,window.ReBars.handlers=window.ReBars.handlers||{trigger(...e){const[n,r,a,...s]=e,d=o.getStorage(n,r).scope,i=d.methods[a];i||t.fail("noMethod",{name:d.name,methodName:a}),i(...s)},bound(e,n,t,r){const a=o.getStorage(e,n).scope;o.setKey(a.data,r,t.target.value)}};const s=o.randomId(),d=window.ReBars.apps[s]={cDefs:{},inst:{},trace:a};return document.body.contains(e)||t.fail("noEl"),e.innerHTML=h.register(s,r,n).instance().render(),{id:s,storage:d}}}}));
//# sourceMappingURL=index.min.js.map
