!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";let e=1;var t={findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,t,n)=>{const{tag:r,...o}={tag:"span",class:"rbs-watch",...n};return`<${r} ${Object.entries(o).map(([e,t])=>`${e}="${t}"`).join(" ")} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},tagComponent(e,t,n){const r=document.createElement("div");r.innerHTML=t;const o=r.firstElementChild;if(r.children.length>1||o.dataset.rbsWatch)throw new Error(`component:'${n}' must have one root node, and cannot be a {{#watch}}`);return o.dataset.rbsComp=e,r.innerHTML},getStorage(e,t){return t?this.findByPath(window.ReBars,`apps.${e}.inst.${t}`):this.findByPath(window.ReBars,`apps.${e}`)},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRefs(e){const t="object"==typeof e?e:this.findComponent(e);return Array.from(t.querySelectorAll("[data-rbs-ref]")).reduce((e,t)=>{const n=t.dataset.rbsRef,r=e[t.dataset.rbsRef];return e[n]=r?[r].concat(t):t,e},{})},findByPath:(e,t)=>t.split(".").reduce((e,t)=>e[t],e),getPath:(e,t)=>`rbs.apps.${e}.inst.${t}`,shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${e++}`,setKey(e,t,n){const r=t.split(".");r.reduce((o,a,s)=>{if(!(a in o))throw new Error(`${t} was not found in object`,e);return s+1===r.length&&(o[a]=n),o[a]},e)}},n={create(e,{id:n,props:r,methods:o,data:a,watchers:s,name:i}){const c=t.getStorage(e,n),d=t.getStorage(e);function p(e){Object.entries(s).forEach(([n,r])=>{t.shouldRender(e,n)&&r({data:f,methods:o})}),Object.entries(c.renders).forEach(([n,r])=>{if(t.shouldRender(e,r.path)){const e=t.findWatcher(n);if(e){const n=r.render(),o=document.activeElement,a={ref:o.dataset.rbsRef,pos:o.selectionStart};if(e.innerHTML!==n){e.style.display=""===n?"none":"",e.innerHTML=n;const r=t.findRefs(e)[a.ref];r&&(Array.isArray(r)||(r.focus(),a.pos&&r.setSelectionRange(a.pos+1,a.pos+1)))}}else delete c.renders[n]}}),Object.keys(d.inst).forEach(e=>{t.findComponent(e)||delete d.inst[e]})}const f=function e(t,n=[]){return new Proxy(t,{get:function(t,r){if("ReBarsPath"===r)return n.join(".");const o=Reflect.get(...arguments);return null!==o&&"object"==typeof o&&"methods"!==r?e(o,n.concat(r)):o},set:function(e,t){const r=Reflect.set(...arguments);return p(n.concat(t).join(".")),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments);return p(n.concat(t).join(".")),r}})}({...a(),$_componentId:n,$_appId:e,...r});return f}};const r=(e,t=!0)=>{if(void 0===e)throw new Error(`have passed undefined to watch helper in component '${name}'`);return"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e},o=(e,n,{root:r})=>{const o=t.randomId();return t.getStorage(r.$_appId,r.$_componentId).renders[o]={path:e,render:n},o},a=e=>e.map(t=>{if(["[event]"].includes(t))return t.replace("[","").replace("]","");if(null!==t&&"object"==typeof parm)throw new Error(`component:${name} must only pass primitives as argument to a handler. ${JSON.stringify(e,null,2)}`);return"string"==typeof t?`'${t}'`:t});var s={register(e,{instance:n,helpers:s,name:i}){n.registerHelper("component",(function(r,{hash:o}){const a=t.getStorage(e).cDefs;if(Object.entries(o).forEach(([e,t])=>{if("function"==typeof t)throw new Error(`cannot pass a function as a prop. in '${i}' child '${r}' prop '${e}'`)}),!a[r])throw new Error(`component:${i} child component ${r} is not registered`);return new n.SafeString(a[r].render(o))})),Object.entries(s).forEach(([e,t])=>n.registerHelper(e,t)),n.registerHelper("ref",e=>new n.SafeString(`data-rbs-ref="${e}"`)),n.registerHelper("debug",(function(e,{data:a}){const s=()=>`<pre class="debug">${JSON.stringify(e,null,2)}</pre>`,i=o(r(e),s,a);return new n.SafeString(t.wrapWatch(i,s()))})),n.registerHelper("watch",(function(...e){const{fn:n,hash:a,data:s}=e.pop(),i=e.map(e=>r(e,!1)).join(".").split(","),c=o(i,()=>n(this),s);return t.wrapWatcher(c,n(this),a)})),n.registerHelper("method",(function(){const[e,...t]=arguments,[r,o="click"]=e.split(":"),{data:s}=t.pop(),{$_appId:i,$_componentId:c}=s.root,d=a([i,c,r,"[event]"].concat(t));return new n.SafeString(`on${o}="rbs.handlers.trigger(${d.join(",")})"`)})),n.registerHelper("bound",(e,{hash:r={},data:o})=>{const{$_appId:s,$_componentId:i}=o.root,c=t.findByPath(o.root,e),d=r.ref||e,p=a([s,i,"[event]",e]);return new n.SafeString(`value="${c}" data-rbs-ref="${d}" oninput="rbs.handlers.bound(${p.join(",")})"`)})}};var i={create:function e(r,{name:o,template:a,data:i,helpers:c={},methods:d={},watchers:p={},components:f=[]}){const h=t.getStorage(r);if(i=i||function(){return{}},!o)throw new Error("Each ReBars component should have a name");if("function"!=typeof i)throw new Error(`component:${o} data must be a function`);if("string"!=typeof a)throw new Error(`component:${o} needs a template string`);const u=Handlebars.create(),l=u.compile(a);return f.forEach(t=>{if(!t.name)throw new Error("component needs a name",t);h.cDefs[t.name]||(h.cDefs[t.name]=e(r,t))}),s.register(r,{instance:u,helpers:c,name:o,components:f}),{render(e={}){const a=t.randomId(),s={props:e,methods:d,name:o};s.methods=Object.entries(d).reduce((e,[t,n])=>(e[t]=n.bind(s),e),{}),h.inst[a]={scope:s,renders:{}};const c=n.create(r,{methods:d,data:i,watchers:p,name:o,id:a,props:e});return s.data=c,t.tagComponent(a,l(c),o)}}}};return function({$el:e,root:n,Handlebars:r=window.Handlebars}){if(!r)throw new Error("ReBars need Handlebars in order to run!");window.rbs=window.ReBars=window.ReBars||{},window.ReBars.apps=window.ReBars.apps||{},window.ReBars.handlers=window.ReBars.handlers||{trigger(...e){const[n,r,o,...a]=e,s=t.getStorage(n,r).scope,i=s.methods[o];if(!i)throw new Error(`component:${s.name} ${o} is not a defined method`);i(...a)},bound(e,n,r,o){const a=t.getStorage(e,n).scope;t.setKey(a.data,o,r.target.value)}};const o=t.randomId(),a=window.ReBars.apps[o]={cDefs:{},inst:{}};if(!document.body.contains(e))throw new Error("$el must be present in the document");return e.innerHTML=i.create(o,n).render(),{id:o,storage:a}}}));
//# sourceMappingURL=index.min.js.map
