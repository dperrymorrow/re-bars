!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";let e=1;var t={findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,t,n)=>{const{tag:r,...o}={tag:"span",class:"rbs-watch",...n};return`<${r} ${Object.entries(o).map(([e,t])=>`${e}="${t}"`).join(" ")} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},tagComponent(e,t,n,r){const o=document.createElement("div");o.innerHTML=n;const s=o.firstElementChild;if(o.children.length>1||s.dataset.rbsWatch)throw new Error(`component:'${r}' must have one root node, and cannot be a {{#watch}}`);return s.dataset.rbsComp=t,o.innerHTML},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRefs(e){const t="object"==typeof e?e:this.findComponent(e);return Array.from(t.querySelectorAll("[data-rbs-ref]")).reduce((e,t)=>{const n=t.dataset.rbsRef,r=e[t.dataset.rbsRef];return e[n]=r?[r].concat(t):t,e},{})},findByPath:(e,t)=>t.split(".").reduce((e,t)=>e[t],e),getPath:(e,t)=>`rbs.apps.${e}.comp.${t}`,shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${e++}`,setKey(e,t,n){const r=t.split(".");r.reduce((o,s,a)=>{if(!(s in o))throw new Error(`${t} was not found in object`,e);return a+1===r.length&&(o[s]=n),o[s]},e)}};function n(e,{data:n,instance:r,methods:o,id:s,props:a,app:c,name:i}){const d=`${t.getPath(c.id,s)}.ev`;e.ev.bind=(e,r)=>t.setKey(n,r,e.target.value),e.ev.method=function(){const[e,r,...c]=arguments;if(!(r in o))throw new Error(`${r} was not found in methods for component '${i}'`);return o[r].call(o,{data:n,props:a,methods:o,$refs:t.findRefs(s)},e,...c)},r.registerHelper("method",(function(){const[e,...t]=arguments,[n,o="click"]=e.split(":");t.splice(-1,1);const s=[n].concat(t).map(e=>{if(null!==e&&"object"==typeof parm)throw new Error(`must only pass primitives as argument to a handler. ${JSON.stringify(t,null,2)}`);return"string"==typeof e?`'${e}'`:e});return new r.SafeString(`on${o}="${d}.method(event,${s.join(",")})"`)})),r.registerHelper("bind",(e,{hash:o={}})=>{const s=t.findByPath(n,e),a=o.ref||e;return new r.SafeString(`value="${s}" data-rbs-ref="${a}" oninput="${d}.bind(event, '${e}')"`)})}function r(e,{instance:n,name:r}){const o=(e,t=!0)=>{if(void 0===e)throw new Error(`have passed undefined to watch helper in component '${r}'`);return"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e},s=(n,r)=>{const o=t.randomId();return e.renders[o]={path:n,render:r},o};n.registerHelper("debug",(function(e){const r=()=>`<pre class="debug">${JSON.stringify(e,null,2)}</pre>`,a=s(o(e),r);return new n.SafeString(t.wrapWatch(a,r()))})),n.registerHelper("watch",(function(...e){const{fn:n,hash:r}=e.pop(),a=e.map(e=>o(e,!1)).join(".").split(","),c=s(a,()=>n(this));return t.wrapWatcher(c,n(this),r)}))}return function({$el:e,root:o,Handlebars:s=window.Handlebars}){if(!s)throw new Error("ReBars need Handlebars in order to run!");window.ReBars=window.ReBars||{},window.ReBars.apps=window.ReBars.apps||{},window.rbs=window.ReBars;const a=t.randomId(),c=window.ReBars.apps[a]={comp:{}},i={component:d,id:a,storage:c};if(!document.body.contains(e))throw new Error("$el must be present in the document");function d({template:e,methods:o={},props:a={},name:d,components:p={},data:f,watchers:u={},helpers:h={}}){const l=t.randomId(),m=s.create();if(!d)throw new Error("Each ReBars component should have a name");c.comp[l]={renders:{},ev:{},name:d};const w=function({id:e,app:n,props:r={},methods:o,rawData:s={},watchers:a={},name:c}){const i=n.storage.comp[e];function d(e){Object.entries(a).forEach(([n,s])=>{t.shouldRender(e,n)&&s({data:p,props:r,methods:o})}),Object.entries(i.renders).forEach(([n,r])=>{if(t.shouldRender(e,r.path)){const e=t.findWatcher(n);if(e){const n=r.render(),o=document.activeElement,s={ref:o.dataset.rbsRef,pos:o.selectionStart};if(e.innerHTML!==n){e.removeAttribute("style"),e.innerHTML=n;const r=t.findRefs(e)[s.ref];r&&(Array.isArray(r)||(r.focus(),s.pos&&r.setSelectionRange(s.pos+1,s.pos+1)))}}else delete i.renders[n]}}),Object.keys(n.storage.comp).forEach(e=>{t.findComponent(e)||delete n.storage.comp[e]})}const p=function e(t,n=[]){return new Proxy(t,{get:function(t,r){if("ReBarsPath"===r)return n.join(".");const o=Reflect.get(...arguments);return null!==o&&"object"==typeof o&&"methods"!==r?e(o,n.concat(r)):o},set:function(e,t){const r=Reflect.set(...arguments);return d(n.concat(t).join(".")),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments);return d(n.concat(t).join(".")),r}})}({...s,...r});return p}({id:l,app:i,props:a,methods:o,rawData:f,watchers:u,name:d}),b=m.compile(e);return function({instance:e,app:t,id:o,components:s,helpers:a,name:c}){const i=t.storage.comp[o];r(i,...arguments),n(i,...arguments),e.registerHelper("component",(function(n,{hash:r}){return Object.entries(r).forEach(([e,t])=>{if("function"==typeof t)throw new Error(`cannot pass a function as a prop. in '${c}' child '${n}' prop '${e}'`)}),new e.SafeString(t.component({...s[n],props:r}))})),Object.entries(a).forEach(([t,n])=>e.registerHelper(t,n)),e.registerHelper("ref",t=>new e.SafeString(`data-rbs-ref="${t}"`))}({props:a,methods:o,id:l,components:p,instance:m,helpers:h,data:w,name:d,app:i}),t.tagComponent(i.id,l,b(w),d)}return e.innerHTML=d(o),{id:a,component:d,storage:c}}}));
//# sourceMappingURL=index.min.js.map
