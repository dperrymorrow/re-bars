!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";const e={warn:"background: #484915; color: #ffffbe; padding: .1em; font-weight: normal;",log:"background: #324645; color:#c9faff; padding: .1em; font-weight: normal;"},t=(t,r,...n)=>{let o=r;if("object"==typeof n[0]&&"template"in n[0]&&"loc"in n[0]&&(o+=(({template:e,loc:t})=>{const r=e.split("\n").slice(t.start.line-1,t.end.line),n=Array(r[0].length-r[0].trim().length).join(" "),o=r.map(e=>e.replace(n,"      "));return o[0]=`>>>> ${o[0].trim()}`,`\n  template line: ${t.start.line}\n  ============================================\n  ${o.join("\n")}\n  `})(n[0]),n.splice(0,1)),!["warn","log"].includes(t))throw n.forEach(console.error),new Error(o);o="%c "+o+" ",window.ReBars&&window.ReBars.trace&&(n?(console.groupCollapsed(o,e[t]),n.forEach(console.log),console.groupEnd()):console.log(o,e[t]))};var r={warn:t.bind(null,"warn"),fail:t.bind(null,"throw"),log:t.bind(null,"log")};let n=1;var o={dom:{recordState(e){const t=document.activeElement,r=t.getAttribute("ref");return e.contains(t)&&r?{ref:r,scrollTop:t.scrollTop,scrollLeft:t.scrollLeft,selectionStart:t.selectionStart}:null},restoreState(e,t){if(!t)return;const n=this.findRef(e,t.ref);if(n)if(Array.isArray(n))r.warn(`ref="${t.ref}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each usage`,n);else{if(n.focus(),t.selectionStart){const e="TEXTAREA"===n.tagName?t.selectionStart:t.selectionStart+1;n.setSelectionRange(e,e)}n.scrollTop=t.scrollTop,n.scrollLeft=t.scrollLeft}},findRefs:e=>Array.from(e.querySelectorAll("[ref]")).reduce((e,t)=>{const r=t.getAttribute("ref"),n=e[r];return e[r]=n?[n].concat(t):t,e},{}),findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),propStr:e=>Object.entries(e).map(([e,t])=>"number"==typeof t?`${e}=${t}`:`${e}="${t}"`).join(" "),wrapWatcher(e,t,r){const{tag:n,...o}={tag:"span",...r};return`<${n} ${this.propStr(o)} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${n}>`},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},stringify:(e,t=2)=>JSON.stringify(e,(e,t)=>"function"==typeof t?t+"":t,t),debounce(e,t=0,r=!1){let n=null;return function(){const o=r&&!n,a=()=>e.apply(this,arguments);clearTimeout(n),n=setTimeout(a,t),o&&a()}},bind:(e,t)=>Object.keys(e).reduce((e,r)=>(e[r]=e[r].bind(t),e),{...e}),shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const r=e.split(".");return t.split(".").every((e,t)=>e===r[t]||"*"===e)}),randomId:()=>`rbs${n++}`,getKey:(e,t)=>t.split(".").reduce((n,o)=>(o in n||r.fail(`${t} was not found in object`,e),n[o]),e),hasKey(e,t){if(t.includes("*"))return!0;try{return this.getKey(e,t),!0}catch(e){return!1}}},a={create(e,t,r=!1){let n=[];const a=o.debounce(()=>{t(n),n=[]}),c=e=>{n.push(e),a(n)};const s=function e(t,n=[]){return new Proxy(t,{get:function(t,o){if("ReBarsPath"===o)return n.join(".");const a=Reflect.get(...arguments);return"function"==typeof a&&t.hasOwnProperty(o)?a.bind(s):(r&&c(n.concat(o).join(".")),null!==a&&"object"==typeof a&&"methods"!==o&&"object"===a.constructor.name?e(a,n.concat(o)):a)},set:function(e,t){const r=Reflect.set(...arguments),o=n.concat(t).join(".");return c(o),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),o=n.concat(t).join(".");return c(o),r}})}(e);return s}},c={register({instance:e,helpers:t,template:n,store:c}){Object.entries(t).forEach(([t,r])=>e.registerHelper(t,r)),e.registerHelper("debug",(t,{hash:a,data:c,loc:s})=>{void 0===t&&r.fail(`${name}: undefined passed to debug`,{template:n,loc:s});const i={class:"debug",...a};return new e.SafeString(`<pre ${o.dom.propStr(i)}>${o.stringify(t)}</pre>`)}),e.registerHelper("watch",(function(...e){const{fn:t,hash:s,data:i,loc:d}=e.pop(),l=o.randomId(),f=e.map(e=>(void 0===e&&r.fail(`${name}: undefined cannot be watched`,{template:n,loc:d}),"object"==typeof e?`${e.ReBarsPath}.*`:e));if(!f.length){const e=a.create(i.root,e=>{c.renders[l].path=e},!0);t(e)}return f.forEach(e=>{o.hasKey(i.root,e)||r.fail(`${name}: cannot find path "${e}" to watch`,{template:n,loc:d})}),c.renders[l]={path:f,render:()=>t(this)},o.dom.wrapWatcher(l,t(this),s)}))}};function s(e,t){const r=new RegExp(/data-rbs(.*?)="(.*?)"/g);return e.replace(r,"")===t.replace(r,"")}var i={canPatch:e=>e.children.length&&e.children.length>1&&Array.from(e.children).every(e=>e.getAttribute("ref")),hasChanged:(e,t)=>!s(e.innerHTML,t),compare({app:e,$target:t,html:r}){const n=o.dom.getShadow(r),a=Array.from(n.children);Array.from(t.children).forEach(e=>{const t=o.dom.findRef(n,e.getAttribute("ref"));t?s(t.innerHTML,e.innerHTML)||e.replaceWith(t.cloneNode(!0)):e.remove()}),a.forEach((e,r)=>{o.dom.findRef(t,e.getAttribute("ref"))||function(e,t,r=0){r>=e.children.length?e.appendChild(t):e.insertBefore(t,e.children[r])}(t,e.cloneNode(!0),r)}),a.forEach((e,r)=>{const n=t.children[r];n.getAttribute("ref")!==e.getAttribute("ref")&&n.replaceWith(e.cloneNode(!0))})}},d={paths({paths:e,renders:t}){Object.entries(t).filter(([t,r])=>e.some(e=>o.shouldRender(e,r.path))&&o.dom.findWatcher(t)).forEach(([e,t])=>{const n=o.dom.findWatcher(e),a=t.render(),c=o.dom.recordState(n);i.hasChanged(n,a)&&(t.path.find(e=>e.endsWith(".length"))&&r.warn(`${name}: patching "${t.path}" add a ref="someUniqueKey" to each to avoid re-rendering the entire Array of elements`,n),n.style.display=""===a?"none":"",n.innerHTML=a,o.dom.restoreState(n,c),r.log(`${name}: re-rendering watch block for ${t.path}`,n))})}};return{app({helpers:e={},template:t,data:n={},refs:s={},methods:i={},Handlebars:l=window.Handlebars}){const f=l.create(),h=f.compile(t),p={renders:{}},u=a.create(n,e=>{r.log(`${name}: data changed "${e}"`,p.renders),d.paths({paths:e,renders:p.renders})});return c.register({instance:f,template:t,helpers:e,store:p}),{instance:f,render(e){const t={data:u,methods:i,refs:s,$refs:()=>o.dom.findRefs(e),$app:e};function r(e,r){const n=e.getAttribute("method");if(n){const[o,a]=n.includes(":")?n.split(":"):`click:${n}`.split(":");"attached"===r?e.addEventListener(o,t.methods[a]):e.removeEventListener(o,t.methods[a])}}t.methods=o.bind(t.methods,t),t.refs=o.bind(t.refs,t),new MutationObserver(e=>{e.forEach(({addedNodes:e,removedNodes:t})=>{e.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(r(e,"attached"),e.querySelectorAll("[method]").forEach(e=>r(e,"attached")))}),t.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(r(e,"detached"),e.querySelectorAll("[method]").forEach(e=>r(e,"detached")))})})}).observe(e,{childList:!0,attributes:!0,subtree:!0}),e.innerHTML=h(u)}}}}}));
//# sourceMappingURL=re-bars.umd.min.js.map
