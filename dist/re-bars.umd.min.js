!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";const e={warn:"background: #484915; color: #ffffbe; padding: .1em; font-weight: normal;",log:"background: #324645; color:#c9faff; padding: .1em; font-weight: normal;"},t=(t,n,...o)=>{let r=n;if("object"==typeof o[0]&&"template"in o[0]&&"loc"in o[0]&&(r+=(({template:e,loc:t})=>{const n=e.split("\n").slice(t.start.line-1,t.end.line),o=Array(n[0].length-n[0].trim().length).join(" "),r=n.map(e=>e.replace(o,"      "));return r[0]=`>>>> ${r[0].trim()}`,`\n  template line: ${t.start.line}\n  ============================================\n  ${r.join("\n")}\n  `})(o[0]),o.splice(0,1)),!["warn","log"].includes(t))throw o.forEach(console.error),new Error(r);r="%c "+r+" ",window.ReBars&&window.ReBars.trace&&(o?(console.groupCollapsed(r,e[t]),o.forEach(console.log),console.groupEnd()):console.log(r,e[t]))};var n={warn:t.bind(null,"warn"),fail:t.bind(null,"throw"),log:t.bind(null,"log")};let o=1;var r={dom:{tagComponent(e,t,o){const r=this.getShadow(t),a=r.firstElementChild;if(!a)throw new Error("there was no root node. Components need a root element.");return["P"].includes(a.nodeName)&&n.fail(`${o}: <${a.nodeName.toLowerCase()}> cannot be a root element of for a component, try a <div>`),r.children.length>1&&n.fail(`${o}: multiple root nodes are not allowed for a component.`),a.dataset.rbsWatch&&n.fail(`${o}: cannot have a watch as the root node of a component`),a.dataset.rbsComp=e,r.innerHTML},recordState(e){const t=document.activeElement,n=t.getAttribute("ref");return e.contains(t)&&n?{ref:n,scrollTop:t.scrollTop,scrollLeft:t.scrollLeft,selectionStart:t.selectionStart}:null},restoreState(e,t){if(!t)return;const o=this.findRef(e,t.ref);if(o)if(Array.isArray(o))n.warn(`ref="${t.ref}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each usage`,o);else{if(o.focus(),t.selectionStart){const e="TEXTAREA"===o.tagName?t.selectionStart:t.selectionStart+1;o.setSelectionRange(e,e)}o.scrollTop=t.scrollTop,o.scrollLeft=t.scrollLeft}},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.getAttribute("ref")===t?e:e.querySelector(`[ref="${t}"]`),findRefs(e){const t=this.findComponent(e),n=Array.from(t.querySelectorAll("[ref]"));return t.getAttribute("ref")&&n.push(t),n.reduce((e,t)=>{const n=t.getAttribute("ref"),o=e[n];return e[n]=o?[o].concat(t):t,e},{})},findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),propStr:e=>Object.entries(e).map(([e,t])=>"number"==typeof t?`${e}=${t}`:`${e}="${t}"`).join(" "),wrapWatcher(e,t,n){const{tag:o,...r}={tag:"span",...n};return`<${o} ${this.propStr(r)} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${o}>`},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},stringify:(e,t=2)=>JSON.stringify(e,(e,t)=>"function"==typeof t?t+"":t,t),debounce(e,t=0,n=!1){let o=null;return function(){const r=n&&!o,a=()=>e.apply(this,arguments);clearTimeout(o),o=setTimeout(a,t),r&&a()}},isProp:e=>!("string"!=typeof e||!e.startsWith("$props"))||!("object"!=typeof e||!e.ReBarsPath.startsWith("$props")),shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${o++}`,getKey:(e,t)=>t.split(".").reduce((o,r)=>(r in o||n.fail(`${t} was not found in object`,e),o[r]),e),hasKey(e,t){if(t.includes("*"))return!0;try{return this.getKey(e,t),!0}catch(e){return!1}},setKey(e,t,o){const r=t.split(".");r.reduce((a,s,c)=>(s in a||n.fail(`${t} was not found in object!`,e),c+1===r.length&&(a[s]=o),a[s]),e)}},a={protectedKeys:["$_componentId","$props","$methods","$name","$parent","$listeners"],listenerPrefix:"listen:"},s={create(e,t,o=!1){let s=[];const c=r.debounce(()=>{t(s),s=[]}),d=e=>{s.push(e),c(s)};const i=function e(t,r=[]){return new Proxy(t,{get:function(t,n){if("ReBarsPath"===n)return r.join(".");const s=Reflect.get(...arguments);return"function"==typeof s&&t.hasOwnProperty(n)?s.bind(i):a.protectedKeys.includes(r[0])?s:(o&&d(r.concat(n).join(".")),null!==s&&"object"==typeof s&&"methods"!==n?e(s,r.concat(n)):s)},set:function(e,t){const o=Reflect.set(...arguments),s=r.concat(t).join(".");return a.protectedKeys.includes(r[0])?n.warn(`attempted to set a protected key "${s}". readOnly properties are ${a.protectedKeys}`):d(s),o},deleteProperty:function(e,t){const o=Reflect.deleteProperty(...arguments),s=r.concat(t).join(".");return a.protectedKeys.includes(r[0])?n.fail(`cannot delete protected key ${s}. readOnly properties are ${a.protectedKeys}`):d(s),o}})}(e);return i}},c={register({app:e,instance:t,components:o,helpers:c,template:d,methods:i,name:l}){Object.entries(c).forEach(([e,n])=>t.registerHelper(e,n)),t.registerHelper("isComponent",e=>Object.keys(o).includes(e)),t.registerHelper("component",(function(...e){const{hash:r,loc:s,data:c}=e.pop(),i=e[0];return o[i]||n.fail(`${l}: child component "${i}" is not registered`,{template:d,loc:s}),Object.entries(r).forEach(([e,t])=>{void 0===t&&n.fail(`${l}: passed "${e}" as undefined. If you really meant to, pass null instead.`,{template:d,loc:s},r)}),Object.keys(r).filter(e=>e.startsWith(a.listenerPrefix)).forEach(e=>{const t=r[e];t in c.root.$methods?r[e]=c.root.$methods[t]:n.fail(`${l}: listener "${t}" was not found in the ${l}'s methods.`,{template:d,loc:s},r)}),new t.SafeString(o[i].instance(r).render())})),t.registerHelper("debug",(e,{hash:o,data:a,loc:s})=>{void 0===e&&n.fail(`${l}: undefined passed to debug`,{template:d,loc:s});const c={class:"debug",...o};return new t.SafeString(`<pre ${r.dom.propStr(c)}>${r.stringify(e)}</pre>`)}),t.registerHelper("watch",(function(...t){const{fn:o,hash:a,data:c,loc:i}=t.pop(),p=c.root.$_componentId,h=r.randomId(),f=t.map(e=>(void 0===e&&n.fail(`${l}: undefined cannot be watched`,{template:d,loc:i}),r.isProp(e)&&n.fail(`${l}: Do not watch $props. Each component has its own Proxy so the child will not get the update. Instead watch the item in the parent, and re-render the child component`,{template:d,loc:i}),"object"==typeof e?`${e.ReBarsPath}.*`:e)),m=e.components.instances[p].renders;if(!f.length){const e=s.create(c.root,e=>{m[h].path=e},!0);o(e)}return f.forEach(e=>{r.hasKey(c.root,e)||n.fail(`${l}: cannot find path "${e}" to watch`,{template:d,loc:i})}),m[h]={path:f,render:()=>o(this)},r.dom.wrapWatcher(h,o(this),a)})),t.registerHelper("method",(function(){const[e,...o]=arguments,[a,s="click"]=e.split(":"),{data:c,loc:p}=o.pop();a in i||"$emit"===a||n.fail(`${l}: "${a}" is not a method`,{template:d,loc:p});const h={"data-rbs-method":[c.root.$_componentId,s,a]};return o&&o.length&&(h["data-rbs-method"]=h["data-rbs-method"].concat(o)),new t.SafeString(r.dom.propStr(h))})),t.registerHelper("bound",(e,{hash:o={},data:a,loc:s})=>{const c=[a.root.$_componentId,e];r.hasKey(a.root,e)||n.fail(`${l}: does not have path "${e}"`,{template:d,loc:s});const i={value:r.getKey(a.root,e),ref:o.ref||e,"data-rbs-bound":c};return new t.SafeString(r.dom.propStr(i))})}};function d(e,t){const n=new RegExp(/data-rbs(.*?)="(.*?)"/g);return e.replace(n,"")===t.replace(n,"")}var i={canPatch:e=>e.children.length&&e.children.length>1&&Array.from(e.children).every(e=>e.getAttribute("ref")),hasChanged:(e,t)=>!d(e.innerHTML,t),compare({app:e,$target:t,html:n}){const o=r.dom.getShadow(n),a=Array.from(o.children);Array.from(t.children).forEach(e=>{const t=r.dom.findRef(o,e.getAttribute("ref"));t?d(t.innerHTML,e.innerHTML)||e.replaceWith(t.cloneNode(!0)):e.remove()}),a.forEach((e,n)=>{r.dom.findRef(t,e.getAttribute("ref"))||function(e,t,n=0){n>=e.children.length?e.appendChild(t):e.insertBefore(t,e.children[n])}(t,e.cloneNode(!0),n)}),a.forEach((e,n)=>{const o=t.children[n];o.getAttribute("ref")!==e.getAttribute("ref")&&o.replaceWith(e.cloneNode(!0))})}},l={paths({app:e,paths:t,renders:o,name:a}){Object.entries(o).filter(([e,n])=>t.some(e=>r.shouldRender(e,n.path))&&r.dom.findWatcher(e)).forEach(([t,o])=>{const s=r.dom.findWatcher(t),c=o.render(),d=r.dom.recordState(s);if(i.hasChanged(s,c))return i.canPatch(s)?(i.compare({app:e,$target:s,html:c}),n.log(`${a}: patching ${o.path}`,s),void r.dom.restoreState(s,d)):(o.path.find(e=>e.endsWith(".length"))&&n.warn(`${a}: patching "${o.path}" add a ref="someUniqueKey" to each to avoid re-rendering the entire Array of elements`,s),s.style.display=""===c?"none":"",s.innerHTML=c,r.dom.restoreState(s,d),void n.log(`${a}: re-rendering watch block for ${o.path}`,s))}),e.deleteOrphans()}};const p=["component","ref","debug","isComponent","method","bound","watch","isComponent"];var h={register:function e({id:t,Handlebars:o,trace:d,helpers:i,components:h},{name:f,template:m,data:u=(()=>({})),helpers:b={},hooks:g={},methods:$={},watchers:y={},components:w=[]}){const E=arguments[0];f||n.fail("Every ReBars component should have a name!",E),"function"!=typeof u&&n.fail(`${f}: component data must be a function`,E),"string"!=typeof m&&n.fail("`${name}: needs a template string`",E);const S=arguments[0],v=o.create(),A=v.compile(m),R=w.reduce((t,n)=>{const o=e(S,n);return t[n.name]=o,t},{...h.registered});return Object.keys(u()).forEach(e=>{p.concat(Object.keys(b)).includes(e)&&n.fail(`${f}: cannot use "${e}" in your data as it's defined as a helper`,E)}),c.register({app:S,methods:$,instance:v,name:f,helpers:{...b,...i},components:R,template:m}),{instance(e={}){const t=r.randomId(),o=u(),c={},d=Object.entries(e).reduce((t,[n,o])=>(n.startsWith(a.listenerPrefix)&&(t[n.replace(a.listenerPrefix,"")]=o,e[n].delete),t),{});let i=!1;const p=s.create({...o,$props:e,$methods:$,$listeners:d,$emit:(e,t={})=>{d[e]&&d[e](t)},$name:f,$_componentId:t,$el:()=>r.dom.findComponent(t),$refs:()=>r.dom.findRefs(t)},e=>{i&&(n.log(`${f}: data changed "${e}"`,c),Object.entries(y).reduce((t,[n,o])=>(e.some(e=>r.shouldRender(e,n.split(",")))&&t.push(o),t),[]).forEach(e=>e.call(p)),l.paths({app:S,paths:e,renders:c,name:f}))});g.created&&g.created.call(p),r.debounce(()=>{i=!0})();const h={id:t,scope:p,hooks:g,renders:c,handlers:{bound(e){const[t,n]=e.currentTarget.dataset.rbsBound.split(",");r.setKey(p,n,e.target.value)},method(e){const[t,n,o,...r]=e.currentTarget.dataset.rbsMethod.split(",");"$emit"===o?p.$emit(r[0],p[r[0]]):p.$methods[o](e,...r)}},detached(){g.detached&&g.detached.call(p)},attached(){g.attached&&g.attached.call(p)},render:()=>r.dom.tagComponent(t,A(p),f)};return S.components.instances[t]=h,h}}}};return{app({$el:e,root:t,Handlebars:o=window.Handlebars,helpers:a={},components:s=[],trace:c=!1}){o||n.fail("noHbs"),document.body.contains(e)||n.fail("$el passed to ReBars app is either undefined or not present in the document."),window.ReBars=window.ReBars||{},window.ReBars.trace=c;const d={id:r.randomId(),Handlebars:o,trace:c,helpers:a,$el:e,deleteOrphans:r.debounce(()=>{Object.keys(d.components.instances).forEach(e=>{r.dom.findComponent(e)||delete d.components.instances[e]})}),components:{registered:{},instances:{}}};function i(e,t){const n="add"===e?"attached":"detached",o=t.dataset.rbsComp;d.components.instances[o][n]()}function l(e,t){const n="add"===e?"addEventListener":"removeEventListener",[o,r]=t.dataset.rbsMethod.split(",");t[n](r,d.components.instances[o].handlers.method)}function p(e,t){const n="add"===e?"addEventListener":"removeEventListener",[o,r]=t.dataset.rbsBound.split(",");t[n]("input",d.components.instances[o].handlers.bound)}return d.components.registered=s.reduce((e,t)=>(e[t.name]=h.register(d,t),e),{}),new MutationObserver(e=>{e.forEach(({addedNodes:e,removedNodes:t})=>{e.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsComp&&i("add",e),e.dataset.rbsMethod&&l("add",e),e.dataset.rbsBound&&p("add",e),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"add")),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"add")),e.querySelectorAll("[data-rbs-bound]").forEach(p.bind(null,"add")))}),t.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsMethod&&l("remove",e),e.dataset.rbsBound&&p("remove",e),e.dataset.rbsComp&&i("remove",e),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"remove")),e.querySelectorAll("[data-rbs-bound]").forEach(p.bind(null,"remove")),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"remove")))})})}).observe(e,{childList:!0,attributes:!0,subtree:!0}),e.innerHTML=h.register(d,t).instance().render(),d}}}));
//# sourceMappingURL=re-bars.umd.min.js.map
