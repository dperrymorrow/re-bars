!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";let e=!1;var t={logLevel:()=>e?1:0,setTrace:t=>e=t,attrs:{watch:"rbs-watch",method:"rbs-method",ref:"rbs-ref"}};const{attrs:r}=t;let n=1;var o={dom:{recordState(e){const t=document.activeElement,n=t.getAttribute(r.ref);return e.contains(t)&&n?{ref:n,scrollTop:t.scrollTop,scrollLeft:t.scrollLeft,selectionStart:t.selectionStart}:null},restoreState(e,t){if(!t)return;const r=this.findRef(e,t.ref);if(r){if(r.focus(),t.selectionStart){const e="TEXTAREA"===r.tagName?t.selectionStart:t.selectionStart+1;r.setSelectionRange(e,e)}r.scrollTop=t.scrollTop,r.scrollLeft=t.scrollLeft}},findRef:(e,t)=>e.getAttribute(r.ref)===t?e:e.querySelector(`[${r.ref}="${t}"]`),findRefs(e){const{ref:t}=r;return Array.from(e.querySelectorAll(`[${t}]`)).reduce((e,r)=>{const n=r.getAttribute(t),o=e[n];return e[n]=o?[o].concat(r):r,e},{})},findMethod:e=>document.querySelector(`[${r.method}="${e}"]`),findWatcher:e=>document.querySelector(`[${r.watch}="${e}"]`),propStr:e=>Object.entries(e).map(([e,t])=>"number"==typeof t?`${e}=${t}`:`${e}="${t}"`).join(" "),wrapWatcher(e,t,n){const{tag:o,...s}={tag:"span",...n};return`<${o} ${this.propStr(s)} ${t.length?"":"style='display:none;'"} ${r.watch}="${e}">${t}</${o}>`},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},debounce(e,t=0,r=!1){let n=null;return function(){const o=r&&!n,s=()=>e.apply(this,arguments);clearTimeout(n),n=setTimeout(s,t),o&&s()}},intersects:(e,t)=>Object.keys(t).filter(t=>t in e),registerHelpers(e,t){Object.entries(t).forEach(([t,r])=>e.registerHelper(t,r))},registerPartials(e,t,r){Object.entries(r).forEach(([r,n])=>{e.registerPartial(r,n.template),["methods","partials","data"].forEach(o=>{if(!(o in n))return;const s=this.intersects(t[o],n[o]);s.length&&e.log(2,`ReBars: partial ${r} has conflicting ${o} keys`,s)}),n.data&&Object.assign(n.data,t.data),n.methods&&Object.assign(t.methods,n.methods),n.helpers&&this.registerHelpers(e,n.helpers)})},bind:(e,t,...r)=>Object.keys(e).reduce((e,n)=>(e[n]=e[n].bind(t,...r),e),{...e}),shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const r=e.split(".");return t.split(".").every((e,t)=>e===r[t]||"*"===e)}),randomId:()=>`rbs${n++}`},s={create(e,t,r=!1){let n=[];const s=o.debounce(()=>{t(n),n=[]}),a=e=>{n.includes(e)||n.push(e),s(n)};return function e(t,n=[]){return new Proxy(t,{get:function(t,o){if("ReBarsPath"===o)return n.join(".");const s=Reflect.get(...arguments);return s&&"object"==typeof s&&["Array","Object"].includes(s.constructor.name)?e(s,n.concat(o)):(r&&a(n.concat(o).join(".")),s)},set:function(e,t){const r=Reflect.set(...arguments),o=n.concat(t).join(".");return a(o),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),o=n.concat(t).join(".");return a(o),r}})}(e)}};const{attrs:a}=t;var c={register({instance:e,template:t,store:r,scope:n}){e.registerHelper("ref",t=>new e.SafeString(`${a.ref}="${t}"`)),e.registerHelper("buildPath",(function(...e){return e.pop(),Array.from(e).join(".")})),e.registerHelper("on",(function(...t){const{loc:r}=t.pop(),s=o.randomId(),[c,i,...d]=t,l=this;return t[1]in n.methods||e.log(3,`ReBars: "${t[1]}" is not a method. line: ${r.start.line}`),o.debounce(()=>{const e=o.dom.findMethod(s);e&&e.addEventListener(c,e=>{const t={event:e,$app:n.$app,$refs:o.dom.findRefs.bind(null,n.$app),rootData:n.data};t.methods=o.bind(n.methods,l,t),t.methods[i](...d)})})(),new e.SafeString(`${a.method}="${s}"`)})),e.registerHelper("watch",(function(...n){const a=n.pop(),{fn:c,hash:i,data:d,loc:l}=a,h=o.randomId(),f=n.map(r=>(void 0===r&&e.log(3,"undefined cannot be watched",{template:t,loc:l}),"object"==typeof r?`${r.ReBarsPath}.*`:r));if(!f.length){const e=s.create(d.root,e=>{r.renders[h].path=e},!0);c(e)}return r.renders[h]={path:f,render:()=>c(this)},o.dom.wrapWatcher(h,c(this),i)}))}};const i=t.attrs.ref;function d(e,t){const r=new RegExp(/rbs-(.*?)="(.*?)"/g);return e.replace(r,"")===t.replace(r,"")}var l={canPatch:e=>e.children.length&&e.children.length>1&&Array.from(e.children).every(e=>e.getAttribute(i)),hasChanged:(e,t)=>!d(e.innerHTML,t),compare({app:e,$target:t,html:r}){const n=o.dom.getShadow(r),s=Array.from(n.children);Array.from(t.children).forEach(e=>{const t=o.dom.findRef(n,e.getAttribute(i));t?d(t.innerHTML,e.innerHTML)||e.replaceWith(t.cloneNode(!0)):e.remove()}),s.forEach((e,r)=>{o.dom.findRef(t,e.getAttribute(i))||function(e,t,r=0){r>=e.children.length?e.appendChild(t):e.insertBefore(t,e.children[r])}(t,e.cloneNode(!0),r)}),s.forEach((e,r)=>{const n=t.children[r];n.getAttribute("ref")!==e.getAttribute(i)&&n.replaceWith(e.cloneNode(!0))})}},h={paths({paths:e,renders:r,instance:n}){Object.entries(r).filter(([t,r])=>e.some(e=>o.shouldRender(e,r.path))&&o.dom.findWatcher(t)).forEach(([e,r])=>{const s=o.dom.findWatcher(e);if(!s)return;const a=r.render(),c=o.dom.recordState(s);l.hasChanged(s,a)&&(r.path.find(e=>e.endsWith(".length"))&&n.log(2,`patching "${r.path}" add a ref="someUniqueKey" to each to avoid re-rendering the entire Array of elements`,s),s.style.display=""===a?"none":"",s.innerHTML=a,o.dom.restoreState(s,c),n.log(t.logLevel(),"ReBars: render",r.path,s))})}};return{app({helpers:e={},template:r,data:n={},refs:a={},methods:i={},partials:d={},Handlebars:l=window.Handlebars,trace:f=!1}){const p=l.create(),u=p.compile(r),m={renders:{}};return t.setTrace(f),o.registerHelpers(p,e),{store:m,instance:p,render(e){const a={$app:e,methods:i,data:n};c.register({instance:p,template:r,store:m,scope:a}),o.registerPartials(p,a,d),a.data=Object.entries(a.data).reduce((e,[t,r])=>("function"==typeof r&&e.hasOwnProperty(t)&&(e[t]=r.bind(a)),e),n),a.data=s.create(n,e=>{p.log(t.logLevel(),"ReBars: change",e),h.paths({paths:e,renders:m.renders,instance:p})}),new MutationObserver(e=>{e.forEach(({addedNodes:e,removedNodes:r})=>{r.forEach(e=>{if(e.nodeType===Node.TEXT_NODE)return;const r=e.getAttribute(t.attrs.watch);r&&delete m.renders[r]})})}).observe(e,{childList:!0,attributes:!0,subtree:!0}),e.innerHTML=u(a.data)}}}}}));
//# sourceMappingURL=re-bars.umd.min.js.map
