!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";const e={warn:"background: #484915; color: #ffffbe; padding: .1em; font-weight: normal;",log:"background: #324645; color:#c9faff; padding: .1em; font-weight: normal;"},t=(e,{loc:t,data:n})=>{const r=e.split("\n").slice(t.start.line-1,t.end.line),a=Array(r[0].length-r[0].trim().length).join(" ");return r[0]=r[0].substr(t.start.column),r[r.length-1]=r[r.length-1].substr(0,t.end.column),["",`component: ${n.root.$name}, template line: ${t.start.line}`,"============================================"].concat(r.map(e=>e.replace(a,""))).join("\n")},n=(t,n,a={},...o)=>{let s=r[n](a);if(!["warn","log"].includes(t))throw o.forEach(e=>console.error(e)),new Error(s);s="%c "+s+" ",o?(console.groupCollapsed(s,e[t]),o.forEach(e=>console.log(e)),console.groupEnd()):console.log(s,e[t])},r={noEl:()=>"$el must be present in the document",noHbs:()=>"ReBars need Handlebars in order to run!",noName:()=>"Each ReBars component should have a name",dataFn:({name:e})=>`${e}: must be a function`,tplStr:({name:e})=>`${e}: needs a template string`,propStomp:({name:e,key:t})=>`${e}: "data.${t}" was overrode by a prop`,propUndef:({name:e,key:t})=>`${e}: was passed undefined for prop "${t}"`,oneRoot:({name:e})=>`${e}: must have one root node, and cannot be a {{#watch}} block. \nThis error can also be caused by malformed html.`,noMethod:({name:e,methodName:t})=>`${e}: does not have a method named "${t}"`,badPath:({path:e})=>`${e} was not found in object`,reRender:({name:e,path:t})=>`${e}: re-rendering "${t}"`,patching:({name:e,path:t})=>`${e}: patching ref Array "${t}"`,pathTrigger:({path:e,action:t,name:n})=>`${n}: ${t} "${e}"`,triggered:({name:e,paths:t})=>`${e}: data change "${t}"`,paramUndef:({data:e,template:n,loc:r})=>`component:${e.root.$name} passed undefined to a helper\n      ${t(n,{data:e,loc:r})}\n    `,badWatchParam:({data:e,template:n,loc:r,path:a})=>`${e.root.$name}: could not find "${a}" to watch. If primitve wrap in quotes\n      ${t(n,{data:e,loc:r})}\n    `,noComp:({data:e,loc:n,template:r,cName:a})=>`${e.root.$name}: child component "${a}" is not registered\n      ${t(r,{data:e,loc:n})}\n    `,restrictedKey:({name:e,key:t})=>`${e}: cannot use restricted key "${t}" in your data as it's a helper`,focusFail:({ref:e,name:t})=>`${t}: ref "${e}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each`,notKeyed:({name:e,path:t})=>`${e}: patching "${t}" add a {{ref 'someUniqueKey' }} to avoid re-rendering the entire Array`};var a={messages:r,getStr:(e,t)=>r[e](t),warn:n.bind(null,"warn"),fail:n.bind(null,"throw"),log:n.bind(null,"log")};let o=1;var s={dom:{tagComponent(e,t,n){const r=this.getShadow(t),o=r.firstElementChild;(!o||!r.children||r.children.length>1||o.dataset.rbsWatch)&&a.fail("oneRoot",{name:n},r),o.dataset.rbsComp=e;const s=r.innerHTML;return r.remove(),s},restoreCursor(e,t){const n=this.findRef(e,t.ref);n&&(Array.isArray(n)?a.warn("focusFail",{ref:t.ref,name:name},n):(n.focus(),t.pos&&n.setSelectionRange(t.pos+1,t.pos+1)))},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.querySelector(`[data-rbs-ref="${t}"]`),findRefs(e){const t=this.findComponent(e);return Array.from(t.querySelectorAll("[data-rbs-ref]")).reduce((t,n)=>{const[r,a]=n.dataset.rbsRef.split(":");if(r===e){const e=t[n.dataset.rbsRef];t[a]=e?[e].concat(n):n}return t},{})},findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),wrapWatcher:(e,t,n)=>{const{tag:r,...a}={tag:"span",class:"rbs-watch",...n};return`<${r} ${Object.entries(a).map(([e,t])=>`${e}="${t}"`).join(" ")} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},isKeyedNode:e=>e.children.length&&Array.from(e.children).every(e=>e.dataset.rbsRef),normalizeHtml:e=>e.replace(new RegExp(/="rbs(.*?)"/g),""),isEqHtml(e,t){const n="string"==typeof e?this.getShadow(e):this.getShadow(e.innerHTML),r="string"==typeof t?this.getShadow(t):this.getShadow(t.innerHTML);return n.innerHTML=this.normalizeHtml(n.innerHTML),r.innerHTML=this.normalizeHtml(r.innerHTML),n.isEqualNode(r)},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},deleteOrphans(e,t){const n=this.getStorage(e,t),r=this.getStorage(e);Object.keys(r.inst).forEach(e=>{if(!this.dom.findComponent(e)){const t=r.inst[e];t.scope.$hooks.detached&&t.scope.$hooks.detached(),delete r.inst[e]}}),Object.keys(n.renders).forEach(e=>{this.dom.findWatcher(e)||delete n.renders[e]})},debounce(e,t=0,n=!1){let r=null;return function(){const a=n&&!r,o=()=>e.apply(this,arguments);clearTimeout(r),r=setTimeout(o,t),a&&o()}},makeParams:e=>e.map(e=>{if(["[event]"].includes(e))return e.replace("[","").replace("]","");if(null!==e&&"object"==typeof e)throw new Error(`component:${name} must only pass primitives as argument to a handler. \n${JSON.stringify(e,null,2)}`);return"string"==typeof e?`'${e}'`:null===e?`${e}`:e}),getStorage(e,t){return t?this.findByPath(window.ReBars,`apps.${e}.inst.${t}`):this.findByPath(window.ReBars,`apps.${e}`)},findByPath:(e,t)=>{try{return t.includes(".")?t.split(".").reduce((e,t)=>e[t],e):e[t]}catch(n){a.fail("badPath",{path:t},e)}},shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${o++}`,setKey(e,t,n){const r=t.split(".");r.reduce((o,s,d)=>(s in o||a.fail("badPath",{path:t},e),d+1===r.length&&(o[s]=n),o[s]),e)}},d={create(e,t){let n=[];const r=s.debounce(()=>{t(n),n=[]}),a=e=>{n.push(e),r(n)};const o=function e(t,n=[]){return new Proxy(t,{get:function(t,r){if("ReBarsPath"===r)return n.join(".");const a=Reflect.get(...arguments);return"function"==typeof a&&t.hasOwnProperty(r)?a.bind(o):null!==a&&"object"==typeof a&&"methods"!==r?e(a,n.concat(r)):a},set:function(e,t){const r=Reflect.set(...arguments),o=n.concat(t).join(".");return a(o),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),o=n.concat(t).join(".");return a(o),r}})}(e);return o}},c={register({app:e,instance:t,components:n,helpers:r,template:o}){Object.entries(r).forEach(([e,n])=>t.registerHelper(e,n)),t.registerHelper("isComponent",e=>Object.keys(n).includes(e)),t.registerHelper("ref",(e,{data:n})=>new t.SafeString(`data-rbs-ref="${n.root.$_componentId}:${e}"`)),t.registerHelper("component",(function(...e){const{hash:r,data:s,loc:d}=e.pop(),c=e[0];return n[c]||a.fail("noComp",{data:s,loc:d,template:o,cName:c}),new t.SafeString(n[c].instance(r).render())})),t.registerHelper("debug",(e,{data:n,loc:r})=>{void 0===e&&a.fail("paramUndef",{template:o,data:n,loc:r});return new t.SafeString(`<pre class="debug">${JSON.stringify(e,(e,t)=>"function"==typeof t?t+"":t,2)}</pre>`)}),t.registerHelper("watch",(function(...t){const{fn:n,hash:r,data:d,loc:c}=t.pop(),i=d.root.$_componentId,l=s.randomId(),p=t.map(e=>((e,t=!0)=>(void 0===e&&a.fail("paramUndef",{template:o,loc:c,data:d}),"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e))(e,!1)).join(".").split(",");return e.components.instances[i].renders[l]={path:p,render:()=>n(this)},s.dom.wrapWatcher(l,n(this),r)})),t.registerHelper("method",(function(){const[e,...n]=arguments,[r,a="click"]=e.split(":"),{data:o}=n.pop(),{$_componentId:s}=o.root;let d=[s,a,r];return n&&n.length&&(d=d.concat(n)),new t.SafeString(`data-rbs-method='${JSON.stringify(d)}'`)})),t.registerHelper("bound",(e,{hash:n={},data:r})=>{const{$_componentId:a}=r.root,o=[a,e];return new t.SafeString(`value="${s.findByPath(r.root,e)}" data-rbs-ref="${n.ref||e}" data-rbs-bound='${JSON.stringify(o)}'`)})}},i={paths({paths:e,renders:t,name:n}){Object.entries(t).filter(([t,n])=>e.some(e=>s.shouldRender(e,n.path))&&s.dom.findWatcher(t)).forEach(([e,t])=>{const r=s.dom.findWatcher(e),o=t.render();if(s.dom.isEqHtml(r.innerHTML,o))return;const d=t.path.find(e=>e.endsWith(".length"));d&&a.warn("notKeyed",{name:n,path:d},r);const c={ref:document.activeElement.dataset.rbsRef,pos:document.activeElement.selectionStart};r.style.display=""===o?"none":"",r.innerHTML=o,s.dom.restoreCursor(r,c),a.log("reRender",{name:n,path:t.path},r)})}};const l=["component","ref","debug","isComponent","method","bound","watch","isComponent"];var p={register:function e({id:t,Handlebars:n,trace:r,helpers:o,components:p},{name:m,template:h,data:f=(()=>({})),helpers:u={},hooks:b={},methods:g={},watchers:$={},components:y=[]}){m||a.fail("noName",null,arguments[1]),"function"!=typeof f&&a.fail("dataFn",{name:m}),"string"!=typeof h&&a.fail("tmplStr",{name:m});const w=arguments[0],S=n.create(),E=S.compile(h),v=y.reduce((t,n)=>{const r=e(w,n);return t[n.name]=r,t},{...p.registered});return Object.keys(f()).forEach(e=>{l.concat(Object.keys(u)).includes(e)&&a.fail("restrictedKey",{name:m,key:e})}),c.register({app:w,methods:g,instance:S,helpers:{...u,...o},components:v,template:h}),{instance(e={}){const n=s.randomId(),r=f(),o={};Object.entries(e).forEach(([e,t])=>{void 0===t&&a.warn("propUndef",{name:m,key:e})});const c=d.create({...r,$props:e,$methods:g,$name:m,$_appId:t,$_componentId:n,$el:()=>s.dom.findComponet(n),$refs:()=>s.dom.findRefs(n)},e=>{a.log("triggered",{name:m,paths:e}),i.paths({paths:e,renders:o,name:m})});b.created&&b.created.call(c);const l={id:n,scope:c,hooks:b,renders:o,handlers:{bound(e){const[t,n]=JSON.parse(e.target.dataset.rbsBound);s.setKey(c,n,e.target.value)},method(e){const[t,n,r,...a]=JSON.parse(e.target.dataset.rbsMethod);c.$methods[r](e,...a)}},detached(){b.detached&&b.detached.call(c)},attached(){b.attached&&b.attached.call(c)},render:()=>s.dom.tagComponent(n,E(c),m)};return w.components.instances[n]=l,l}}}};return{app({$el:e,root:t,Handlebars:n=window.Handlebars,helpers:r={},components:o={},trace:d=!1}){n||a.fail("noHbs"),document.body.contains(e)||a.fail("noEl");const c={id:s.randomId(),Handlebars:n,trace:d,helpers:r,$el:e,components:{registered:{},instances:{}}},i=(e,t)=>{const n="add"===e?"attached":"detached";c.components.instances[t.dataset.rbsComp][n](),"remove"===e&&delete c.components.instances[t.dataset.rbsComp]},l=(e,t)=>{const n="add"===e?"addEventListener":"removeEventListener",[r,a]=JSON.parse(t.dataset.rbsMethod);t[n](a,c.components.instances[r].handlers.method)},m=(e,t)=>{const n="add"===e?"addEventListener":"removeEventListener",[r,a]=JSON.parse(t.dataset.rbsBound);t[n]("input",c.components.instances[r].handlers.bound)};new MutationObserver(e=>{e.forEach(({addedNodes:e,removedNodes:t})=>{e.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsComp&&i("add",e),e.dataset.rbsMethod&&l("add",e),e.dataset.rbsBound&&m("add",e),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"add")),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"add")),e.querySelectorAll("[data-rbs-bound]").forEach(m.bind(null,"add")))}),t.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsMethod&&l("remove",e),e.dataset.rbsBound&&m("remove",e),e.dataset.rbsComp&&i("remove",e),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"remove")),e.querySelectorAll("[data-rbs-bound]").forEach(m.bind(null,"remove")),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"remove")))})})}).observe(e,{childList:!0,attributes:!0,subtree:!0});const h=p.register(c,t).instance();return e.innerHTML=h.render(),c}}}));
//# sourceMappingURL=re-bars.umd.min.js.map
