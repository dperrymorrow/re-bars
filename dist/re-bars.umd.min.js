!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";const e={warn:"background: #484915; color: #ffffbe; padding: .1em; font-weight: normal;",log:"background: #324645; color:#c9faff; padding: .1em; font-weight: normal;"},t=(t,n,...r)=>{let o=n;if("object"==typeof r[0]&&"template"in r[0]&&"loc"in r[0]&&(r[0]=(({template:e,loc:t})=>{const n=e.split("\n").slice(t.start.line-1,t.end.line),r=Array(n[0].length-n[0].trim().length).join(" ");return n[0]=n[0].substr(t.start.column),n[n.length-1]=n[n.length-1].substr(0,t.end.column),["",`template line: ${t.start.line}`,"============================================"].concat(n.map(e=>e.replace(r,""))).join("\n")})(r[0])),!["warn","log"].includes(t))throw r.forEach(e=>console.error(e)),new Error(o);o="%c "+o+" ",window.ReBars&&window.ReBars.trace&&(r?(console.groupCollapsed(o,e[t]),r.forEach(e=>console.log(e)),console.groupEnd()):console.log(o,e[t]))};var n={warn:t.bind(null,"warn"),fail:t.bind(null,"throw"),log:t.bind(null,"log")};let r=1;var o={dom:{tagComponent(e,t,r){const o=this.getShadow(t),a=o.firstElementChild;(!a||!o.children||o.children.length>1||a.dataset.rbsWatch)&&n.fail("oneRoot",{name:r},o),a.dataset.rbsComp=e;const s=o.innerHTML;return o.remove(),s},restoreCursor(e,t){const r=this.findRef(e,t.ref);r&&(Array.isArray(r)?n.warn(`ref="${t.ref}" is used more than once. Focus cannot be restored. If using bind, add a ref="uniqeName" to each usage`,r):(r.focus(),t.pos&&r.setSelectionRange(t.pos+1,t.pos+1)))},findComponent:e=>document.querySelector(`[data-rbs-comp="${e}"]`),findRef:(e,t)=>e.getAttribute("ref")===t?e:e.querySelector(`[ref="${t}"]`),findRefs(e){const t=this.findComponent(e),n=Array.from(t.querySelectorAll("[ref]"));return t.getAttribute("ref")&&n.push(t),n.reduce((e,t)=>{const n=t.getAttribute("ref"),r=e[n];return e[n]=r?[r].concat(t):t,e},{})},findWatcher:e=>document.querySelector(`[data-rbs-watch="${e}"]`),propStr:e=>Object.entries(e).map(([e,t])=>`${e}="${t}"`).join(" "),wrapWatcher(e,t,n){const{tag:r,...o}={tag:"span",...n};return`<${r} ${this.propStr(o)} ${t.length?"":"style='display:none;'"} data-rbs-watch="${e}">${t}</${r}>`},getShadow(e){const t=document.createElement("div");return t.innerHTML=e,t}},stringify:(e,t=2)=>JSON.stringify(e,(e,t)=>"function"==typeof t?t+"":t,t),debounce(e,t=0,n=!1){let r=null;return function(){const o=n&&!r,a=()=>e.apply(this,arguments);clearTimeout(r),r=setTimeout(a,t),o&&a()}},shouldRender:(e,t)=>(Array.isArray(t)?t:[t]).some(t=>{if(e===t||".*"===t)return!0;const n=e.split(".");return t.split(".").every((e,t)=>e===n[t]||"*"===e)}),randomId:()=>`rbs${r++}`,setKey(e,t,r){const o=t.split(".");o.reduce((a,s,d)=>(s in a||n.fail(`${t} was not found in object!`,e),d+1===o.length&&(a[s]=r),a[s]),e)}},a={create(e,t){let n=[];const r=o.debounce(()=>{t(n),n=[]}),a=e=>{n.push(e),r(n)};const s=function e(t,n=[]){return new Proxy(t,{get:function(t,r){if("ReBarsPath"===r)return n.join(".");const o=Reflect.get(...arguments);return"function"==typeof o&&t.hasOwnProperty(r)?o.bind(s):null!==o&&"object"==typeof o&&"methods"!==r?e(o,n.concat(r)):o},set:function(e,t){const r=Reflect.set(...arguments),o=n.concat(t).join(".");return a(o),r},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),o=n.concat(t).join(".");return a(o),r}})}(e);return s}},s={register({app:e,instance:t,components:r,helpers:a,template:s,methods:d,name:c}){Object.entries(a).forEach(([e,n])=>t.registerHelper(e,n)),t.registerHelper("isComponent",e=>Object.keys(r).includes(e)),t.registerHelper("component",(function(...e){const{hash:o,loc:a}=e.pop(),d=e[0];return r[d]||n.fail(`${c}: child component "${d}" is not registered`,{template:s,loc:a}),new t.SafeString(r[d].instance(o).render())})),t.registerHelper("debug",(e,{hash:r,data:a,loc:d})=>(void 0===e&&n.fail(`${c}: undefined passed to debug`,{template:s,loc:d}),new t.SafeString(`<pre class="debug" ${o.dom.propStr(r)}>${o.stringify(e)}</pre>`))),t.registerHelper("watch",(function(...t){const{fn:r,hash:a,data:d,loc:i}=t.pop(),l=d.root.$_componentId,p=o.randomId(),h=t.map(e=>((e,t=!0)=>(void 0===e&&n.fail(`${c}: undefined cannot be watched`,{template:s,loc:i}),"object"==typeof e?`${e.ReBarsPath}${t?".*":""}`:e))(e,!1)).join(".").split(",");return e.components.instances[l].renders[p]={path:h,render:()=>r(this)},o.dom.wrapWatcher(p,r(this),a)})),t.registerHelper("method",(function(){const[e,...r]=arguments,[a,i="click"]=e.split(":"),{data:l,loc:p}=r.pop();a in d||n.fail(`${c}: "${a}" is not a method in component`,{template:s,loc:p});const h={"data-rbs-method":[l.root.$_componentId,i,a]};return r&&r.length&&(h["data-rbs-method"]=h["data-rbs-method"].concat(r)),new t.SafeString(o.dom.propStr(h))})),t.registerHelper("bound",(e,{hash:r={},data:a,loc:s})=>{const{$_componentId:d}=a.root,c=[d,e];let i;try{i=e.includes(".")?e.split(".").reduce((e,t)=>e[t],a.root):a.root[e]}catch(t){n.fail("badPath",{path:e})}const l={value:i,ref:r.ref||e,"data-rbs-bound":c};return new t.SafeString(o.dom.propStr(l))})}};function d(e,t){const n=new RegExp(/data-rbs(.*?)="(.*?)"/g);return e.replace(n,"")===t.replace(n,"")}var c={canPatch:e=>e.children.length&&Array.from(e.children).every(e=>e.getAttribute("ref")),hasChanged:(e,t)=>!d(e.innerHTML,t),compare({app:e,$target:t,html:n}){const r=o.dom.getShadow(n),a=Array.from(r.children);Array.from(t.children).forEach(e=>{const t=o.dom.findRef(r,e.getAttribute("ref"));t?d(t.innerHTML,e.innerHTML)||e.replaceWith(t.cloneNode(!0)):e.remove()}),a.forEach((e,n)=>{o.dom.findRef(t,e.getAttribute("ref"))||function(e,t,n=0){n>=e.children.length?e.appendChild(t):e.insertBefore(t,e.children[n])}(t,e.cloneNode(!0),n)}),a.forEach((e,n)=>{const r=t.children[n];r.getAttribute("ref")!==e.getAttribute("ref")&&r.replaceWith(e.cloneNode(!0))})}},i={paths({app:e,paths:t,renders:r,name:a}){Object.entries(r).filter(([e,n])=>t.some(e=>o.shouldRender(e,n.path))&&o.dom.findWatcher(e)).forEach(([t,r])=>{const s=o.dom.findWatcher(t),d=r.render();if(!c.hasChanged(s,d))return;if(c.canPatch(s))return c.compare({app:e,$target:s,html:d}),void n.log(`${a}: patching ${r.path}`,s);r.path.find(e=>e.endsWith(".length"))&&n.warn(`${a}: patching "${r.path}" add a ref="someUniqueKey" to each to avoid re-rendering the entire Array of elements`,s);const i={ref:document.activeElement.getAttribute("ref"),pos:document.activeElement.selectionStart};s.style.display=""===d?"none":"",s.innerHTML=d,o.dom.restoreCursor(s,i),n.log(`${a}: re-rendering watch block for ${r.path}`,s)}),e.deleteOrphans()}};const l=["component","ref","debug","isComponent","method","bound","watch","isComponent"];var p={register:function e({id:t,Handlebars:r,trace:d,helpers:c,components:p},{name:h,template:u,data:f=(()=>({})),helpers:m={},hooks:b={},methods:g={},watchers:y={},components:$=[]}){const w=arguments[0];h||n.fail("Every ReBars component should have a name!",w),"function"!=typeof f&&n.fail(`${h}: component data must be a function`,w),"string"!=typeof u&&n.fail("`${name}: needs a template string`",w);const v=arguments[0],E=r.create(),S=E.compile(u),A=$.reduce((t,n)=>{const r=e(v,n);return t[n.name]=r,t},{...p.registered});return Object.keys(f()).forEach(e=>{l.concat(Object.keys(m)).includes(e)&&n.fail(`${h}: cannot use "${e}" in your data as it's defined as a helper`,w)}),s.register({app:v,methods:g,instance:E,name:h,helpers:{...m,...c},components:A,template:u}),{instance(e={}){const t=o.randomId(),r=f(),s={};Object.entries(e).forEach(([e,t])=>{void 0===t&&n.warn(`${h} was passed $prop "${e}" as undefined. If you really meant to, pass null instead.`)});const d=a.create({...r,$props:e,$methods:g,$name:h,$_componentId:t,$el:()=>o.dom.findComponent(t),$refs:()=>o.dom.findRefs(t)},e=>{n.log(`${h}: data changed "${e}"`,s),i.paths({app:v,paths:e,renders:s,name:h})});b.created&&b.created.call(d);const c={id:t,scope:d,hooks:b,renders:s,handlers:{bound(e){const[t,n]=e.target.dataset.rbsBound.split(",");o.setKey(d,n,e.target.value)},method(e){const[t,n,r,...o]=e.target.dataset.rbsMethod.split(",");d.$methods[r](e,...o)}},detached(){b.detached&&b.detached.call(d)},attached(){b.attached&&b.attached.call(d)},render:()=>o.dom.tagComponent(t,S(d),h)};return v.components.instances[t]=c,c}}}};return{app({$el:e,root:t,Handlebars:r=window.Handlebars,helpers:a={},components:s=[],trace:d=!1}){r||n.fail("noHbs"),document.body.contains(e)||n.fail("$el passed to ReBars app is either undefined or not present in the document.");const c={id:o.randomId(),Handlebars:r,trace:d,listening:!0,helpers:a,$el:e,deleteOrphans:o.debounce(()=>{Object.keys(c.components.instances).forEach(e=>{o.dom.findComponent(e)||delete c.components.instances[e]})}),components:{registered:{},instances:{}}};function i(e,t){const n="add"===e?"attached":"detached",r=t.dataset.rbsComp;c.components.instances[r][n]()}function l(e,t){const n="add"===e?"addEventListener":"removeEventListener",[r,o]=t.dataset.rbsMethod.split(",");t[n](o,c.components.instances[r].handlers.method)}function h(e,t){const n="add"===e?"addEventListener":"removeEventListener",[r,o]=t.dataset.rbsBound.split(",");t[n]("input",c.components.instances[r].handlers.bound)}return c.components.registered=s.reduce((e,t)=>(e[t.name]=p.register(c,t),e),{}),new MutationObserver(e=>{e.forEach(({addedNodes:e,removedNodes:t})=>{e.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsComp&&i("add",e),e.dataset.rbsMethod&&l("add",e),e.dataset.rbsBound&&h("add",e),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"add")),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"add")),e.querySelectorAll("[data-rbs-bound]").forEach(h.bind(null,"add")))}),t.forEach(e=>{e.nodeType!==Node.TEXT_NODE&&(e.dataset.rbsMethod&&l("remove",e),e.dataset.rbsBound&&h("remove",e),e.dataset.rbsComp&&i("remove",e),e.querySelectorAll("[data-rbs-method]").forEach(l.bind(null,"remove")),e.querySelectorAll("[data-rbs-bound]").forEach(h.bind(null,"remove")),e.querySelectorAll("[data-rbs-comp]").forEach(i.bind(null,"remove")))})})}).observe(e,{childList:!0,attributes:!0,subtree:!0}),e.innerHTML=p.register(c,t).instance().render(),c}}}));
//# sourceMappingURL=re-bars.umd.min.js.map
