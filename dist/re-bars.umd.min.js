!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).ReBars=t()}(this,(function(){"use strict";let e=!1;var t={logLevel:()=>e?1:0,setTrace:t=>e=t,attrs:{watch:"rbs-watch",method:"rbs-method",ref:"rbs-ref"}};const{attrs:r}=t;var n={recordState(e){const t=document.activeElement,n=t.getAttribute(r.ref);return e.contains(t)&&n?{ref:n,style:t.getAttribute("style"),scrollTop:t.scrollTop,scrollLeft:t.scrollLeft,selectionStart:t.selectionStart}:null},restoreState(e,t){if(!t)return;const r=this.findRef(e,t.ref);if(r){if(r.focus(),t.selectionStart){const e="TEXTAREA"===r.tagName?t.selectionStart:t.selectionStart+1;r.setSelectionRange(e,e)}r.scrollTop=t.scrollTop,r.scrollLeft=t.scrollLeft,t.style&&r.setAttribute("style",t.style)}},findRef:(e,t)=>e.getAttribute(r.ref)===t?e:e.querySelector(`[${r.ref}="${t}"]`),findRefs(e){const{ref:t}=r;return Array.from(e.querySelectorAll(`[${t}]`)).reduce((e,r)=>{const n=r.getAttribute(t),o=e[n];return e[n]=o?[o].concat(r):r,e},{})},findMethod:e=>document.querySelector(`[${r.method}="${e}"]`),findWatcher:e=>document.querySelector(`[${r.watch}="${e}"]`),propStr:e=>Object.entries(e).map(([e,t])=>"number"==typeof t?`${e}=${t}`:`${e}="${t}"`).join(" "),wrapWatcher(e,t,n){const{tag:o,...s}={tag:"span",...n};return`<${o} ${this.propStr(s)} ${t.length?"":"style='display:none;'"} ${r.watch}="${e}">${t}</${o}>`}};let o=1;const{fetch:s}=window;var a={dom:n,debounce(e,t=0,r=!1){let n=null;return function(){const o=r&&!n,s=()=>e.apply(this,arguments);clearTimeout(n),n=setTimeout(s,t),o&&s()}},loadTemplate:e=>s(e).then(e=>e.text()).catch(e=>{throw new Error(e)}),nextTick:()=>new Promise(e=>{setTimeout(e,0)}),buildContext(e,{$app:t,data:r,methods:n}){const o={$app:t,$nextTick:this.nextTick,$refs:this.dom.findRefs.bind(null,t),rootData:r};return o.methods=this.bind(n,e,o),o},registerHelpers({instance:e,helpers:t,scope:r}){const n=this;Object.entries(t).forEach(([t,o])=>e.registerHelper(t,(function(...e){const t=n.buildContext(this,r);return o.call(this,t,...e)})))},bind:(e,t,...r)=>Object.keys(e).reduce((n,o)=>(n[o]=e[o].bind(t,...r),n),{}),shouldRender:(e,t)=>e.some(e=>t.some(t=>e.match(t))),randomId:()=>o++},c={create(e,t,r=!1){let n=[];const o=a.debounce(()=>{t(n),n=[]}),s=e=>{n.includes(e)||n.push(e),o(n)};const c=function t(n,o=[]){return new Proxy(n,{get:function(n,i){const d=Reflect.get(...arguments);return"function"==typeof d&&n.hasOwnProperty(i)?d.bind(c,a.buildContext(n,e)):d&&"object"==typeof d&&["Array","Object"].includes(d.constructor.name)?t(d,o.concat(i)):(r&&s(o.concat(i).join(".")),d)},set:function(e,t,r){const n=Reflect.set(...arguments),a=o.concat(t).join(".");return s(a),n},deleteProperty:function(e,t){const r=Reflect.deleteProperty(...arguments),n=o.concat(t).join(".");return s(n),r}})}(e.data);return c}};const{attrs:i}=t;var d={register({instance:e,template:t,store:r,scope:n}){e.registerHelper("ref",t=>new e.SafeString(`${i.ref}="${t}"`)),e.registerHelper("on",(function(...t){const{hash:o}=t.pop(),s=a.randomId(),c=this;return r.handlers[s]=[],Object.entries(o).forEach(([i,d])=>{a.nextTick().then((function(){const l=a.dom.findMethod(s);if(!l)return;d in n.methods||e.log(3,`ReBars: "${d}" is not a method.`,o,l);const u=e=>{const r=a.buildContext(c,n);r.event=e,r.methods[d](...t)};r.handlers[s].push({$el:l,handler:u,eventType:i}),l.addEventListener(i,u)}))}),new e.SafeString(`${i.method}="${s}"`)})),e.registerHelper("concat",(function(...e){return e.pop(),e.join("")})),e.registerHelper("watch",(function(...t){const{fn:o,hash:s}=t.pop(),i=a.randomId(),d={path:t.filter(e=>"string"==typeof e),render:()=>o(this)};if(!t.length){const e=c.create({...n,data:this},e=>{d.path=e},!0);o(e)}return a.nextTick().then(()=>{const n=a.dom.findWatcher(i);n&&(r.renders[i]={...d,$el:n},t.forEach(r=>{"string"!=typeof r&&e.log(3,`ReBars: can only watch Strings, ${typeof r} - ${r} given`,t,n)}))}),a.dom.wrapWatcher(i,o(this),s)}))}},l={paths({changed:e,store:r,instance:n}){Object.entries(r.renders).filter(([t,r])=>a.shouldRender(e,r.path)&&a.dom.findWatcher(t)).forEach(([e,r])=>{const o=a.dom.findWatcher(e);if(!o)return;const s=r.render(),c=a.dom.recordState(o);o.style.display=""===s?"none":"",o.innerHTML=s,a.dom.restoreState(o,c),n.log(t.logLevel(),"ReBars: render",r.path,o)})}},u={start(e,{renders:r,handlers:n}){const o=new MutationObserver(([e])=>{e.removedNodes.forEach(e=>{if(e.nodeType===Node.ELEMENT_NODE){const o=e.getAttribute(t.attrs.watch),s=e.getAttribute(t.attrs.method);o&&delete r[o],s&&(n[s].forEach(e=>{e.$el.removeEventListener(e.eventType,e.handler)}),delete n[s])}})});return o.observe(e,{attributes:!0,childList:!0,subtree:!0}),o}};const f={load:a.loadTemplate,app({helpers:e={},template:r,data:n={},methods:o={},partials:s={},watch:i={},hooks:f={},Handlebars:h=(window?window.Handlebars:null),trace:p=!1}){const m=h.create(),b={renders:{},handlers:{}};if(!h)throw new Error("ReBars: needs Handlebars in order to run");return t.setTrace(p),{store:b,instance:m,async render(h){const p=document.querySelector(h);await Promise.all(Object.values(s)),Object.entries(s).forEach(async([e,t])=>m.registerPartial(e,t instanceof Promise?await t:t));const g=m.compile(r instanceof Promise?await r:r);if(!p)return m.log(3,`ReBars: document.querySelector("${h}") could not be found on the document`);const y={$app:p,methods:o,data:n};a.registerHelpers({instance:m,helpers:e,scope:y}),d.register({instance:m,template:r,store:b,scope:y}),y.data=c.create(y,async e=>{m.log(t.logLevel(),"ReBars: change".blue,e),l.paths({changed:e,store:b,instance:m}),await a.nextTick(),Object.entries(i).forEach(([t,r])=>{a.shouldRender(e,[t])&&r.call(y.data,a.buildContext(y.data,y))})}),u.start(p,b);const w=a.buildContext(y.data,y);f.beforeRender&&await f.beforeRender.call(y.data,w),p.innerHTML=g(y.data),f.afterRender&&await f.afterRender.call(y.data,w)}}}};return window&&(window.ReBars=window.ReBars||f),f}));
//# sourceMappingURL=re-bars.umd.min.js.map
